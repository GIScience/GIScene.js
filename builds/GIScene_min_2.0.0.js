var GIScene={VERSION:"2.0.0",LIBRARYPATH:null,WORKINGMATERIALFLAGS:{SELECT:1,WIRE:2,SHADING:4,SIDE:8,MAP:16,OPACITY:32,VERTEXCOLORS:64,DIFFUSE:128,AMBIENT:256},idCounter:0},scripts=document.getElementsByTagName("script");GIScene.LIBRARYPATH=scripts[scripts.length-1].src.replace(/\/GIScene\.js$/,"/"),GIScene.LIBRARYPATH=GIScene.LIBRARYPATH.replace(/\/GIScene_.*\.js$/,"/"),GIScene.RESOURCESPATH="",THREE.CTMLoader=function(){THREE.Loader.call(this),Object.defineProperties(this,{statusDomElement:{get:function(){return void 0===this._statusDomElement&&(this._statusDomElement=document.createElement("div")),console.warn("THREE.BinaryLoader: .statusDomElement has been removed."),this._statusDomElement}}})},THREE.CTMLoader.prototype=Object.create(THREE.Loader.prototype),THREE.CTMLoader.prototype.constructor=THREE.CTMLoader,THREE.CTMLoader.prototype.loadParts=function(e,t,i){i=i||{};var n=this,r=new XMLHttpRequest,a=i.basePath?i.basePath:this.extractUrlBase(e);r.onreadystatechange=function(){function e(e){l+=1,c.push(e),l===o.offsets.length&&t(c,s)}if(4===r.readyState&&(200===r.status||0===r.status)){for(var o=JSON.parse(r.responseText),s=[],c=[],l=0,h=0;o.materials.length>h;h++)s[h]=n.createMaterial(o.materials[h],a);var d=a+o.data,u={useWorker:i.useWorker,offsets:o.offsets};n.load(d,e,u)}},r.open("GET",e,!0),r.setRequestHeader("Content-Type","text/plain"),r.send(null)},THREE.CTMLoader.prototype.load=function(e,t,i){i=i||{};var n=this,r=void 0!==i.offsets?i.offsets:[0],a=new XMLHttpRequest,o=null,s=0;a.onreadystatechange=function(){if(4===a.readyState)if(200===a.status||0===a.status){var c=new Uint8Array(a.response),l=Date.now();if(i.useWorker){var h=new Worker(window.URL.createObjectURL(new Blob([THREE.CTMLoader.workerString],{type:"text/javascript"})));h.onmessage=function(e){for(var i=e.data,r=0;i.length>r;r++){var a=i[r],o=Date.now();n.createModel(a,t);var s=Date.now();console.log("model load time [worker]: "+(s-o)+" ms, total: "+(s-l))}},h.postMessage({data:c,offsets:r})}else for(var d=0;r.length>d;d++){var u=new CTM.Stream(c);u.offset=r[d];var f=new CTM.File(u);n.createModel(f,t)}}else console.error("Couldn't load ["+e+"] ["+a.status+"]");else 3===a.readyState?o&&(0===s&&(s=a.getResponseHeader("Content-Length")),o({total:s,loaded:a.responseText.length})):2===a.readyState&&(s=a.getResponseHeader("Content-Length"))},a.open("GET",e,!0),a.responseType="arraybuffer",a.send(null)},THREE.CTMLoader.prototype.createModel=function(e,t){var i=function(){THREE.BufferGeometry.call(this),this.materials=[];var t,i,n=e.body.indices,r=e.body.vertices,a=e.body.normals,o=e.body.uvMaps;void 0!==o&&o.length>0&&(t=o[0].uv);var s=e.body.attrMaps;void 0!==s&&s.length>0&&"Color"===s[0].name&&(i=s[0].attr),this.setIndex(new THREE.BufferAttribute(n,1)),this.addAttribute("position",new THREE.BufferAttribute(r,3)),void 0!==a&&this.addAttribute("normal",new THREE.BufferAttribute(a,3)),void 0!==t&&this.addAttribute("uv",new THREE.BufferAttribute(t,2)),void 0!==i&&this.addAttribute("color",new THREE.BufferAttribute(i,4))};i.prototype=Object.create(THREE.BufferGeometry.prototype),i.prototype.constructor=i;var n=new i;void 0===n.attributes.normal&&n.computeVertexNormals(),t(n)},THREE.CTMLoader.workerString="var LZMA = LZMA || {};\nLZMA.OutWindow = function(){\n  this._windowSize = 0;\n};\nLZMA.OutWindow.prototype.create = function(windowSize){\n  if ( (!this._buffer) || (this._windowSize !== windowSize) ){\n    this._buffer = [];\n  }\n  this._windowSize = windowSize;\n  this._pos = 0;\n  this._streamPos = 0;\n};\nLZMA.OutWindow.prototype.flush = function(){\n  var size = this._pos - this._streamPos;\n  if (size !== 0){\n    while(size --){\n      this._stream.writeByte(this._buffer[this._streamPos ++]);\n    }\n    if (this._pos >= this._windowSize){\n      this._pos = 0;\n    }\n    this._streamPos = this._pos;\n  }\n};\nLZMA.OutWindow.prototype.releaseStream = function(){\n  this.flush();\n  this._stream = null;\n};\nLZMA.OutWindow.prototype.setStream = function(stream){\n  this.releaseStream();\n  this._stream = stream;\n};\nLZMA.OutWindow.prototype.init = function(solid){\n  if (!solid){\n    this._streamPos = 0;\n    this._pos = 0;\n  }\n};\nLZMA.OutWindow.prototype.copyBlock = function(distance, len){\n  var pos = this._pos - distance - 1;\n  if (pos < 0){\n    pos += this._windowSize;\n  }\n  while(len --){\n    if (pos >= this._windowSize){\n      pos = 0;\n    }\n    this._buffer[this._pos ++] = this._buffer[pos ++];\n    if (this._pos >= this._windowSize){\n      this.flush();\n    }\n  }\n};\nLZMA.OutWindow.prototype.putByte = function(b){\n  this._buffer[this._pos ++] = b;\n  if (this._pos >= this._windowSize){\n    this.flush();\n  }\n};\nLZMA.OutWindow.prototype.getByte = function(distance){\n  var pos = this._pos - distance - 1;\n  if (pos < 0){\n    pos += this._windowSize;\n  }\n  return this._buffer[pos];\n};\nLZMA.RangeDecoder = function(){\n};\nLZMA.RangeDecoder.prototype.setStream = function(stream){\n  this._stream = stream;\n};\nLZMA.RangeDecoder.prototype.releaseStream = function(){\n  this._stream = null;\n};\nLZMA.RangeDecoder.prototype.init = function(){\n  var i = 5;\n  this._code = 0;\n  this._range = -1;\n  \n  while(i --){\n    this._code = (this._code << 8) | this._stream.readByte();\n  }\n};\nLZMA.RangeDecoder.prototype.decodeDirectBits = function(numTotalBits){\n  var result = 0, i = numTotalBits, t;\n  while(i --){\n    this._range >>>= 1;\n    t = (this._code - this._range) >>> 31;\n    this._code -= this._range & (t - 1);\n    result = (result << 1) | (1 - t);\n    if ( (this._range & 0xff000000) === 0){\n      this._code = (this._code << 8) | this._stream.readByte();\n      this._range <<= 8;\n    }\n  }\n  return result;\n};\nLZMA.RangeDecoder.prototype.decodeBit = function(probs, index){\n  var prob = probs[index],\n      newBound = (this._range >>> 11) * prob;\n  if ( (this._code ^ 0x80000000) < (newBound ^ 0x80000000) ){\n    this._range = newBound;\n    probs[index] += (2048 - prob) >>> 5;\n    if ( (this._range & 0xff000000) === 0){\n      this._code = (this._code << 8) | this._stream.readByte();\n      this._range <<= 8;\n    }\n    return 0;\n  }\n  this._range -= newBound;\n  this._code -= newBound;\n  probs[index] -= prob >>> 5;\n  if ( (this._range & 0xff000000) === 0){\n    this._code = (this._code << 8) | this._stream.readByte();\n    this._range <<= 8;\n  }\n  return 1;\n};\nLZMA.initBitModels = function(probs, len){\n  while(len --){\n    probs[len] = 1024;\n  }\n};\nLZMA.BitTreeDecoder = function(numBitLevels){\n  this._models = [];\n  this._numBitLevels = numBitLevels;\n};\nLZMA.BitTreeDecoder.prototype.init = function(){\n  LZMA.initBitModels(this._models, 1 << this._numBitLevels);\n};\nLZMA.BitTreeDecoder.prototype.decode = function(rangeDecoder){\n  var m = 1, i = this._numBitLevels;\n  while(i --){\n    m = (m << 1) | rangeDecoder.decodeBit(this._models, m);\n  }\n  return m - (1 << this._numBitLevels);\n};\nLZMA.BitTreeDecoder.prototype.reverseDecode = function(rangeDecoder){\n  var m = 1, symbol = 0, i = 0, bit;\n  for (; i < this._numBitLevels; ++ i){\n    bit = rangeDecoder.decodeBit(this._models, m);\n    m = (m << 1) | bit;\n    symbol |= bit << i;\n  }\n  return symbol;\n};\nLZMA.reverseDecode2 = function(models, startIndex, rangeDecoder, numBitLevels){\n  var m = 1, symbol = 0, i = 0, bit;\n  for (; i < numBitLevels; ++ i){\n    bit = rangeDecoder.decodeBit(models, startIndex + m);\n    m = (m << 1) | bit;\n    symbol |= bit << i;\n  }\n  return symbol;\n};\nLZMA.LenDecoder = function(){\n  this._choice = [];\n  this._lowCoder = [];\n  this._midCoder = [];\n  this._highCoder = new LZMA.BitTreeDecoder(8);\n  this._numPosStates = 0;\n};\nLZMA.LenDecoder.prototype.create = function(numPosStates){\n  for (; this._numPosStates < numPosStates; ++ this._numPosStates){\n    this._lowCoder[this._numPosStates] = new LZMA.BitTreeDecoder(3);\n    this._midCoder[this._numPosStates] = new LZMA.BitTreeDecoder(3);\n  }\n};\nLZMA.LenDecoder.prototype.init = function(){\n  var i = this._numPosStates;\n  LZMA.initBitModels(this._choice, 2);\n  while(i --){\n    this._lowCoder[i].init();\n    this._midCoder[i].init();\n  }\n  this._highCoder.init();\n};\nLZMA.LenDecoder.prototype.decode = function(rangeDecoder, posState){\n  if (rangeDecoder.decodeBit(this._choice, 0) === 0){\n    return this._lowCoder[posState].decode(rangeDecoder);\n  }\n  if (rangeDecoder.decodeBit(this._choice, 1) === 0){\n    return 8 + this._midCoder[posState].decode(rangeDecoder);\n  }\n  return 16 + this._highCoder.decode(rangeDecoder);\n};\nLZMA.Decoder2 = function(){\n  this._decoders = [];\n};\nLZMA.Decoder2.prototype.init = function(){\n  LZMA.initBitModels(this._decoders, 0x300);\n};\nLZMA.Decoder2.prototype.decodeNormal = function(rangeDecoder){\n  var symbol = 1;\n  do{\n    symbol = (symbol << 1) | rangeDecoder.decodeBit(this._decoders, symbol);\n  }while(symbol < 0x100);\n  return symbol & 0xff;\n};\nLZMA.Decoder2.prototype.decodeWithMatchByte = function(rangeDecoder, matchByte){\n  var symbol = 1, matchBit, bit;\n  do{\n    matchBit = (matchByte >> 7) & 1;\n    matchByte <<= 1;\n    bit = rangeDecoder.decodeBit(this._decoders, ( (1 + matchBit) << 8) + symbol);\n    symbol = (symbol << 1) | bit;\n    if (matchBit !== bit){\n      while(symbol < 0x100){\n        symbol = (symbol << 1) | rangeDecoder.decodeBit(this._decoders, symbol);\n      }\n      break;\n    }\n  }while(symbol < 0x100);\n  return symbol & 0xff;\n};\nLZMA.LiteralDecoder = function(){\n};\nLZMA.LiteralDecoder.prototype.create = function(numPosBits, numPrevBits){\n  var i;\n  if (this._coders\n    && (this._numPrevBits === numPrevBits)\n    && (this._numPosBits === numPosBits) ){\n    return;\n  }\n  this._numPosBits = numPosBits;\n  this._posMask = (1 << numPosBits) - 1;\n  this._numPrevBits = numPrevBits;\n  this._coders = [];\n  i = 1 << (this._numPrevBits + this._numPosBits);\n  while(i --){\n    this._coders[i] = new LZMA.Decoder2();\n  }\n};\nLZMA.LiteralDecoder.prototype.init = function(){\n  var i = 1 << (this._numPrevBits + this._numPosBits);\n  while(i --){\n    this._coders[i].init();\n  }\n};\nLZMA.LiteralDecoder.prototype.getDecoder = function(pos, prevByte){\n  return this._coders[( (pos & this._posMask) << this._numPrevBits)\n    + ( (prevByte & 0xff) >>> (8 - this._numPrevBits) )];\n};\nLZMA.Decoder = function(){\n  this._outWindow = new LZMA.OutWindow();\n  this._rangeDecoder = new LZMA.RangeDecoder();\n  this._isMatchDecoders = [];\n  this._isRepDecoders = [];\n  this._isRepG0Decoders = [];\n  this._isRepG1Decoders = [];\n  this._isRepG2Decoders = [];\n  this._isRep0LongDecoders = [];\n  this._posSlotDecoder = [];\n  this._posDecoders = [];\n  this._posAlignDecoder = new LZMA.BitTreeDecoder(4);\n  this._lenDecoder = new LZMA.LenDecoder();\n  this._repLenDecoder = new LZMA.LenDecoder();\n  this._literalDecoder = new LZMA.LiteralDecoder();\n  this._dictionarySize = -1;\n  this._dictionarySizeCheck = -1;\n  this._posSlotDecoder[0] = new LZMA.BitTreeDecoder(6);\n  this._posSlotDecoder[1] = new LZMA.BitTreeDecoder(6);\n  this._posSlotDecoder[2] = new LZMA.BitTreeDecoder(6);\n  this._posSlotDecoder[3] = new LZMA.BitTreeDecoder(6);\n};\nLZMA.Decoder.prototype.setDictionarySize = function(dictionarySize){\n  if (dictionarySize < 0){\n    return false;\n  }\n  if (this._dictionarySize !== dictionarySize){\n    this._dictionarySize = dictionarySize;\n    this._dictionarySizeCheck = Math.max(this._dictionarySize, 1);\n    this._outWindow.create( Math.max(this._dictionarySizeCheck, 4096) );\n  }\n  return true;\n};\nLZMA.Decoder.prototype.setLcLpPb = function(lc, lp, pb){\n  var numPosStates = 1 << pb;\n  if (lc > 8 || lp > 4 || pb > 4){\n    return false;\n  }\n  this._literalDecoder.create(lp, lc);\n  this._lenDecoder.create(numPosStates);\n  this._repLenDecoder.create(numPosStates);\n  this._posStateMask = numPosStates - 1;\n  return true;\n};\nLZMA.Decoder.prototype.init = function(){\n  var i = 4;\n  this._outWindow.init(false);\n  LZMA.initBitModels(this._isMatchDecoders, 192);\n  LZMA.initBitModels(this._isRep0LongDecoders, 192);\n  LZMA.initBitModels(this._isRepDecoders, 12);\n  LZMA.initBitModels(this._isRepG0Decoders, 12);\n  LZMA.initBitModels(this._isRepG1Decoders, 12);\n  LZMA.initBitModels(this._isRepG2Decoders, 12);\n  LZMA.initBitModels(this._posDecoders, 114);\n  this._literalDecoder.init();\n  while(i --){\n    this._posSlotDecoder[i].init();\n  }\n  this._lenDecoder.init();\n  this._repLenDecoder.init();\n  this._posAlignDecoder.init();\n  this._rangeDecoder.init();\n};\nLZMA.Decoder.prototype.decode = function(inStream, outStream, outSize){\n  var state = 0, rep0 = 0, rep1 = 0, rep2 = 0, rep3 = 0, nowPos64 = 0, prevByte = 0,\n      posState, decoder2, len, distance, posSlot, numDirectBits;\n  this._rangeDecoder.setStream(inStream);\n  this._outWindow.setStream(outStream);\n  this.init();\n  while(outSize < 0 || nowPos64 < outSize){\n    posState = nowPos64 & this._posStateMask;\n    if (this._rangeDecoder.decodeBit(this._isMatchDecoders, (state << 4) + posState) === 0){\n      decoder2 = this._literalDecoder.getDecoder(nowPos64 ++, prevByte);\n      if (state >= 7){\n        prevByte = decoder2.decodeWithMatchByte(this._rangeDecoder, this._outWindow.getByte(rep0) );\n      }else{\n        prevByte = decoder2.decodeNormal(this._rangeDecoder);\n      }\n      this._outWindow.putByte(prevByte);\n      state = state < 4? 0: state - (state < 10? 3: 6);\n    }else{\n      if (this._rangeDecoder.decodeBit(this._isRepDecoders, state) === 1){\n        len = 0;\n        if (this._rangeDecoder.decodeBit(this._isRepG0Decoders, state) === 0){\n          if (this._rangeDecoder.decodeBit(this._isRep0LongDecoders, (state << 4) + posState) === 0){\n            state = state < 7? 9: 11;\n            len = 1;\n          }\n        }else{\n          if (this._rangeDecoder.decodeBit(this._isRepG1Decoders, state) === 0){\n            distance = rep1;\n          }else{\n            if (this._rangeDecoder.decodeBit(this._isRepG2Decoders, state) === 0){\n              distance = rep2;\n            }else{\n              distance = rep3;\n              rep3 = rep2;\n            }\n            rep2 = rep1;\n          }\n          rep1 = rep0;\n          rep0 = distance;\n        }\n        if (len === 0){\n          len = 2 + this._repLenDecoder.decode(this._rangeDecoder, posState);\n          state = state < 7? 8: 11;\n        }\n      }else{\n        rep3 = rep2;\n        rep2 = rep1;\n        rep1 = rep0;\n        len = 2 + this._lenDecoder.decode(this._rangeDecoder, posState);\n        state = state < 7? 7: 10;\n        posSlot = this._posSlotDecoder[len <= 5? len - 2: 3].decode(this._rangeDecoder);\n        if (posSlot >= 4){\n          numDirectBits = (posSlot >> 1) - 1;\n          rep0 = (2 | (posSlot & 1) ) << numDirectBits;\n          if (posSlot < 14){\n            rep0 += LZMA.reverseDecode2(this._posDecoders,\n                rep0 - posSlot - 1, this._rangeDecoder, numDirectBits);\n          }else{\n            rep0 += this._rangeDecoder.decodeDirectBits(numDirectBits - 4) << 4;\n            rep0 += this._posAlignDecoder.reverseDecode(this._rangeDecoder);\n            if (rep0 < 0){\n              if (rep0 === -1){\n                break;\n              }\n              return false;\n            }\n          }\n        }else{\n          rep0 = posSlot;\n        }\n      }\n      if (rep0 >= nowPos64 || rep0 >= this._dictionarySizeCheck){\n        return false;\n      }\n      this._outWindow.copyBlock(rep0, len);\n      nowPos64 += len;\n      prevByte = this._outWindow.getByte(0);\n    }\n  }\n  this._outWindow.flush();\n  this._outWindow.releaseStream();\n  this._rangeDecoder.releaseStream();\n  return true;\n};\nLZMA.Decoder.prototype.setDecoderProperties = function(properties){\n  var value, lc, lp, pb, dictionarySize;\n  if (properties.size < 5){\n    return false;\n  }\n  value = properties.readByte();\n  lc = value % 9;\n  value = ~~(value / 9);\n  lp = value % 5;\n  pb = ~~(value / 5);\n  if ( !this.setLcLpPb(lc, lp, pb) ){\n    return false;\n  }\n  dictionarySize = properties.readByte();\n  dictionarySize |= properties.readByte() << 8;\n  dictionarySize |= properties.readByte() << 16;\n  dictionarySize += properties.readByte() * 16777216;\n  return this.setDictionarySize(dictionarySize);\n};\nLZMA.decompress = function(properties, inStream, outStream, outSize){\n  var decoder = new LZMA.Decoder();\n  if ( !decoder.setDecoderProperties(properties) ){\n    throw 'Incorrect stream properties';\n  }\n  if ( !decoder.decode(inStream, outStream, outSize) ){\n    throw 'Error in data stream';\n  }\n  return true;\n};\nvar CTM = CTM || {};\nCTM.CompressionMethod = {\n  RAW: 0x00574152,\n  MG1: 0x0031474d,\n  MG2: 0x0032474d\n};\nCTM.Flags = {\n  NORMALS: 0x00000001\n};\nCTM.File = function(stream){\n  this.load(stream);\n};\nCTM.File.prototype.load = function(stream){\n  this.header = new CTM.FileHeader(stream);\n  this.body = new CTM.FileBody(this.header);\n  \n  this.getReader().read(stream, this.body);\n};\nCTM.File.prototype.getReader = function(){\n  var reader;\n  switch(this.header.compressionMethod){\n    case CTM.CompressionMethod.RAW:\n      reader = new CTM.ReaderRAW();\n      break;\n    case CTM.CompressionMethod.MG1:\n      reader = new CTM.ReaderMG1();\n      break;\n    case CTM.CompressionMethod.MG2:\n      reader = new CTM.ReaderMG2();\n      break;\n  }\n  return reader;\n};\nCTM.FileHeader = function(stream){\n  stream.readInt32(); \n  this.fileFormat = stream.readInt32();\n  this.compressionMethod = stream.readInt32();\n  this.vertexCount = stream.readInt32();\n  this.triangleCount = stream.readInt32();\n  this.uvMapCount = stream.readInt32();\n  this.attrMapCount = stream.readInt32();\n  this.flags = stream.readInt32();\n  this.comment = stream.readString();\n};\nCTM.FileHeader.prototype.hasNormals = function(){\n  return this.flags & CTM.Flags.NORMALS;\n};\nCTM.FileBody = function(header){\n  var i = header.triangleCount * 3,\n      v = header.vertexCount * 3,\n      n = header.hasNormals()? header.vertexCount * 3: 0,\n      u = header.vertexCount * 2,\n      a = header.vertexCount * 4,\n      j = 0;\n  var data = new ArrayBuffer(\n    (i + v + n + (u * header.uvMapCount) + (a * header.attrMapCount) ) * 4);\n  this.indices = new Uint32Array(data, 0, i);\n  this.vertices = new Float32Array(data, i * 4, v);\n  if ( header.hasNormals() ){\n    this.normals = new Float32Array(data, (i + v) * 4, n);\n  }\n  \n  if (header.uvMapCount){\n    this.uvMaps = [];\n    for (j = 0; j < header.uvMapCount; ++ j){\n      this.uvMaps[j] = {uv: new Float32Array(data,\n        (i + v + n + (j * u) ) * 4, u) };\n    }\n  }\n  \n  if (header.attrMapCount){\n    this.attrMaps = [];\n    for (j = 0; j < header.attrMapCount; ++ j){\n      this.attrMaps[j] = {attr: new Float32Array(data,\n        (i + v + n + (u * header.uvMapCount) + (j * a) ) * 4, a),start:(i + v + n + (u * header.uvMapCount) + (j * a) ) * 4 ,end:a };\n    }\n  }\n};\nCTM.FileMG2Header = function(stream){\n  stream.readInt32(); \n  this.vertexPrecision = stream.readFloat32();\n  this.normalPrecision = stream.readFloat32();\n  this.lowerBoundx = stream.readFloat32();\n  this.lowerBoundy = stream.readFloat32();\n  this.lowerBoundz = stream.readFloat32();\n  this.higherBoundx = stream.readFloat32();\n  this.higherBoundy = stream.readFloat32();\n  this.higherBoundz = stream.readFloat32();\n  this.divx = stream.readInt32();\n  this.divy = stream.readInt32();\n  this.divz = stream.readInt32();\n  \n  this.sizex = (this.higherBoundx - this.lowerBoundx) / this.divx;\n  this.sizey = (this.higherBoundy - this.lowerBoundy) / this.divy;\n  this.sizez = (this.higherBoundz - this.lowerBoundz) / this.divz;\n};\nCTM.ReaderRAW = function(){\n};\nCTM.ReaderRAW.prototype.read = function(stream, body){\n  this.readIndices(stream, body.indices);\n  this.readVertices(stream, body.vertices);\n  \n  if (body.normals){\n    this.readNormals(stream, body.normals);\n  }\n  if (body.uvMaps){\n    this.readUVMaps(stream, body.uvMaps);\n  }\n  if (body.attrMaps){\n    this.readAttrMaps(stream, body.attrMaps);\n  }\n};\nCTM.ReaderRAW.prototype.readIndices = function(stream, indices){\n  stream.readInt32(); \n  stream.readArrayInt32(indices);\n};\nCTM.ReaderRAW.prototype.readVertices = function(stream, vertices){\n  stream.readInt32(); \n  stream.readArrayFloat32(vertices);\n};\nCTM.ReaderRAW.prototype.readNormals = function(stream, normals){\n  stream.readInt32(); \n  stream.readArrayFloat32(normals);\n};\nCTM.ReaderRAW.prototype.readUVMaps = function(stream, uvMaps){\n  var i = 0;\n  for (; i < uvMaps.length; ++ i){\n    stream.readInt32(); \n    uvMaps[i].name = stream.readString();\n    uvMaps[i].filename = stream.readString();\n    stream.readArrayFloat32(uvMaps[i].uv);\n  }\n};\nCTM.ReaderRAW.prototype.readAttrMaps = function(stream, attrMaps){\n  var i = 0;\n  for (; i < attrMaps.length; ++ i){\n    stream.readInt32(); \n    attrMaps[i].name = stream.readString();\n    stream.readArrayFloat32(attrMaps[i].attr);\n  }\n};\nCTM.ReaderMG1 = function(){\n};\nCTM.ReaderMG1.prototype.read = function(stream, body){\n  this.readIndices(stream, body.indices);\n  this.readVertices(stream, body.vertices);\n  \n  if (body.normals){\n    this.readNormals(stream, body.normals);\n  }\n  if (body.uvMaps){\n    this.readUVMaps(stream, body.uvMaps);\n  }\n  if (body.attrMaps){\n    this.readAttrMaps(stream, body.attrMaps);\n  }\n};\nCTM.ReaderMG1.prototype.readIndices = function(stream, indices){\n  stream.readInt32(); \n  stream.readInt32(); \n  \n  var interleaved = new CTM.InterleavedStream(indices, 3);\n  LZMA.decompress(stream, stream, interleaved, interleaved.data.length);\n  CTM.restoreIndices(indices, indices.length);\n};\nCTM.ReaderMG1.prototype.readVertices = function(stream, vertices){\n  stream.readInt32(); \n  stream.readInt32(); \n  \n  var interleaved = new CTM.InterleavedStream(vertices, 1);\n  LZMA.decompress(stream, stream, interleaved, interleaved.data.length);\n};\nCTM.ReaderMG1.prototype.readNormals = function(stream, normals){\n  stream.readInt32(); \n  stream.readInt32(); \n  var interleaved = new CTM.InterleavedStream(normals, 3);\n  LZMA.decompress(stream, stream, interleaved, interleaved.data.length);\n};\nCTM.ReaderMG1.prototype.readUVMaps = function(stream, uvMaps){\n  var i = 0;\n  for (; i < uvMaps.length; ++ i){\n    stream.readInt32(); \n    uvMaps[i].name = stream.readString();\n    uvMaps[i].filename = stream.readString();\n    \n    stream.readInt32(); \n    var interleaved = new CTM.InterleavedStream(uvMaps[i].uv, 2);\n    LZMA.decompress(stream, stream, interleaved, interleaved.data.length);\n  }\n};\nCTM.ReaderMG1.prototype.readAttrMaps = function(stream, attrMaps){\n  var i = 0;\n  for (; i < attrMaps.length; ++ i){\n    stream.readInt32(); \n    attrMaps[i].name = stream.readString();\n    \n    stream.readInt32(); //packed size\n    var interleaved = new CTM.InterleavedStream(attrMaps[i].attr, 4);\n    LZMA.decompress(stream, stream, interleaved, interleaved.data.length);\n  }\n};\nCTM.ReaderMG2 = function(){\n};\nCTM.ReaderMG2.prototype.read = function(stream, body){\n  this.MG2Header = new CTM.FileMG2Header(stream);\n  \n  this.readVertices(stream, body.vertices);\n  this.readIndices(stream, body.indices);\n  \n  if (body.normals){\n    this.readNormals(stream, body);\n  }\n  if (body.uvMaps){\n    this.readUVMaps(stream, body.uvMaps);\n  }\n  if (body.attrMaps){\n    this.readAttrMaps(stream, body.attrMaps);\n  }\n};\nCTM.ReaderMG2.prototype.readVertices = function(stream, vertices){\n  stream.readInt32(); \n  stream.readInt32(); //packed size\n  var interleaved = new CTM.InterleavedStream(vertices, 3);\n  LZMA.decompress(stream, stream, interleaved, interleaved.data.length);\n  \n  var gridIndices = this.readGridIndices(stream, vertices);\n  \n  CTM.restoreVertices(vertices, this.MG2Header, gridIndices, this.MG2Header.vertexPrecision);\n};\nCTM.ReaderMG2.prototype.readGridIndices = function(stream, vertices){\n  stream.readInt32(); \n  stream.readInt32(); //packed size\n  \n  var gridIndices = new Uint32Array(vertices.length / 3);\n  \n  var interleaved = new CTM.InterleavedStream(gridIndices, 1);\n  LZMA.decompress(stream, stream, interleaved, interleaved.data.length);\n  \n  CTM.restoreGridIndices(gridIndices, gridIndices.length);\n  \n  return gridIndices;\n};\nCTM.ReaderMG2.prototype.readIndices = function(stream, indices){\n  stream.readInt32(); \n  stream.readInt32(); //packed size\n  var interleaved = new CTM.InterleavedStream(indices, 3);\n  LZMA.decompress(stream, stream, interleaved, interleaved.data.length);\n  CTM.restoreIndices(indices, indices.length);\n};\nCTM.ReaderMG2.prototype.readNormals = function(stream, body){\n  stream.readInt32(); \n  stream.readInt32(); //packed size\n  var interleaved = new CTM.InterleavedStream(body.normals, 3);\n  LZMA.decompress(stream, stream, interleaved, interleaved.data.length);\n  var smooth = CTM.calcSmoothNormals(body.indices, body.vertices);\n  CTM.restoreNormals(body.normals, smooth, this.MG2Header.normalPrecision);\n};\nCTM.ReaderMG2.prototype.readUVMaps = function(stream, uvMaps){\n  var i = 0;\n  for (; i < uvMaps.length; ++ i){\n    stream.readInt32(); \n    uvMaps[i].name = stream.readString();\n    uvMaps[i].filename = stream.readString();\n    \n    var precision = stream.readFloat32();\n    \n    stream.readInt32(); //packed size\n    var interleaved = new CTM.InterleavedStream(uvMaps[i].uv, 2);\n    LZMA.decompress(stream, stream, interleaved, interleaved.data.length);\n    \n    CTM.restoreMap(uvMaps[i].uv, 2, precision);\n  }\n};\nCTM.ReaderMG2.prototype.readAttrMaps = function(stream, attrMaps){\n  var i = 0;\n  for (; i < attrMaps.length; ++ i){\n    stream.readInt32(); \n    attrMaps[i].name = stream.readString();\n    \n    var precision = stream.readFloat32();\n    \n    stream.readInt32(); //packed size\n    var interleaved = new CTM.InterleavedStream(attrMaps[i].attr, 4);\n    LZMA.decompress(stream, stream, interleaved, interleaved.data.length);\n    \n    CTM.restoreMap(attrMaps[i].attr, 4, precision);\n  }\n};\nCTM.restoreIndices = function(indices, len){\n  var i = 3;\n  if (len > 0){\n    indices[2] += indices[0];\n    indices[1] += indices[0];\n  }\n  for (; i < len; i += 3){\n    indices[i] += indices[i - 3];\n    \n    if (indices[i] === indices[i - 3]){\n      indices[i + 1] += indices[i - 2];\n    }else{\n      indices[i + 1] += indices[i];\n    }\n    indices[i + 2] += indices[i];\n  }\n};\nCTM.restoreGridIndices = function(gridIndices, len){\n  var i = 1;\n  for (; i < len; ++ i){\n    gridIndices[i] += gridIndices[i - 1];\n  }\n};\nCTM.restoreVertices = function(vertices, grid, gridIndices, precision){\n  var gridIdx, delta, x, y, z,\n      intVertices = new Uint32Array(vertices.buffer, vertices.byteOffset, vertices.length),\n      ydiv = grid.divx, zdiv = ydiv * grid.divy,\n      prevGridIdx = 0x7fffffff, prevDelta = 0,\n      i = 0, j = 0, len = gridIndices.length;\n  for (; i < len; j += 3){\n    x = gridIdx = gridIndices[i ++];\n    \n    z = ~~(x / zdiv);\n    x -= ~~(z * zdiv);\n    y = ~~(x / ydiv);\n    x -= ~~(y * ydiv);\n    delta = intVertices[j];\n    if (gridIdx === prevGridIdx){\n      delta += prevDelta;\n    }\n    vertices[j]     = grid.lowerBoundx +\n      x * grid.sizex + precision * delta;\n    vertices[j + 1] = grid.lowerBoundy +\n      y * grid.sizey + precision * intVertices[j + 1];\n    vertices[j + 2] = grid.lowerBoundz +\n      z * grid.sizez + precision * intVertices[j + 2];\n    prevGridIdx = gridIdx;\n    prevDelta = delta;\n  }\n};\nCTM.restoreNormals = function(normals, smooth, precision){\n  var ro, phi, theta, sinPhi,\n      nx, ny, nz, by, bz, len,\n      intNormals = new Uint32Array(normals.buffer, normals.byteOffset, normals.length),\n      i = 0, k = normals.length,\n      PI_DIV_2 = 3.141592653589793238462643 * 0.5;\n  for (; i < k; i += 3){\n    ro = intNormals[i] * precision;\n    phi = intNormals[i + 1];\n    if (phi === 0){\n      normals[i]     = smooth[i]     * ro;\n      normals[i + 1] = smooth[i + 1] * ro;\n      normals[i + 2] = smooth[i + 2] * ro;\n    }else{\n      \n      if (phi <= 4){\n        theta = (intNormals[i + 2] - 2) * PI_DIV_2;\n      }else{\n        theta = ( (intNormals[i + 2] * 4 / phi) - 2) * PI_DIV_2;\n      }\n      \n      phi *= precision * PI_DIV_2;\n      sinPhi = ro * Math.sin(phi);\n      nx = sinPhi * Math.cos(theta);\n      ny = sinPhi * Math.sin(theta);\n      nz = ro * Math.cos(phi);\n      bz = smooth[i + 1];\n      by = smooth[i] - smooth[i + 2];\n      len = Math.sqrt(2 * bz * bz + by * by);\n      if (len > 1e-20){\n        by /= len;\n        bz /= len;\n      }\n      normals[i]     = smooth[i]     * nz +\n        (smooth[i + 1] * bz - smooth[i + 2] * by) * ny - bz * nx;\n      normals[i + 1] = smooth[i + 1] * nz -\n        (smooth[i + 2]      + smooth[i]   ) * bz  * ny + by * nx;\n      normals[i + 2] = smooth[i + 2] * nz +\n        (smooth[i]     * by + smooth[i + 1] * bz) * ny + bz * nx;\n    }\n  }\n};\nCTM.restoreMap = function(map, count, precision){\n  var delta, value,\n      intMap = new Uint32Array(map.buffer, map.byteOffset, map.length),\n      i = 0, j, len = map.length;\n  for (; i < count; ++ i){\n    delta = 0;\n    for (j = i; j < len; j += count){\n      value = intMap[j];\n      \n      delta += value & 1? -( (value + 1) >> 1): value >> 1;\n      \n      map[j] = delta * precision;\n    }\n  }\n};\nCTM.calcSmoothNormals = function(indices, vertices){\n  var smooth = new Float32Array(vertices.length),\n      indx, indy, indz, nx, ny, nz,\n      v1x, v1y, v1z, v2x, v2y, v2z, len,\n      i, k;\n  for (i = 0, k = indices.length; i < k;){\n    indx = indices[i ++] * 3;\n    indy = indices[i ++] * 3;\n    indz = indices[i ++] * 3;\n    v1x = vertices[indy]     - vertices[indx];\n    v2x = vertices[indz]     - vertices[indx];\n    v1y = vertices[indy + 1] - vertices[indx + 1];\n    v2y = vertices[indz + 1] - vertices[indx + 1];\n    v1z = vertices[indy + 2] - vertices[indx + 2];\n    v2z = vertices[indz + 2] - vertices[indx + 2];\n    \n    nx = v1y * v2z - v1z * v2y;\n    ny = v1z * v2x - v1x * v2z;\n    nz = v1x * v2y - v1y * v2x;\n    \n    len = Math.sqrt(nx * nx + ny * ny + nz * nz);\n    if (len > 1e-10){\n      nx /= len;\n      ny /= len;\n      nz /= len;\n    }\n    \n    smooth[indx]     += nx;\n    smooth[indx + 1] += ny;\n    smooth[indx + 2] += nz;\n    smooth[indy]     += nx;\n    smooth[indy + 1] += ny;\n    smooth[indy + 2] += nz;\n    smooth[indz]     += nx;\n    smooth[indz + 1] += ny;\n    smooth[indz + 2] += nz;\n  }\n  for (i = 0, k = smooth.length; i < k; i += 3){\n    len = Math.sqrt(smooth[i] * smooth[i] + \n      smooth[i + 1] * smooth[i + 1] +\n      smooth[i + 2] * smooth[i + 2]);\n    if(len > 1e-10){\n      smooth[i]     /= len;\n      smooth[i + 1] /= len;\n      smooth[i + 2] /= len;\n    }\n  }\n  return smooth;\n};\nCTM.isLittleEndian = (function(){\n  var buffer = new ArrayBuffer(2),\n      bytes = new Uint8Array(buffer),\n      ints = new Uint16Array(buffer);\n  bytes[0] = 1;\n  return ints[0] === 1;\n}());\nCTM.InterleavedStream = function(data, count){\n  this.data = new Uint8Array(data.buffer, data.byteOffset, data.byteLength);\n  this.offset = CTM.isLittleEndian? 3: 0;\n  this.count = count * 4;\n  this.len = this.data.length;\n};\nCTM.InterleavedStream.prototype.writeByte = function(value){\n  this.data[this.offset] = value;\n  \n  this.offset += this.count;\n  if (this.offset >= this.len){\n  \n    this.offset -= this.len - 4;\n    if (this.offset >= this.count){\n    \n      this.offset -= this.count + (CTM.isLittleEndian? 1: -1);\n    }\n  }\n};\nCTM.Stream = function(data){\n  this.data = data;\n  this.offset = 0;\n};\nCTM.Stream.prototype.TWO_POW_MINUS23 = Math.pow(2, -23);\nCTM.Stream.prototype.TWO_POW_MINUS126 = Math.pow(2, -126);\nCTM.Stream.prototype.readByte = function(){\n  return this.data[this.offset ++] & 0xff;\n};\nCTM.Stream.prototype.readInt32 = function(){\n  var i = this.readByte();\n  i |= this.readByte() << 8;\n  i |= this.readByte() << 16;\n  return i | (this.readByte() << 24);\n};\nCTM.Stream.prototype.readFloat32 = function(){\n  var m = this.readByte();\n  m += this.readByte() << 8;\n  var b1 = this.readByte();\n  var b2 = this.readByte();\n  m += (b1 & 0x7f) << 16; \n  var e = ( (b2 & 0x7f) << 1) | ( (b1 & 0x80) >>> 7);\n  var s = b2 & 0x80? -1: 1;\n  if (e === 255){\n    return m !== 0? NaN: s * Infinity;\n  }\n  if (e > 0){\n    return s * (1 + (m * this.TWO_POW_MINUS23) ) * Math.pow(2, e - 127);\n  }\n  if (m !== 0){\n    return s * m * this.TWO_POW_MINUS126;\n  }\n  return s * 0;\n};\nCTM.Stream.prototype.readString = function(){\n  var len = this.readInt32();\n  this.offset += len;\n  return String.fromCharCode.apply(null,this.data.subarray(this.offset - len, this.offset));\n};\nCTM.Stream.prototype.readArrayInt32 = function(array){\n  var i = 0, len = array.length;\n  \n  while(i < len){\n    array[i ++] = this.readInt32();\n  }\n  return array;\n};\nCTM.Stream.prototype.readArrayFloat32 = function(array){\n  var i = 0, len = array.length;\n  while(i < len){\n    array[i ++] = this.readFloat32();\n  }\n  return array;\n};\n//original CTMWorker.js\nself.onmessage = function( event ) {\n	var files = [];\n	for ( var i = 0; i < event.data.offsets.length; i ++ ) {\n		var stream = new CTM.Stream( event.data.data );\n		stream.offset = event.data.offsets[ i ];\n		files[ i ] = new CTM.File( stream );\n	}\n	self.postMessage( files );\n	self.close();\n};",THREE.SceneLoader=function(e){this.onLoadStart=function(){},this.onLoadProgress=function(){},this.onLoadComplete=function(){},this.callbackSync=function(){},this.callbackProgress=function(){},this.geometryHandlers={},this.hierarchyHandlers={},this.addGeometryHandler("ascii",THREE.JSONLoader),this.manager=void 0!==e?e:THREE.DefaultLoadingManager
},THREE.SceneLoader.prototype={constructor:THREE.SceneLoader,load:function(e,t,i,n){var r=this,a=new THREE.XHRLoader(r.manager);a.load(e,function(i){r.parse(JSON.parse(i),t,e)},i,n)},addGeometryHandler:function(e,t){this.geometryHandlers[e]={loaderClass:t}},addHierarchyHandler:function(e,t){this.hierarchyHandlers[e]={loaderClass:t}},parse:function(e,t,i){function n(e,t){return"relativeToHTML"==t?e:L+e}function r(){a(M.scene,x.objects)}function a(e,t){var i,r,o,s,c;for(var h in t){var d=M.objects[h],u=t[h];if(void 0===d){if(u.type&&u.type in I.hierarchyHandlers){if(void 0===u.loading){p=M.materials[u.material],u.loading=!0;var f=I.hierarchyHandlers[u.type].loaderObject;f.options?f.load(n(u.url,x.urlBaseType),l(h,e,p,u)):f.load(n(u.url,x.urlBaseType),l(h,e,p,u))}}else if(void 0!==u.geometry)m=M.geometries[u.geometry],m&&(p=M.materials[u.material],r=u.position,o=u.rotation,s=u.scale,i=u.matrix,c=u.quaternion,u.material||(p=new THREE.MultiMaterial(M.face_materials[u.geometry])),p instanceof THREE.MultiMaterial&&0===p.materials.length&&(p=new THREE.MultiMaterial(M.face_materials[u.geometry])),u.skin?d=new THREE.SkinnedMesh(m,p):u.morph?(d=new THREE.MorphAnimMesh(m,p),void 0!==u.duration&&(d.duration=u.duration),void 0!==u.time&&(d.time=u.time),void 0!==u.mirroredLoop&&(d.mirroredLoop=u.mirroredLoop),p.morphNormals&&m.computeMorphNormals()):d=new THREE.Mesh(m,p),d.name=h,i?(d.matrixAutoUpdate=!1,d.matrix.set(i[0],i[1],i[2],i[3],i[4],i[5],i[6],i[7],i[8],i[9],i[10],i[11],i[12],i[13],i[14],i[15])):(d.position.fromArray(r),c?d.quaternion.fromArray(c):d.rotation.fromArray(o),d.scale.fromArray(s)),d.visible=u.visible,d.castShadow=u.castShadow,d.receiveShadow=u.receiveShadow,e.add(d),M.objects[h]=d);else if("AmbientLight"===u.type||"PointLight"===u.type||"DirectionalLight"===u.type||"SpotLight"===u.type||"HemisphereLight"===u.type){var g=u.color,E=u.intensity,y=u.distance,b=u.position,T=u.rotation;switch(u.type){case"AmbientLight":S=new THREE.AmbientLight(g);break;case"PointLight":S=new THREE.PointLight(g,E,y),S.position.fromArray(b);break;case"DirectionalLight":S=new THREE.DirectionalLight(g,E),S.position.fromArray(u.direction);break;case"SpotLight":S=new THREE.SpotLight(g,E,y),S.angle=u.angle,S.position.fromArray(b),S.target.set(b[0],b[1]-y,b[2]),S.target.applyEuler(new THREE.Euler(T[0],T[1],T[2],"XYZ"));break;case"HemisphereLight":S=new THREE.DirectionalLight(g,E,y),S.target.set(b[0],b[1]-y,b[2]),S.target.applyEuler(new THREE.Euler(T[0],T[1],T[2],"XYZ"))}e.add(S),S.name=h,M.lights[h]=S,M.objects[h]=S}else"PerspectiveCamera"===u.type||"OrthographicCamera"===u.type?(r=u.position,o=u.rotation,c=u.quaternion,"PerspectiveCamera"===u.type?v=new THREE.PerspectiveCamera(u.fov,u.aspect,u.near,u.far):"OrthographicCamera"===u.type&&(v=new THREE.OrthographicCamera(u.left,u.right,u.top,u.bottom,u.near,u.far)),v.name=h,v.position.fromArray(r),void 0!==c?v.quaternion.fromArray(c):void 0!==o?v.rotation.fromArray(o):u.target&&v.lookAt((new THREE.Vector3).fromArray(u.target)),e.add(v),M.cameras[h]=v,M.objects[h]=v):(r=u.position,o=u.rotation,s=u.scale,c=u.quaternion,d=new THREE.Object3D,d.name=h,d.position.fromArray(r),c?d.quaternion.fromArray(c):d.rotation.fromArray(o),d.scale.fromArray(s),d.visible=void 0!==u.visible?u.visible:!1,e.add(d),M.objects[h]=d,M.empties[h]=d);if(d){if(void 0!==u.userData)for(var R in u.userData){var w=u.userData[R];d.userData[R]=w}if(void 0!==u.groups)for(var L=0;u.groups.length>L;L++){var A=u.groups[L];void 0===M.groups[A]&&(M.groups[A]=[]),M.groups[A].push(h)}}}void 0!==d&&void 0!==u.children&&a(d,u.children)}}function o(e,t,i){M.geometries[i]=e,M.face_materials[i]=t,r()}function s(e,t,i,n,a){var o=a.position,s=a.rotation,c=a.quaternion,l=a.scale;e.position.fromArray(o),c?e.quaternion.fromArray(c):e.rotation.fromArray(s),e.scale.fromArray(l),n&&e.traverse(function(e){e.material=n});var h=void 0!==a.visible?a.visible:!0;e.traverse(function(e){e.visible=h}),i.add(e),e.name=t,M.objects[t]=e,r()}function c(e){return function(t,i){t.name=e,o(t,i,e),b-=1,I.onLoadComplete(),d()}}function l(e,t,i,n){return function(r){var a;a=r.content?r.content:r.dae?r.scene:r,s(a,e,t,i,n),b-=1,I.onLoadComplete(),d()}}function h(e){return function(t,i){t.name=e,M.geometries[e]=t,M.face_materials[e]=i}}function d(){var e={totalModels:R,totalTextures:w,loadedModels:R-b,loadedTextures:w-T};I.callbackProgress(e,M),I.onLoadProgress(),0===b&&0===T&&(u(),t(M))}function u(){for(var e=0;A.length>e;e++){var t=A[e],i=M.objects[t.targetName];i?t.object.target=i:(t.object.target=new THREE.Object3D,M.scene.add(t.object.target)),t.object.target.userData.targetInverse=t.object}}function f(e,t){if(t(e),void 0!==e.children)for(var i in e.children)f(e.children[i],t)}var m,p,v,g,E,y,S,b,T,R,w,M,I=this,L=THREE.Loader.prototype.extractUrlBase(i),A=[],x=e;for(var C in this.geometryHandlers){var D=this.geometryHandlers[C].loaderClass;this.geometryHandlers[C].loaderObject=new D}for(var C in this.hierarchyHandlers){var D=this.hierarchyHandlers[C].loaderClass;this.hierarchyHandlers[C].loaderObject=new D}if(b=0,T=0,M={scene:new THREE.Scene,geometries:{},face_materials:{},materials:{},textures:{},objects:{},cameras:{},lights:{},fogs:{},empties:{},groups:{}},x.transform){var H=x.transform.position,G=x.transform.rotation,O=x.transform.scale;H&&M.scene.position.fromArray(H),G&&M.scene.rotation.fromArray(G),O&&M.scene.scale.fromArray(O),(H||G||O)&&(M.scene.updateMatrix(),M.scene.updateMatrixWorld())}var P,k,F=function(e){T-=e,d(),I.onLoadComplete()},j=function(e){return function(){F(e)}};for(P in x.fogs)k=x.fogs[P],"linear"===k.type?g=new THREE.Fog(0,k.near,k.far):"exp2"===k.type&&(g=new THREE.FogExp2(0,k.density)),y=k.color,g.color.setRGB(y[0],y[1],y[2]),M.fogs[P]=g;var B,U;for(B in x.geometries)U=x.geometries[B],U.type in this.geometryHandlers&&(b+=1,I.onLoadStart());for(var N in x.objects)f(x.objects[N],function(e){e.type&&e.type in I.hierarchyHandlers&&(b+=1,I.onLoadStart())});R=b;for(B in x.geometries)if(U=x.geometries[B],"cube"===U.type)m=new THREE.BoxGeometry(U.width,U.height,U.depth,U.widthSegments,U.heightSegments,U.depthSegments),m.name=B,M.geometries[B]=m;else if("plane"===U.type)m=new THREE.PlaneGeometry(U.width,U.height,U.widthSegments,U.heightSegments),m.name=B,M.geometries[B]=m;else if("sphere"===U.type)m=new THREE.SphereGeometry(U.radius,U.widthSegments,U.heightSegments),m.name=B,M.geometries[B]=m;else if("cylinder"===U.type)m=new THREE.CylinderGeometry(U.topRad,U.botRad,U.height,U.radSegs,U.heightSegs),m.name=B,M.geometries[B]=m;else if("torus"===U.type)m=new THREE.TorusGeometry(U.radius,U.tube,U.segmentsR,U.segmentsT),m.name=B,M.geometries[B]=m;else if("icosahedron"===U.type)m=new THREE.IcosahedronGeometry(U.radius,U.subdivisions),m.name=B,M.geometries[B]=m;else if(U.type in this.geometryHandlers){var V=this.geometryHandlers[U.type].loaderObject;V.load(n(U.url,x.urlBaseType),c(B))}else if("embedded"===U.type){var z=x.embeds[U.id],_="";if(z.metadata=x.metadata,z){var W=this.geometryHandlers.ascii.loaderObject,Z=W.parse(z,_);h(B)(Z.geometry,Z.materials)}}var Y,X;for(Y in x.textures)if(X=x.textures[Y],Array.isArray(X.url)){T+=X.url.length;for(var Q=0;X.url.length>Q;Q++)I.onLoadStart()}else T+=1,I.onLoadStart();w=T;for(Y in x.textures){X=x.textures[Y],void 0!==X.mapping&&void 0!==THREE[X.mapping]&&(X.mapping=THREE[X.mapping]);var E;if(Array.isArray(X.url)){for(var q=X.url.length,J=[],K=0;q>K;K++)J[K]=n(X.url[K],x.urlBaseType);var V=THREE.Loader.Handlers.get(J[0]);null!==V?(E=V.load(J,j(q)),void 0!==X.mapping&&(E.mapping=X.mapping)):(E=(new THREE.CubeTextureLoader).load(J,j(q)),E.mapping=X.mapping)}else{var $=n(X.url,x.urlBaseType),et=j(1),V=THREE.Loader.Handlers.get($);if(null!==V?E=V.load($,et):(E=new THREE.Texture,V=new THREE.ImageLoader,function(e){V.load($,function(t){e.image=t,e.needsUpdate=!0,et()})}(E)),void 0!==X.mapping&&(E.mapping=X.mapping),void 0!==THREE[X.minFilter]&&(E.minFilter=THREE[X.minFilter]),void 0!==THREE[X.magFilter]&&(E.magFilter=THREE[X.magFilter]),X.anisotropy&&(E.anisotropy=X.anisotropy),X.repeat&&(E.repeat.set(X.repeat[0],X.repeat[1]),1!==X.repeat[0]&&(E.wrapS=THREE.RepeatWrapping),1!==X.repeat[1]&&(E.wrapT=THREE.RepeatWrapping)),X.offset&&E.offset.set(X.offset[0],X.offset[1]),X.wrap){var tt={repeat:THREE.RepeatWrapping,mirror:THREE.MirroredRepeatWrapping};void 0!==tt[X.wrap[0]]&&(E.wrapS=tt[X.wrap[0]]),void 0!==tt[X.wrap[1]]&&(E.wrapT=tt[X.wrap[1]])}}M.textures[Y]=E}var it,nt,rt;for(it in x.materials){nt=x.materials[it];for(rt in nt.parameters)if("envMap"===rt||"map"===rt||"lightMap"===rt||"bumpMap"===rt||"normalMap"===rt||"alphaMap"===rt)nt.parameters[rt]=M.textures[nt.parameters[rt]];else if("shading"===rt)nt.parameters[rt]="flat"===nt.parameters[rt]?THREE.FlatShading:THREE.SmoothShading;else if("side"===rt)nt.parameters[rt]="double"==nt.parameters[rt]?THREE.DoubleSide:"back"==nt.parameters[rt]?THREE.BackSide:THREE.FrontSide;else if("blending"===rt)nt.parameters[rt]=nt.parameters[rt]in THREE?THREE[nt.parameters[rt]]:THREE.NormalBlending;else if("combine"===rt)nt.parameters[rt]=nt.parameters[rt]in THREE?THREE[nt.parameters[rt]]:THREE.MultiplyOperation;else if("vertexColors"===rt)"face"==nt.parameters[rt]?nt.parameters[rt]=THREE.FaceColors:nt.parameters[rt]&&(nt.parameters[rt]=THREE.VertexColors);else if("wrapRGB"===rt){var at=nt.parameters[rt];nt.parameters[rt]=new THREE.Vector3(at[0],at[1],at[2])}else if("normalScale"===rt){var ot=nt.parameters[rt];nt.parameters[rt]=new THREE.Vector2(ot[0],ot[1])}void 0!==nt.parameters.opacity&&1>nt.parameters.opacity&&(nt.parameters.transparent=!0),p=new THREE[nt.type](nt.parameters),p.name=it,M.materials[it]=p}for(it in x.materials)if(nt=x.materials[it],nt.parameters.materials){for(var st=[],K=0;nt.parameters.materials.length>K;K++){var ct=nt.parameters.materials[K];st.push(M.materials[ct])}M.materials[it].materials=st}r(),M.cameras&&x.defaults.camera&&(M.currentCamera=M.cameras[x.defaults.camera]),M.fogs&&x.defaults.fog&&(M.scene.fog=M.fogs[x.defaults.fog]),I.callbackSync(M),d()}},THREE.XHRLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager},THREE.XHRLoader.prototype={constructor:THREE.XHRLoader,load:function(e,t,i,n){void 0!==this.path&&(e=this.path+e);var r=this,a=THREE.Cache.get(e);if(void 0!==a)return t&&setTimeout(function(){t(a)},0),a;var o=new XMLHttpRequest;return o.overrideMimeType("text/plain"),o.open("GET",e,!0),o.addEventListener("load",function(i){var a=i.target.response;THREE.Cache.add(e,a),200===this.status?(t&&t(a),r.manager.itemEnd(e)):0===this.status?(console.warn("THREE.XHRLoader: HTTP Status 0 received."),t&&t(a),r.manager.itemEnd(e)):(n&&n(i),r.manager.itemError(e))},!1),void 0!==i&&o.addEventListener("progress",function(e){i(e)},!1),o.addEventListener("error",function(t){n&&n(t),r.manager.itemError(e)},!1),void 0!==this.responseType&&(o.responseType=this.responseType),void 0!==this.withCredentials&&(o.withCredentials=this.withCredentials),o.send(null),r.manager.itemStart(e),o},setPath:function(e){this.path=e},setResponseType:function(e){this.responseType=e},setWithCredentials:function(e){this.withCredentials=e}},THREE.BinaryLoader=function(e){THREE.Loader.call(this,e)},THREE.BinaryLoader.prototype=Object.create(THREE.Loader.prototype),THREE.BinaryLoader.prototype.load=function(e,t,i,n){i=i||this.extractUrlBase(e),n=n||this.extractUrlBase(e);var r=this.showProgress?THREE.Loader.prototype.updateProgress:void 0;this.onLoadStart(),this.loadAjaxJSON(this,e,t,i,n,r)},THREE.BinaryLoader.prototype.loadAjaxJSON=function(e,t,i,n,r,a){var o=new XMLHttpRequest;n=n&&"string"==typeof n?n:this.extractUrlBase(t),r=r&&"string"==typeof r?r:this.extractUrlBase(t),o.onreadystatechange=function(){if(4==o.readyState)if(200==o.status||0==o.status){var s=JSON.parse(o.responseText);e.loadAjaxBuffers(s,i,r,n,a)}else console.error("THREE.BinaryLoader: Couldn't load ["+t+"] ["+o.status+"]")},o.open("GET",t,!0),o.send(null)},THREE.BinaryLoader.prototype.loadAjaxBuffers=function(e,t,i,n,r){var a=new XMLHttpRequest,o=i+"/"+e.buffers;a.addEventListener("load",function(){var i=a.response;if(void 0===i&&(i=new Uint8Array(a.responseBody).buffer),0==i.byteLength)for(var i=new ArrayBuffer(a.responseText.length),r=new Uint8Array(i),o=0,s=a.responseText.length;s>o;o++)r[o]=255&a.responseText.charCodeAt(o);THREE.BinaryLoader.prototype.createBinModel(i,t,n,e.materials)},!1),void 0!==r&&a.addEventListener("progress",function(e){e.lengthComputable&&r(e)},!1),a.addEventListener("error",function(){console.error("THREE.BinaryLoader: Couldn't load ["+o+"] ["+a.status+"]")},!1),a.open("GET",o,!0),a.responseType="arraybuffer",a.overrideMimeType&&a.overrideMimeType("text/plain; charset=x-user-defined"),a.send(null)},THREE.BinaryLoader.prototype.createBinModel=function(e,t,i,n){function r(e,t,i,n){e.vertices.push(new THREE.Vector3(t,i,n))}function a(e,t,i,n,r){e.faces.push(new THREE.Face3(t,i,n,null,null,r))}function o(e,t,i,n,r,a){e.faces.push(new THREE.Face3(t,i,r,null,null,a)),e.faces.push(new THREE.Face3(i,n,r,null,null,a))}function s(e,t,i,n,r,a,o,s,c){var l=t[3*o],h=t[3*o+1],d=t[3*o+2],u=t[3*s],f=t[3*s+1],m=t[3*s+2],p=t[3*c],v=t[3*c+1],g=t[3*c+2];e.faces.push(new THREE.Face3(i,n,r,[new THREE.Vector3(l,h,d),new THREE.Vector3(u,f,m),new THREE.Vector3(p,v,g)],null,a))}function c(e,t,i,n,r,a,o,s,c,l,h){var d=t[3*s],u=t[3*s+1],f=t[3*s+2],m=t[3*c],p=t[3*c+1],v=t[3*c+2],g=t[3*l],E=t[3*l+1],y=t[3*l+2],S=t[3*h],b=t[3*h+1],T=t[3*h+2];e.faces.push(new THREE.Face3(i,n,a,[new THREE.Vector3(d,u,f),new THREE.Vector3(m,p,v),new THREE.Vector3(S,b,T)],null,o)),e.faces.push(new THREE.Face3(n,r,a,[new THREE.Vector3(m,p,v),new THREE.Vector3(g,E,y),new THREE.Vector3(S,b,T)],null,o))}function l(e,t,i,n,r,a,o){e.push([new THREE.Vector2(t,i),new THREE.Vector2(n,r),new THREE.Vector2(a,o)])}function h(e,t,i,n,r,a,o,s,c){e.push([new THREE.Vector2(t,i),new THREE.Vector2(n,r),new THREE.Vector2(s,c)]),e.push([new THREE.Vector2(n,r),new THREE.Vector2(a,o),new THREE.Vector2(s,c)])}var d=function(){function t(e){return e%4?4-e%4:0}function i(e,t){var i={signature:n(e,t,12),header_bytes:d(e,t+12),vertex_coordinate_bytes:d(e,t+13),normal_coordinate_bytes:d(e,t+14),uv_coordinate_bytes:d(e,t+15),vertex_index_bytes:d(e,t+16),normal_index_bytes:d(e,t+17),uv_index_bytes:d(e,t+18),material_index_bytes:d(e,t+19),nvertices:u(e,t+20),nnormals:u(e,t+20+4),nuvs:u(e,t+20+8),ntri_flat:u(e,t+20+12),ntri_smooth:u(e,t+20+16),ntri_flat_uv:u(e,t+20+20),ntri_smooth_uv:u(e,t+20+24),nquad_flat:u(e,t+20+28),nquad_smooth:u(e,t+20+32),nquad_flat_uv:u(e,t+20+36),nquad_smooth_uv:u(e,t+20+40)};return i}function n(e,t,i){for(var n=new Uint8Array(e,t,i),r="",a=0;i>a;a++)r+=String.fromCharCode(n[t+a]);return r}function d(e,t){var i=new Uint8Array(e,t,1);return i[0]}function u(e,t){var i=new Uint32Array(e,t,1);return i[0]}function f(t){var i,n,a,o,s=C.nvertices,c=new Float32Array(e,t,3*s);for(i=0;s>i;i++)n=c[3*i],a=c[3*i+1],o=c[3*i+2],r(Q,n,a,o);return 3*s*Float32Array.BYTES_PER_ELEMENT}function m(t){var i=C.nnormals;if(i){var n,r,a,o,s=new Int8Array(e,t,3*i);for(n=0;i>n;n++)r=s[3*n],a=s[3*n+1],o=s[3*n+2],J.push(r/127,a/127,o/127)}return 3*i*Int8Array.BYTES_PER_ELEMENT}function p(t){var i=C.nuvs;if(i){var n,r,a,o=new Float32Array(e,t,2*i);for(n=0;i>n;n++)r=o[2*n],a=o[2*n+1],K.push(r,a)}return 2*i*Float32Array.BYTES_PER_ELEMENT}function v(t,i){var n,r,a,o,s,c,h,d,u,f,m=new Uint32Array(e,i,3*t);for(n=0;t>n;n++)r=m[3*n],a=m[3*n+1],o=m[3*n+2],s=K[2*r],d=K[2*r+1],c=K[2*a],u=K[2*a+1],h=K[2*o],f=K[2*o+1],l(Q.faceVertexUvs[0],s,d,c,u,h,f)}function g(t,i){var n,r,a,o,s,c,l,d,u,f,m,p,v,g=new Uint32Array(e,i,4*t);for(n=0;t>n;n++)r=g[4*n],a=g[4*n+1],o=g[4*n+2],s=g[4*n+3],c=K[2*r],f=K[2*r+1],l=K[2*a],m=K[2*a+1],d=K[2*o],p=K[2*o+1],u=K[2*s],v=K[2*s+1],h(Q.faceVertexUvs[0],c,f,l,m,d,p,u,v)}function E(t,i,n){var r,o,s,c,l,h=new Uint32Array(e,i,3*t),d=new Uint16Array(e,n,t);for(r=0;t>r;r++)o=h[3*r],s=h[3*r+1],c=h[3*r+2],l=d[r],a(Q,o,s,c,l)}function y(t,i,n){var r,a,s,c,l,h,d=new Uint32Array(e,i,4*t),u=new Uint16Array(e,n,t);for(r=0;t>r;r++)a=d[4*r],s=d[4*r+1],c=d[4*r+2],l=d[4*r+3],h=u[r],o(Q,a,s,c,l,h)}function S(t,i,n,r){var a,o,c,l,h,d,u,f,m=new Uint32Array(e,i,3*t),p=new Uint32Array(e,n,3*t),v=new Uint16Array(e,r,t);for(a=0;t>a;a++)o=m[3*a],c=m[3*a+1],l=m[3*a+2],d=p[3*a],u=p[3*a+1],f=p[3*a+2],h=v[a],s(Q,J,o,c,l,h,d,u,f)}function b(t,i,n,r){var a,o,s,l,h,d,u,f,m,p,v=new Uint32Array(e,i,4*t),g=new Uint32Array(e,n,4*t),E=new Uint16Array(e,r,t);for(a=0;t>a;a++)o=v[4*a],s=v[4*a+1],l=v[4*a+2],h=v[4*a+3],u=g[4*a],f=g[4*a+1],m=g[4*a+2],p=g[4*a+3],d=E[a],c(Q,J,o,s,l,h,d,u,f,m,p)}function T(e){var t=C.ntri_flat;if(t){var i=e+3*t*Uint32Array.BYTES_PER_ELEMENT;E(t,e,i)}}function R(e){var t=C.ntri_flat_uv;if(t){var i=e+3*t*Uint32Array.BYTES_PER_ELEMENT,n=i+3*t*Uint32Array.BYTES_PER_ELEMENT;E(t,e,n),v(t,i)}}function w(e){var t=C.ntri_smooth;if(t){var i=e+3*t*Uint32Array.BYTES_PER_ELEMENT,n=i+3*t*Uint32Array.BYTES_PER_ELEMENT;S(t,e,i,n)}}function M(e){var t=C.ntri_smooth_uv;if(t){var i=e+3*t*Uint32Array.BYTES_PER_ELEMENT,n=i+3*t*Uint32Array.BYTES_PER_ELEMENT,r=n+3*t*Uint32Array.BYTES_PER_ELEMENT;S(t,e,i,r),v(t,n)}}function I(e){var t=C.nquad_flat;if(t){var i=e+4*t*Uint32Array.BYTES_PER_ELEMENT;y(t,e,i)}}function L(e){var t=C.nquad_flat_uv;if(t){var i=e+4*t*Uint32Array.BYTES_PER_ELEMENT,n=i+4*t*Uint32Array.BYTES_PER_ELEMENT;y(t,e,n),g(t,i)}}function A(e){var t=C.nquad_smooth;if(t){var i=e+4*t*Uint32Array.BYTES_PER_ELEMENT,n=i+4*t*Uint32Array.BYTES_PER_ELEMENT;b(t,e,i,n)}}function x(e){var t=C.nquad_smooth_uv;if(t){var i=e+4*t*Uint32Array.BYTES_PER_ELEMENT,n=i+4*t*Uint32Array.BYTES_PER_ELEMENT,r=n+4*t*Uint32Array.BYTES_PER_ELEMENT;b(t,e,i,r),g(t,n)}}var C,D,H,G,O,P,k,F,j,B,U,N,V,z,_,W,Z,Y,X,Q=this,q=0,J=[],K=[];THREE.Geometry.call(this),C=i(e,q),q+=C.header_bytes,B=3*C.vertex_index_bytes+C.material_index_bytes,U=4*C.vertex_index_bytes+C.material_index_bytes,N=C.ntri_flat*B,V=C.ntri_smooth*(B+3*C.normal_index_bytes),z=C.ntri_flat_uv*(B+3*C.uv_index_bytes),_=C.ntri_smooth_uv*(B+3*C.normal_index_bytes+3*C.uv_index_bytes),W=C.nquad_flat*U,Z=C.nquad_smooth*(U+4*C.normal_index_bytes),Y=C.nquad_flat_uv*(U+4*C.uv_index_bytes),X=C.nquad_smooth_uv*(U+4*C.normal_index_bytes+4*C.uv_index_bytes),q+=f(q),q+=m(q),q+=t(3*C.nnormals),q+=p(q),D=q,H=D+N+t(2*C.ntri_flat),G=H+V+t(2*C.ntri_smooth),O=G+z+t(2*C.ntri_flat_uv),P=O+_+t(2*C.ntri_smooth_uv),k=P+W+t(2*C.nquad_flat),F=k+Z+t(2*C.nquad_smooth),j=F+Y+t(2*C.nquad_flat_uv),R(G),M(O),L(F),x(j),T(D),w(H),I(P),A(k),this.computeCentroids(),this.computeFaceNormals()};d.prototype=Object.create(THREE.Geometry.prototype);var u=new d(i),f=this.initMaterials(n,i);this.needsTangents(f)&&u.computeTangents(),t(u,f)},THREE.CombinedCamera=function(e,t,i,n,r,a,o){THREE.Camera.call(this),this.fov=i,this.left=-e/2,this.right=e/2,this.top=t/2,this.bottom=-t/2,this.inPerspectiveMode=!0,this.inOrthographicMode=!1,this.cameraO=new THREE.OrthographicCamera(e/-2,e/2,t/2,t/-2,a,o),this.cameraP=new THREE.PerspectiveCamera(i,e/t,n,r),this.activeCam=this.cameraP,this.add(this.cameraO),this.add(this.cameraP),this.zoom=1,this.toPerspective(),this.changedProjectionEvent={type:"changedProjection"}},THREE.CombinedCamera.prototype=Object.create(THREE.Camera.prototype),THREE.CombinedCamera.prototype.toPerspective=function(){this.near=this.cameraP.near,this.far=this.cameraP.far,this.cameraP.fov=this.fov/this.zoom,this.cameraP.updateProjectionMatrix(),this.projectionMatrix=this.cameraP.projectionMatrix,this.inOrthographicMode&&(this.inPerspectiveMode=!0,this.inOrthographicMode=!1,this.activeCam=this.cameraP,this.dispatchEvent(this.changedProjectionEvent))},THREE.CombinedCamera.prototype.toOrthographic=function(){var e=this.fov,t=this.cameraP.aspect;this.cameraP.near,this.cameraP.far;var i=this.getDistanceToTarget(),n=Math.tan(THREE.Math.degToRad(e)/2)*i,r=2*n,a=r*t,o=a/2;n/=this.zoom,o/=this.zoom,this.cameraO.left=-o,this.cameraO.right=o,this.cameraO.top=n,this.cameraO.bottom=-n,this.cameraO.updateProjectionMatrix(),this.near=this.cameraO.near,this.far=this.cameraO.far,this.projectionMatrix=this.cameraO.projectionMatrix,this.inPerspectiveMode&&(this.inPerspectiveMode=!1,this.inOrthographicMode=!0,this.activeCam=this.cameraO,this.dispatchEvent(this.changedProjectionEvent))},THREE.CombinedCamera.prototype.setSize=function(e,t){this.cameraP.aspect=e/t,this.left=-e/2,this.right=e/2,this.top=t/2,this.bottom=-t/2},THREE.CombinedCamera.prototype.setFov=function(e){this.fov=e,this.inPerspectiveMode?this.toPerspective():this.toOrthographic()},THREE.CombinedCamera.prototype.updateProjectionMatrix=function(){this.inPerspectiveMode?this.toPerspective():(this.toPerspective(),this.toOrthographic())},THREE.CombinedCamera.prototype.setLens=function(e,t){void 0===t&&(t=35);var i=.5*t/(e*Math.max(this.cameraP.aspect,1)),n=2*THREE.Math.RAD2DEG*Math.atan(i);return this.setFov(n),n},THREE.CombinedCamera.prototype.setZoom=function(e){this.zoom=e,this.inPerspectiveMode?this.toPerspective():this.toOrthographic()},THREE.CombinedCamera.prototype.toFrontView=function(){this.rotation.x=0,this.rotation.y=0,this.rotation.z=0,this.rotationAutoUpdate=!1},THREE.CombinedCamera.prototype.toBackView=function(){this.rotation.x=0,this.rotation.y=Math.PI,this.rotation.z=0,this.rotationAutoUpdate=!1},THREE.CombinedCamera.prototype.toLeftView=function(){this.rotation.x=0,this.rotation.y=-Math.PI/2,this.rotation.z=0,this.rotationAutoUpdate=!1},THREE.CombinedCamera.prototype.toRightView=function(){this.rotation.x=0,this.rotation.y=Math.PI/2,this.rotation.z=0,this.rotationAutoUpdate=!1},THREE.CombinedCamera.prototype.toTopView=function(){this.rotation.x=-Math.PI/2,this.rotation.y=0,this.rotation.z=0,this.rotationAutoUpdate=!1},THREE.CombinedCamera.prototype.toBottomView=function(){this.rotation.x=Math.PI/2,this.rotation.y=0,this.rotation.z=0,this.rotationAutoUpdate=!1},THREE.CombinedCamera.prototype.getDistanceToTarget=function(){var e=this.position.clone().sub(this.localToWorld(this.target.position.clone())).length();return e},THREE.CopyShader={uniforms:{tDiffuse:{type:"t",value:null},opacity:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","gl_FragColor = opacity * texel;","}"].join("\n")},THREE.DotScreenShader={uniforms:{tDiffuse:{type:"t",value:null},tSize:{type:"v2",value:new THREE.Vector2(256,256)},center:{type:"v2",value:new THREE.Vector2(.5,.5)},angle:{type:"f",value:1.57},scale:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform vec2 center;","uniform float angle;","uniform float scale;","uniform vec2 tSize;","uniform sampler2D tDiffuse;","varying vec2 vUv;","float pattern() {","float s = sin( angle ), c = cos( angle );","vec2 tex = vUv * tSize - center;","vec2 point = vec2( c * tex.x - s * tex.y, s * tex.x + c * tex.y ) * scale;","return ( sin( point.x ) * sin( point.y ) ) * 4.0;","}","void main() {","vec4 color = texture2D( tDiffuse, vUv );","float average = ( color.r + color.g + color.b ) / 3.0;","gl_FragColor = vec4( vec3( average * 10.0 - 5.0 + pattern() ), color.a );","}"].join("\n")},THREE.RGBShiftShader={uniforms:{tDiffuse:{type:"t",value:null},amount:{type:"f",value:.005},angle:{type:"f",value:0}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float amount;","uniform float angle;","varying vec2 vUv;","void main() {","vec2 offset = amount * vec2( cos(angle), sin(angle));","vec4 cr = texture2D(tDiffuse, vUv + offset);","vec4 cga = texture2D(tDiffuse, vUv);","vec4 cb = texture2D(tDiffuse, vUv - offset);","gl_FragColor = vec4(cr.r, cga.g, cb.b, cga.a);","}"].join("\n")},THREE.EdgeShader={uniforms:{tDiffuse:{type:"t",value:null},aspect:{type:"v2",value:new THREE.Vector2(512,512)},intensity:{type:"f",value:1},invert:{type:"f",value:1},threshold:{type:"f",value:0}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","varying vec2 vUv;","uniform vec2 aspect;","uniform float intensity;","uniform float invert;","uniform float threshold;","vec2 texel = vec2(1.0 / aspect.x, 1.0 / aspect.y);","mat3 G[9];","const mat3 g0 = mat3( 0.3535533845424652, 0, -0.3535533845424652, 0.5, 0, -0.5, 0.3535533845424652, 0, -0.3535533845424652 );","const mat3 g1 = mat3( 0.3535533845424652, 0.5, 0.3535533845424652, 0, 0, 0, -0.3535533845424652, -0.5, -0.3535533845424652 );","const mat3 g2 = mat3( 0, 0.3535533845424652, -0.5, -0.3535533845424652, 0, 0.3535533845424652, 0.5, -0.3535533845424652, 0 );","const mat3 g3 = mat3( 0.5, -0.3535533845424652, 0, -0.3535533845424652, 0, 0.3535533845424652, 0, 0.3535533845424652, -0.5 );","const mat3 g4 = mat3( 0, -0.5, 0, 0.5, 0, 0.5, 0, -0.5, 0 );","const mat3 g5 = mat3( -0.5, 0, 0.5, 0, 0, 0, 0.5, 0, -0.5 );","const mat3 g6 = mat3( 0.1666666716337204, -0.3333333432674408, 0.1666666716337204, -0.3333333432674408, 0.6666666865348816, -0.3333333432674408, 0.1666666716337204, -0.3333333432674408, 0.1666666716337204 );","const mat3 g7 = mat3( -0.3333333432674408, 0.1666666716337204, -0.3333333432674408, 0.1666666716337204, 0.6666666865348816, 0.1666666716337204, -0.3333333432674408, 0.1666666716337204, -0.3333333432674408 );","const mat3 g8 = mat3( 0.3333333432674408, 0.3333333432674408, 0.3333333432674408, 0.3333333432674408, 0.3333333432674408, 0.3333333432674408, 0.3333333432674408, 0.3333333432674408, 0.3333333432674408 );","void main(void)","{","G[0] = g0,","G[1] = g1,","G[2] = g2,","G[3] = g3,","G[4] = g4,","G[5] = g5,","G[6] = g6,","G[7] = g7,","G[8] = g8;","mat3 I;","float cnv[9];","vec3 sample;","for (float i=0.0; i<3.0; i++) {","for (float j=0.0; j<3.0; j++) {","sample = texture2D(tDiffuse, vUv + texel * vec2(i-1.0,j-1.0) ).rgb;","I[int(i)][int(j)] = length(sample);","}","}","for (int i=0; i<9; i++) {","float dp3 = dot(G[i][0], I[0]) + dot(G[i][1], I[1]) + dot(G[i][2], I[2]);","cnv[i] = dp3 * dp3;","}","float M = (cnv[0] + cnv[1]) + (cnv[2] + cnv[3]);","float S = (cnv[4] + cnv[5]) + (cnv[6] + cnv[7]) + (cnv[8] + M);","float rgb = smoothstep(threshold,1.0,sqrt(M/S) * intensity);","if(invert > 0.5){","gl_FragColor = vec4(vec3(1) - vec3(rgb), 1.0);","} else {","gl_FragColor = vec4(vec3(rgb), 1.0);","}","}"].join("\n")},THREE.EdgeShader2={uniforms:{tDiffuse:{type:"t",value:null},aspect:{type:"v2",value:new THREE.Vector2(512,512)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","varying vec2 vUv;","uniform vec2 aspect;","vec2 texel = vec2(1.0 / aspect.x, 1.0 / aspect.y);","mat3 G[2];","const mat3 g0 = mat3( 1.0, 2.0, 1.0, 0.0, 0.0, 0.0, -1.0, -2.0, -1.0 );","const mat3 g1 = mat3( 1.0, 0.0, -1.0, 2.0, 0.0, -2.0, 1.0, 0.0, -1.0 );","void main(void)","{","mat3 I;","float cnv[2];","vec3 sample;","G[0] = g0;","G[1] = g1;","for (float i=0.0; i<3.0; i++)","for (float j=0.0; j<3.0; j++) {","sample = texture2D( tDiffuse, vUv + texel * vec2(i-1.0,j-1.0) ).rgb;","I[int(i)][int(j)] = length(sample);","}","for (int i=0; i<2; i++) {","float dp3 = dot(G[i][0], I[0]) + dot(G[i][1], I[1]) + dot(G[i][2], I[2]);","cnv[i] = dp3 * dp3; ","}","gl_FragColor = vec4(0.5 * sqrt(cnv[0]*cnv[0]+cnv[1]*cnv[1]));","} "].join("\n")},THREE.SSAOShader={uniforms:{tDiffuse:{type:"t",value:null},tDepth:{type:"t",value:null},size:{type:"v2",value:new THREE.Vector2(512,512)},cameraNear:{type:"f",value:1},cameraFar:{type:"f",value:100},fogNear:{type:"f",value:5},fogFar:{type:"f",value:100},fogEnabled:{type:"i",value:0},onlyAO:{type:"i",value:0},aoClamp:{type:"f",value:.3},lumInfluence:{type:"f",value:.9}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float cameraNear;","uniform float cameraFar;","uniform float fogNear;","uniform float fogFar;","uniform bool fogEnabled;","uniform bool onlyAO;","uniform vec2 size;","uniform float aoClamp;","uniform float lumInfluence;","uniform sampler2D tDiffuse;","uniform sampler2D tDepth;","varying vec2 vUv;","#define DL 2.399963229728653","#define EULER 2.718281828459045","float width = size.x;","float height = size.y;","float cameraFarPlusNear = cameraFar + cameraNear;","float cameraFarMinusNear = cameraFar - cameraNear;","float cameraCoef = 2.0 * cameraNear;","const int samples = 8;","const float radius = 5.0;","const bool useNoise = false;","const float noiseAmount = 0.0003;","const float diffArea = 0.4;","const float gDisplace = 0.4;","const vec3 onlyAOColor = vec3( 1.0, 0.7, 0.5 );","float unpackDepth( const in vec4 rgba_depth ) {","const vec4 bit_shift = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );","float depth = dot( rgba_depth, bit_shift );","return depth;","}","vec2 rand( const vec2 coord ) {","vec2 noise;","if ( useNoise ) {","float nx = dot ( coord, vec2( 12.9898, 78.233 ) );","float ny = dot ( coord, vec2( 12.9898, 78.233 ) * 2.0 );","noise = clamp( fract ( 43758.5453 * sin( vec2( nx, ny ) ) ), 0.0, 1.0 );","} else {","float ff = fract( 1.0 - coord.s * ( width / 2.0 ) );","float gg = fract( coord.t * ( height / 2.0 ) );","noise = vec2( 0.25, 0.75 ) * vec2( ff ) + vec2( 0.75, 0.25 ) * gg;","}","return ( noise * 2.0  - 1.0 ) * noiseAmount;","}","float doFog() {","float zdepth = unpackDepth( texture2D( tDepth, vUv ) );","float depth = -cameraFar * cameraNear / ( zdepth * cameraFarMinusNear - cameraFar );","return smoothstep( fogNear, fogFar, depth );","}","float readDepth( const in vec2 coord ) {","return cameraCoef / ( cameraFarPlusNear - unpackDepth( texture2D( tDepth, coord ) ) * cameraFarMinusNear );","}","float compareDepths( const in float depth1, const in float depth2, inout int far ) {","float garea = 2.0;","float diff = ( depth1 - depth2 ) * 100.0;","if ( diff < gDisplace ) {","garea = diffArea;","} else {","far = 1;","}","float dd = diff - gDisplace;","float gauss = pow( EULER, -2.0 * dd * dd / ( garea * garea ) );","return gauss;","}","float calcAO( float depth, float dw, float dh ) {","float dd = radius - depth * radius;","vec2 vv = vec2( dw, dh );","vec2 coord1 = vUv + dd * vv;","vec2 coord2 = vUv - dd * vv;","float temp1 = 0.0;","float temp2 = 0.0;","int far = 0;","temp1 = compareDepths( depth, readDepth( coord1 ), far );","if ( far > 0 ) {","temp2 = compareDepths( readDepth( coord2 ), depth, far );","temp1 += ( 1.0 - temp1 ) * temp2;","}","return temp1;","}","void main() {","vec2 noise = rand( vUv );","float depth = readDepth( vUv );","float tt = clamp( depth, aoClamp, 1.0 );","float w = ( 1.0 / width )  / tt + ( noise.x * ( 1.0 - noise.x ) );","float h = ( 1.0 / height ) / tt + ( noise.y * ( 1.0 - noise.y ) );","float pw;","float ph;","float ao;","float dz = 1.0 / float( samples );","float z = 1.0 - dz / 2.0;","float l = 0.0;","for ( int i = 0; i <= samples; i ++ ) {","float r = sqrt( 1.0 - z );","pw = cos( l ) * r;","ph = sin( l ) * r;","ao += calcAO( depth, pw * w, ph * h );","z = z - dz;","l = l + DL;","}","ao /= float( samples );","ao = 1.0 - ao;","if ( fogEnabled ) {","ao = mix( ao, 1.0, doFog() );","}","vec3 color = texture2D( tDiffuse, vUv ).rgb;","vec3 lumcoeff = vec3( 0.299, 0.587, 0.114 );","float lum = dot( color.rgb, lumcoeff );","vec3 luminance = vec3( lum );","vec3 final = vec3( color * mix( vec3( ao ), vec3( 1.0 ), luminance * lumInfluence ) );","if ( onlyAO ) {","final = onlyAOColor * vec3( mix( vec3( ao ), vec3( 1.0 ), luminance * lumInfluence ) );","}","gl_FragColor = vec4( final, 1.0 );","}"].join("\n")},THREE.FXAAShader={uniforms:{tDiffuse:{type:"t",value:null},resolution:{type:"v2",value:new THREE.Vector2(1/1024,1/512)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform vec2 resolution;","varying vec2 vUv;","#define FXAA_REDUCE_MIN   (1.0/128.0)","#define FXAA_REDUCE_MUL   (1.0/8.0)","#define FXAA_SPAN_MAX     8.0","void main() {","vec3 rgbNW = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( -1.0, -1.0 ) ) * resolution ).xyz;","vec3 rgbNE = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( 1.0, -1.0 ) ) * resolution ).xyz;","vec3 rgbSW = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( -1.0, 1.0 ) ) * resolution ).xyz;","vec3 rgbSE = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( 1.0, 1.0 ) ) * resolution ).xyz;","vec4 rgbaM  = texture2D( tDiffuse,  gl_FragCoord.xy  * resolution );","vec3 rgbM  = rgbaM.xyz;","float opacity  = rgbaM.w;","vec3 luma = vec3( 0.299, 0.587, 0.114 );","float lumaNW = dot( rgbNW, luma );","float lumaNE = dot( rgbNE, luma );","float lumaSW = dot( rgbSW, luma );","float lumaSE = dot( rgbSE, luma );","float lumaM  = dot( rgbM,  luma );","float lumaMin = min( lumaM, min( min( lumaNW, lumaNE ), min( lumaSW, lumaSE ) ) );","float lumaMax = max( lumaM, max( max( lumaNW, lumaNE) , max( lumaSW, lumaSE ) ) );","vec2 dir;","dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));","dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));","float dirReduce = max( ( lumaNW + lumaNE + lumaSW + lumaSE ) * ( 0.25 * FXAA_REDUCE_MUL ), FXAA_REDUCE_MIN );","float rcpDirMin = 1.0 / ( min( abs( dir.x ), abs( dir.y ) ) + dirReduce );","dir = min( vec2( FXAA_SPAN_MAX,  FXAA_SPAN_MAX),","max( vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX),","dir * rcpDirMin)) * resolution;","vec3 rgbA = texture2D( tDiffuse, gl_FragCoord.xy  * resolution + dir * ( 1.0 / 3.0 - 0.5 ) ).xyz;","rgbA += texture2D( tDiffuse, gl_FragCoord.xy  * resolution + dir * ( 2.0 / 3.0 - 0.5 ) ).xyz;","rgbA *= 0.5;","vec3 rgbB = texture2D( tDiffuse, gl_FragCoord.xy  * resolution + dir * -0.5 ).xyz;","rgbB += texture2D( tDiffuse, gl_FragCoord.xy  * resolution + dir * 0.5 ).xyz;","rgbB *= 0.25;","rgbB += rgbA * 0.5;","float lumaB = dot( rgbB, luma );","if ( ( lumaB < lumaMin ) || ( lumaB > lumaMax ) ) {","gl_FragColor = vec4( rgbA, opacity );","} else {","gl_FragColor = vec4( rgbB, opacity );","}","}"].join("\n")},THREE.UnpackDepthRGBAShader={uniforms:{tDiffuse:{type:"t",value:null},opacity:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","float unpackDepth( const in vec4 rgba_depth ) {","const vec4 bit_shift = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );","float depth = dot( rgba_depth, bit_shift );","return depth;","}","void main() {","float depth = 1.0 - unpackDepth( texture2D( tDiffuse, vUv ) );","gl_FragColor = opacity * vec4( vec3( depth ), 1.0 );","}"].join("\n")},THREE.EffectComposer=function(e,t){if(this.renderer=e,void 0===t){var i=window.innerWidth||1,n=window.innerHeight||1,r={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBFormat,stencilBuffer:!1};
t=new THREE.WebGLRenderTarget(i,n,r)}this.renderTarget1=t,this.renderTarget2=t.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.passes=[],void 0===THREE.CopyShader&&console.error("THREE.EffectComposer relies on THREE.CopyShader"),this.copyPass=new THREE.ShaderPass(THREE.CopyShader)},THREE.EffectComposer.prototype={swapBuffers:function(){var e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e},addPass:function(e){this.passes.push(e)},insertPass:function(e,t){this.passes.splice(t,0,e)},render:function(e){this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2;var t,i,n=!1,r=this.passes.length;for(i=0;r>i;i++)if(t=this.passes[i],t.enabled){if(t.render(this.renderer,this.writeBuffer,this.readBuffer,e,n),t.needsSwap){if(n){var a=this.renderer.context;a.stencilFunc(a.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),a.stencilFunc(a.EQUAL,1,4294967295)}this.swapBuffers()}t instanceof THREE.MaskPass?n=!0:t instanceof THREE.ClearMaskPass&&(n=!1)}},reset:function(e){void 0===e&&(e=this.renderTarget1.clone(),e.width=window.innerWidth,e.height=window.innerHeight),this.renderTarget1=e,this.renderTarget2=e.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2},setSize:function(e,t){var i=this.renderTarget1.clone();i.width=e,i.height=t,this.reset(i)}},THREE.EffectComposer.camera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),THREE.EffectComposer.quad=new THREE.Mesh(new THREE.PlaneGeometry(2,2),null),THREE.EffectComposer.scene=new THREE.Scene,THREE.EffectComposer.scene.add(THREE.EffectComposer.quad),THREE.RenderPass=function(e,t,i,n,r){this.scene=e,this.camera=t,this.overrideMaterial=i,this.clearColor=n,this.clearAlpha=void 0!==r?r:1,this.oldClearColor=new THREE.Color,this.oldClearAlpha=1,this.enabled=!0,this.clear=!0,this.needsSwap=!1},THREE.RenderPass.prototype={render:function(e,t,i){this.scene.overrideMaterial=this.overrideMaterial,this.clearColor&&(this.oldClearColor.copy(e.getClearColor()),this.oldClearAlpha=e.getClearAlpha(),e.setClearColor(this.clearColor,this.clearAlpha)),e.render(this.scene,this.camera,i,this.clear),this.clearColor&&e.setClearColor(this.oldClearColor,this.oldClearAlpha),this.scene.overrideMaterial=null}},THREE.MaskPass=function(e,t){this.scene=e,this.camera=t,this.enabled=!0,this.clear=!0,this.needsSwap=!1,this.inverse=!1},THREE.MaskPass.prototype={render:function(e,t,i){var n=e.context;n.colorMask(!1,!1,!1,!1),n.depthMask(!1);var r,a;this.inverse?(r=0,a=1):(r=1,a=0),n.enable(n.STENCIL_TEST),n.stencilOp(n.REPLACE,n.REPLACE,n.REPLACE),n.stencilFunc(n.ALWAYS,r,4294967295),n.clearStencil(a),e.render(this.scene,this.camera,i,this.clear),e.render(this.scene,this.camera,t,this.clear),n.colorMask(!0,!0,!0,!0),n.depthMask(!0),n.stencilFunc(n.EQUAL,1,4294967295),n.stencilOp(n.KEEP,n.KEEP,n.KEEP)}},THREE.ClearMaskPass=function(){this.enabled=!0},THREE.ClearMaskPass.prototype={render:function(e){var t=e.context;t.disable(t.STENCIL_TEST)}},THREE.ShaderPass=function(e,t){this.textureID=void 0!==t?t:"tDiffuse",this.uniforms=THREE.UniformsUtils.clone(e.uniforms),this.material=new THREE.ShaderMaterial({uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader}),this.renderToScreen=!1,this.enabled=!0,this.needsSwap=!0,this.clear=!1},THREE.ShaderPass.prototype={render:function(e,t,i){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=i),THREE.EffectComposer.quad.material=this.material,this.renderToScreen?e.render(THREE.EffectComposer.scene,THREE.EffectComposer.camera):e.render(THREE.EffectComposer.scene,THREE.EffectComposer.camera,t,this.clear)}},void 0===Date.now&&(Date.now=function(){return(new Date).valueOf()});var TWEEN=TWEEN||function(){var e=[];return{REVISION:"12",getAll:function(){return e},removeAll:function(){e=[]},add:function(t){e.push(t)},remove:function(t){t=e.indexOf(t),-1!==t&&e.splice(t,1)},update:function(t){if(0===e.length)return!1;for(var i=0,t=void 0!==t?t:"undefined"!=typeof window&&void 0!==window.performance&&void 0!==window.performance.now?window.performance.now():Date.now();e.length>i;)e[i].update(t)?i++:e.splice(i,1);return!0}}}();TWEEN.Tween=function(e){var t,i={},n={},r={},a=1e3,o=0,s=!1,c=!1,l=0,h=null,d=TWEEN.Easing.Linear.None,u=TWEEN.Interpolation.Linear,f=[],m=null,p=!1,v=null,g=null;for(t in e)i[t]=parseFloat(e[t],10);this.to=function(e,t){return void 0!==t&&(a=t),n=e,this},this.start=function(t){TWEEN.add(this),c=!0,p=!1,h=void 0!==t?t:"undefined"!=typeof window&&void 0!==window.performance&&void 0!==window.performance.now?window.performance.now():Date.now(),h+=l;for(var a in n){if(n[a]instanceof Array){if(0===n[a].length)continue;n[a]=[e[a]].concat(n[a])}i[a]=e[a],!1==i[a]instanceof Array&&(i[a]*=1),r[a]=i[a]||0}return this},this.stop=function(){return c?(TWEEN.remove(this),c=!1,this.stopChainedTweens(),this):this},this.stopChainedTweens=function(){for(var e=0,t=f.length;t>e;e++)f[e].stop()},this.delay=function(e){return l=e,this},this.repeat=function(e){return o=e,this},this.yoyo=function(e){return s=e,this},this.easing=function(e){return d=e,this},this.interpolation=function(e){return u=e,this},this.chain=function(){return f=arguments,this},this.onStart=function(e){return m=e,this},this.onUpdate=function(e){return v=e,this},this.onComplete=function(e){return g=e,this},this.update=function(t){var c;if(h>t)return!0;!1===p&&(null!==m&&m.call(e),p=!0);var E=(t-h)/a,E=E>1?1:E,y=d(E);for(c in n){var S=i[c]||0,b=n[c];b instanceof Array?e[c]=u(b,y):("string"==typeof b&&(b=S+parseFloat(b,10)),"number"==typeof b&&(e[c]=S+(b-S)*y))}if(null!==v&&v.call(e,y),1==E){if(!(o>0)){for(null!==g&&g.call(e),c=0,E=f.length;E>c;c++)f[c].start(t);return!1}isFinite(o)&&o--;for(c in r)"string"==typeof n[c]&&(r[c]+=parseFloat(n[c],10)),s&&(E=r[c],r[c]=n[c],n[c]=E),i[c]=r[c];h=t+l}return!0}},TWEEN.Easing={Linear:{None:function(e){return e}},Quadratic:{In:function(e){return e*e},Out:function(e){return e*(2-e)},InOut:function(e){return 1>(e*=2)?.5*e*e:-.5*(--e*(e-2)-1)}},Cubic:{In:function(e){return e*e*e},Out:function(e){return--e*e*e+1},InOut:function(e){return 1>(e*=2)?.5*e*e*e:.5*((e-=2)*e*e+2)}},Quartic:{In:function(e){return e*e*e*e},Out:function(e){return 1- --e*e*e*e},InOut:function(e){return 1>(e*=2)?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}},Quintic:{In:function(e){return e*e*e*e*e},Out:function(e){return--e*e*e*e*e+1},InOut:function(e){return 1>(e*=2)?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}},Sinusoidal:{In:function(e){return 1-Math.cos(e*Math.PI/2)},Out:function(e){return Math.sin(e*Math.PI/2)},InOut:function(e){return.5*(1-Math.cos(Math.PI*e))}},Exponential:{In:function(e){return 0===e?0:Math.pow(1024,e-1)},Out:function(e){return 1===e?1:1-Math.pow(2,-10*e)},InOut:function(e){return 0===e?0:1===e?1:1>(e*=2)?.5*Math.pow(1024,e-1):.5*(-Math.pow(2,-10*(e-1))+2)}},Circular:{In:function(e){return 1-Math.sqrt(1-e*e)},Out:function(e){return Math.sqrt(1- --e*e)},InOut:function(e){return 1>(e*=2)?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}},Elastic:{In:function(e){var t,i=.1;return 0===e?0:1===e?1:(!i||1>i?(i=1,t=.1):t=.4*Math.asin(1/i)/(2*Math.PI),-(i*Math.pow(2,10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4)))},Out:function(e){var t,i=.1;return 0===e?0:1===e?1:(!i||1>i?(i=1,t=.1):t=.4*Math.asin(1/i)/(2*Math.PI),i*Math.pow(2,-10*e)*Math.sin(2*(e-t)*Math.PI/.4)+1)},InOut:function(e){var t,i=.1;return 0===e?0:1===e?1:(!i||1>i?(i=1,t=.1):t=.4*Math.asin(1/i)/(2*Math.PI),1>(e*=2)?-.5*i*Math.pow(2,10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4):.5*i*Math.pow(2,-10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4)+1)}},Back:{In:function(e){return e*e*(2.70158*e-1.70158)},Out:function(e){return--e*e*(2.70158*e+1.70158)+1},InOut:function(e){return 1>(e*=2)?.5*e*e*(3.5949095*e-2.5949095):.5*((e-=2)*e*(3.5949095*e+2.5949095)+2)}},Bounce:{In:function(e){return 1-TWEEN.Easing.Bounce.Out(1-e)},Out:function(e){return 1/2.75>e?7.5625*e*e:2/2.75>e?7.5625*(e-=1.5/2.75)*e+.75:2.5/2.75>e?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375},InOut:function(e){return.5>e?.5*TWEEN.Easing.Bounce.In(2*e):.5*TWEEN.Easing.Bounce.Out(2*e-1)+.5}}},TWEEN.Interpolation={Linear:function(e,t){var i=e.length-1,n=i*t,r=Math.floor(n),a=TWEEN.Interpolation.Utils.Linear;return 0>t?a(e[0],e[1],n):t>1?a(e[i],e[i-1],i-n):a(e[r],e[r+1>i?i:r+1],n-r)},Bezier:function(e,t){var i,n=0,r=e.length-1,a=Math.pow,o=TWEEN.Interpolation.Utils.Bernstein;for(i=0;r>=i;i++)n+=a(1-t,r-i)*a(t,i)*e[i]*o(r,i);return n},CatmullRom:function(e,t){var i=e.length-1,n=i*t,r=Math.floor(n),a=TWEEN.Interpolation.Utils.CatmullRom;return e[0]===e[i]?(0>t&&(r=Math.floor(n=i*(1+t))),a(e[(r-1+i)%i],e[r],e[(r+1)%i],e[(r+2)%i],n-r)):0>t?e[0]-(a(e[0],e[0],e[1],e[1],-n)-e[0]):t>1?e[i]-(a(e[i],e[i],e[i-1],e[i-1],n-i)-e[i]):a(e[r?r-1:0],e[r],e[r+1>i?i:r+1],e[r+2>i?i:r+2],n-r)},Utils:{Linear:function(e,t,i){return(t-e)*i+e},Bernstein:function(e,t){var i=TWEEN.Interpolation.Utils.Factorial;return i(e)/i(t)/i(e-t)},Factorial:function(){var e=[1];return function(t){var i,n=1;if(e[t])return e[t];for(i=t;i>1;i--)n*=i;return e[t]=n}}(),CatmullRom:function(e,t,i,n,r){var e=.5*(i-e),n=.5*(n-t),a=r*r;return(2*t-2*i+e+n)*r*a+(-3*t+3*i-2*e-n)*a+e*r+t}}},GIScene.Coordinate2=function(e,t){THREE.Vector2.apply(this,[e,t])},GIScene.Coordinate2.prototype=Object.create(THREE.Vector2.prototype),GIScene.Coordinate2.prototype.toVector2=function(){return new THREE.Vector2(this.x,-this.y)},GIScene.Coordinate2.prototype.fromVector2=function(e){return this.x=e.x,this.y=-e.y,this},GIScene.Coordinate2.prototype.clone=function(){return new GIScene.Coordinate2(this.x,this.y)},GIScene.Coordinate3=function(e,t,i){THREE.Vector3.apply(this,[e,t,i])},GIScene.Coordinate3.prototype=Object.create(THREE.Vector3.prototype),GIScene.Coordinate3.prototype.toVector3=function(){return new THREE.Vector3(this.x,this.z,-this.y)},GIScene.Coordinate3.prototype.fromVector3=function(e){return this.x=e.x,this.y=-e.z,this.z=e.y,this},GIScene.Coordinate3.prototype.clone=function(){return new GIScene.Coordinate3(this.x,this.y,this.z)},GIScene.Extent2=function(e,t){THREE.Box2.apply(this,[e,t])},GIScene.Extent2.prototype=Object.create(THREE.Box2.prototype),GIScene.Extent2.prototype.toPolygonV2=function(){var e=this.min,t=this.max,i=[new GIScene.Coordinate2(e.x,e.y),new GIScene.Coordinate2(t.x,e.y),new GIScene.Coordinate2(t.x,t.y),new GIScene.Coordinate2(e.x,t.y)];return i},GIScene.Extent2.prototype.fromBox3=function(e){return this.min=new GIScene.Coordinate2(e.min.x,-e.max.z),this.max=new GIScene.Coordinate2(e.max.x,-e.min.z),this},GIScene.Extent2.prototype.clone=function(){return new GIScene.Extent2(this.min,this.max)},GIScene.Line2=function(e,t){this.positionVector=e,this.directionVector=t},GIScene.Line2.prototype.getNormalizedNormalRight=function(){return new THREE.Vector2(-this.directionVector.y,this.directionVector.x).normalize()},GIScene.Line2.prototype.getNormalizedNormalLeft=function(){return new THREE.Vector2(this.directionVector.y,-this.directionVector.x).normalize()},GIScene.Line2.prototype.fromPoints=function(e,t){return this.positionVector=e.clone(),this.directionVector=t.clone().sub(e),this},GIScene.Line2.prototype.intersect=function(e){var t=this.directionVector,i=e.directionVector,n=this.positionVector,r=e.positionVector,a=t.x,o=-i.x,s=r.x-n.x,c=t.y,l=-i.y,h=r.y-n.y;if(0==a){var d=a,u=o,f=s;a=c,o=l,s=h,c=d,l=u,h=f}s/=a,o/=a,a=1;var m=-c;c+=a*m,l+=o*m,h+=s*m,m=1/l,h*=m,m=-o,s+=h*m;var p=s,v=n.add(t.multiplyScalar(p));return v},GIScene.Line2.prototype.moveLeft=function(e){var t=this.getNormalizedNormalLeft();return this.positionVector=this.positionVector.add(t.multiplyScalar(e)),this},GIScene.Line2.prototype.moveRight=function(e){var t=this.getNormalizedNormalRight();return this.positionVector=this.positionVector.add(t.multiplyScalar(e)),this},GIScene.Utils={WorkingMaterial:{setFlag:function(e,t,i,n){if("default"==i)e.userData.workingMaterialFlags&=~n;else if("materials"in e.material){for(var r=null,a=1;e.userData.originalMaterial.materials.length>a&&(r=i instanceof THREE.Color?e.userData.originalMaterial.materials[0][t].equals(e.userData.originalMaterial.materials[a][t]):e.userData.originalMaterial.materials[0][t]==e.userData.originalMaterial.materials[a][t],r);a++);r?i instanceof THREE.Color?i.equals(e.userData.originalMaterial.materials[0][t])?e.userData.workingMaterialFlags&=~n:e.userData.workingMaterialFlags|=n:i!=e.userData.originalMaterial.materials[0][t]?e.userData.workingMaterialFlags|=n:e.userData.workingMaterialFlags&=~n:e.userData.workingMaterialFlags|=n}else i instanceof THREE.Color?i.equals(e.userData.originalMaterial[t])?e.userData.workingMaterialFlags&=~n:e.userData.workingMaterialFlags|=n:i!=e.userData.originalMaterial[t]?e.userData.workingMaterialFlags|=n:e.userData.workingMaterialFlags&=~n},isSetFlag:function(e,t){return"workingMaterialFlags"in e.userData?!!(e.userData.workingMaterialFlags&t):!1},getValues:function(e){var t={};return GIScene.Utils.WorkingMaterial.isSetFlag(e,GIScene.WORKINGMATERIALFLAGS.SELECT)&&(t.setSelectColor=e.material.emissive.clone()),GIScene.Utils.WorkingMaterial.isSetFlag(e,GIScene.WORKINGMATERIALFLAGS.WIRE)&&(t.setWireframe=e.material.wireframe),GIScene.Utils.WorkingMaterial.isSetFlag(e,GIScene.WORKINGMATERIALFLAGS.SHADING)&&(t.setShading=e.material.shading),GIScene.Utils.WorkingMaterial.isSetFlag(e,GIScene.WORKINGMATERIALFLAGS.SIDE)&&(t.setFaceCulling=e.material.side),GIScene.Utils.WorkingMaterial.isSetFlag(e,GIScene.WORKINGMATERIALFLAGS.MAP)&&(t.setTexturing=!1),GIScene.Utils.WorkingMaterial.isSetFlag(e,GIScene.WORKINGMATERIALFLAGS.OPACITY)&&(t.setOpacity=e.material.opacity),GIScene.Utils.WorkingMaterial.isSetFlag(e,GIScene.WORKINGMATERIALFLAGS.VERTEXCOLORS)&&(t.setVertexColors=e.material.vertexColors),GIScene.Utils.WorkingMaterial.isSetFlag(e,GIScene.WORKINGMATERIALFLAGS.DIFFUSE)&&(t.setDiffuseColor=e.material.color.clone()),GIScene.Utils.WorkingMaterial.isSetFlag(e,GIScene.WORKINGMATERIALFLAGS.AMBIENT)&&(t.setAmbientColor=e.material.ambient.clone()),t},setValues:function(e,t){for(value in t)GIScene.Utils.WorkingMaterial[value](e,t[value])},setWireframe:function(e,t){!e.material||e instanceof THREE.Sprite||e instanceof THREE.Points||(e.userData.originalMaterial||(e.userData.originalMaterial=e.material,e.material=e.userData.originalMaterial.clone(),e.userData.workingMaterialFlags=0),GIScene.Utils.WorkingMaterial.setFlag(e,"wireframe",t,GIScene.WORKINGMATERIALFLAGS.WIRE),"materials"in e.material?e.material.materials.forEach(function(i,n,r){r[n].wireframe="default"==t?e.userData.originalMaterial.materials[n].wireframe:t}):e.material.wireframe="default"==t?e.userData.originalMaterial.wireframe:t,0==e.userData.workingMaterialFlags&&(e.material=e.userData.originalMaterial,e.userData.originalMaterial=null,delete e.userData.originalMaterial))},setTexturing:function(e,t){if(e.material&&!(e instanceof THREE.Sprite||e instanceof THREE.Points)){e.userData.originalMaterial||(e.userData.originalMaterial=e.material,e.material=e.userData.originalMaterial.clone(),e.userData.workingMaterialFlags=0);var i;switch(t){case"default":i="default";break;case!0:t=i="default";break;case!1:i=null;break;default:console.log("'setTexturing':  No such texturingMode: "+t)}if(GIScene.Utils.WorkingMaterial.setFlag(e,"map",i,GIScene.WORKINGMATERIALFLAGS.MAP),"materials"in e.material)e.material.materials.forEach(function(i,n,r){if("default"==t)var a=!!e.userData.originalMaterial.materials[n].map;else var a=t;var o=a?e.userData.originalMaterial.materials[n].map?e.userData.originalMaterial.materials[n].map.clone():null:null;r[n].map=o,null!=r[n].map&&(r[n].map.needsUpdate=!0),r[n].needsUpdate=!0});else{if("default"==t)var n=!!e.userData.originalMaterial.map;else var n=t;var r=n?e.userData.originalMaterial.map?e.userData.originalMaterial.map.clone():null:null;e.material.map=r,null!=e.material.map&&(e.material.map.needsUpdate=!0),e.material.needsUpdate=!0}0==e.userData.workingMaterialFlags&&(e.material=e.userData.originalMaterial,e.userData.originalMaterial=null,delete e.userData.originalMaterial)}},setFaceCulling:function(e,t){function i(e,t){e.side=t,e.needsUpdate=!0}if(e.material&&!(e instanceof THREE.Sprite||e instanceof THREE.Points)){if(e.userData.originalMaterial||(e.userData.originalMaterial=e.material,e.material=e.userData.originalMaterial.clone(),e.userData.workingMaterialFlags=0),GIScene.Utils.WorkingMaterial.setFlag(e,"side",t,GIScene.WORKINGMATERIALFLAGS.SIDE),"materials"in e.material)e.material.materials.forEach(function(n,r,a){if("default"==t)var o=e.userData.originalMaterial.materials[r].side;else var o=t;i(a[r],o)});else{if("default"==t)var n=e.userData.originalMaterial.side;else var n=t;i(e.material,n)}0==e.userData.workingMaterialFlags&&(e.material=e.userData.originalMaterial,e.userData.originalMaterial=null,delete e.userData.originalMaterial)}},setVertexColors:function(e,t){!e.material||e instanceof THREE.Sprite||e instanceof THREE.Points||(e.userData.originalMaterial||(e.userData.originalMaterial=e.material,e.material=e.userData.originalMaterial.clone(),e.userData.workingMaterialFlags=0),GIScene.Utils.WorkingMaterial.setFlag(e,"vertexColors",t,GIScene.WORKINGMATERIALFLAGS.VERTEXCOLORS),"materials"in e.material?e.material.materials.forEach(function(i,n,r){"default"==t?(r[n].vertexColors=e.userData.originalMaterial.materials[n].vertexColors,r[n].color=e.userData.originalMaterial.materials[n].color,r[n].ambient=e.userData.originalMaterial.materials[n].ambient,r[n].needsUpdate=!0):e.geometry.faces[0].vertexColors.length>0&&(r[n].vertexColors=t,t==THREE.NoColors?(r[n].color=new THREE.Color(16777215),r[n].ambient=new THREE.Color(10066329)):(r[n].color=new THREE.Color(16777215),r[n].ambient=new THREE.Color(16777215)),r[n].needsUpdate=!0)}):"default"==t?(e.material.vertexColors=e.userData.originalMaterial.vertexColors,e.material.color=e.userData.originalMaterial.color,e.material.ambient=e.userData.originalMaterial.ambient,e.material.needsUpdate=!0):e.geometry.faces[0].vertexColors.length>0&&(e.material.vertexColors=t,t==THREE.NoColors?(e.material.color=new THREE.Color(16777215),e.material.ambient=new THREE.Color(10066329)):(e.material.color=new THREE.Color(16777215),e.material.ambient=new THREE.Color(16777215)),e.material.needsUpdate=!0),0==e.userData.workingMaterialFlags&&(e.material=e.userData.originalMaterial,e.userData.originalMaterial=null,delete e.userData.originalMaterial))},setShading:function(e,t){if(e.material&&!(e instanceof THREE.Sprite||e instanceof THREE.Points)){if(e.userData.originalMaterial||(e.userData.originalMaterial=e.material,e.material=e.userData.originalMaterial.clone(),e.userData.workingMaterialFlags=0),GIScene.Utils.WorkingMaterial.setFlag(e,"shading",t,GIScene.WORKINGMATERIALFLAGS.SHADING),!("originalVertexNormals"in e.userData)){e.userData.originalVertexNormals=[];for(var i=0,n=e.geometry.faces.length;n>i;i++)0!=e.geometry.faces[i].vertexNormals.length&&(e.userData.originalVertexNormals[e.geometry.faces[i].a]=e.geometry.faces[i].vertexNormals[0].clone(),e.userData.originalVertexNormals[e.geometry.faces[i].b]=e.geometry.faces[i].vertexNormals[1].clone(),e.userData.originalVertexNormals[e.geometry.faces[i].c]=e.geometry.faces[i].vertexNormals[2].clone())}if("default"==t){for(var i=0,n=e.geometry.faces.length;n>i;i++)void 0==e.userData.originalVertexNormals[e.geometry.faces[i].a]?e.geometry.faces[i].vertexNormals=[]:(e.geometry.faces[i].vertexNormals[0]=e.userData.originalVertexNormals[e.geometry.faces[i].a],e.geometry.faces[i].vertexNormals[1]=e.userData.originalVertexNormals[e.geometry.faces[i].b],e.geometry.faces[i].vertexNormals[2]=e.userData.originalVertexNormals[e.geometry.faces[i].c]);e.geometry.__tmpVertices=void 0,delete e.userData.originalVertexNormals,"materials"in e.material?e.material.materials.forEach(function(t,i,n){n[i].shading=e.userData.originalMaterial.materials[i].shading,e.geometry.normalsNeedUpdate=!0,n[i].needsUpdate=!0}):(e.material.shading=e.userData.originalMaterial.shading,e.geometry.normalsNeedUpdate=!0,e.material.needsUpdate=!0)}else 0==e.geometry.faces[0].vertexNormals.length&&e.geometry.computeVertexNormals(),"materials"in e.material?e.material.materials.forEach(function(i,n,r){r[n].shading=t,e.geometry.normalsNeedUpdate=!0,r[n].needsUpdate=!0}):(e.material.shading=t,e.geometry.normalsNeedUpdate=!0,e.material.needsUpdate=!0);0==e.userData.workingMaterialFlags&&(e.material=e.userData.originalMaterial,e.userData.originalMaterial=null,delete e.userData.originalMaterial)}},setDiffuseColor:function(e,t){!e.material||e instanceof THREE.Sprite||e instanceof THREE.Points||(e.userData.originalMaterial||(e.userData.originalMaterial=e.material,e.material=e.userData.originalMaterial.clone(),e.userData.workingMaterialFlags=0),GIScene.Utils.WorkingMaterial.setFlag(e,"color",t,GIScene.WORKINGMATERIALFLAGS.DIFFUSE),"materials"in e.material?e.material.materials.forEach(function(i,n,r){r[n].color="default"==t?e.userData.originalMaterial.materials[n].color:t}):e.material.color="default"==t?e.userData.originalMaterial.color:t,0==e.userData.workingMaterialFlags&&(e.material=e.userData.originalMaterial,e.userData.originalMaterial=null,delete e.userData.originalMaterial))},setAmbientColor:function(e,t){!e.material||e instanceof THREE.Sprite||e instanceof THREE.Points||(e.userData.originalMaterial||(e.userData.originalMaterial=e.material,e.material=e.userData.originalMaterial.clone(),e.userData.workingMaterialFlags=0),GIScene.Utils.WorkingMaterial.setFlag(e,"ambient",t,GIScene.WORKINGMATERIALFLAGS.AMBIENT),"materials"in e.material?e.material.materials.forEach(function(i,n,r){r[n].ambient="default"==t?e.userData.originalMaterial.materials[n].ambient:t}):e.material.ambient="default"==t?e.userData.originalMaterial.ambient:t,0==e.userData.workingMaterialFlags&&(e.material=e.userData.originalMaterial,e.userData.originalMaterial=null,delete e.userData.originalMaterial))},setSelectColor:function(e,t){!e.material||e instanceof THREE.Sprite||e instanceof THREE.Points||(e.userData.originalMaterial||(e.userData.originalMaterial=e.material,e.material=e.userData.originalMaterial.clone(),e.userData.workingMaterialFlags=0),GIScene.Utils.WorkingMaterial.setFlag(e,"emissive",t,GIScene.WORKINGMATERIALFLAGS.SELECT),"materials"in e.material?e.material.materials.forEach(function(i,n,r){"emissive"in r[n]&&(r[n].emissive="default"==t?e.userData.originalMaterial.materials[n].emissive:t)}):"emissive"in e.material&&(e.material.emissive="default"==t?e.userData.originalMaterial.emissive:t),0==e.userData.workingMaterialFlags&&(e.material=e.userData.originalMaterial,e.userData.originalMaterial=null,delete e.userData.originalMaterial))},setOpacity:function(e,t){e.material&&(e.userData.originalMaterial||(e.userData.originalMaterial=e.material,e.material=e.userData.originalMaterial.clone(),e.userData.workingMaterialFlags=0),GIScene.Utils.WorkingMaterial.setFlag(e,"opacity",t,GIScene.WORKINGMATERIALFLAGS.OPACITY),"materials"in e.material?e.material.materials.forEach(function(i,n,r){"default"==t?(r[n].opacity=e.userData.originalMaterial.materials[n].opacity,r[n].transparent=e.userData.originalMaterial.materials[n].transparent,r[n].depthTest=e.userData.originalMaterial.materials[n].depthTest):(r[n].opacity=t*e.userData.originalMaterial.materials[n].opacity,r[n].transparent=1>r[n].opacity?!0:!1,r[n].depthTest=1>r[n].opacity?!1:!0)}):"default"==t?(e.material.opacity=e.userData.originalMaterial.opacity,e.material.transparent=e.userData.originalMaterial.transparent,e.material.depthTest=e.userData.originalMaterial.depthTest):(e.material.opacity=t*e.userData.originalMaterial.opacity,e.material.transparent=1>e.material.opacity?!0:!1,e.material.depthTest=1>e.material.opacity?!1:!0),0==e.userData.workingMaterialFlags&&(e.material=e.userData.originalMaterial,e.userData.originalMaterial=null,delete e.userData.originalMaterial))}},mergeObjects:function(e,t){var i={};for(var n in e)i[n]=e[n];for(var n in t)i[n]=t[n];return i},getRelativeScreenCoordsFromDOMEvent:function(e,t){var i=new THREE.Vector2,n=e.getBoundingClientRect();return i.x=t.clientX-n.left,i.y=t.clientY-n.top,i},getViewportCoordsFromDOMEvent:function(e,t){var i=GIScene.Utils.getRelativeScreenCoordsFromDOMEvent(e,t),n=GIScene.Utils.transformRelativeScreenCoordsToViewportCoords(i,e.offsetWidth,e.offsetHeight);return n},transformRelativeScreenCoordsToViewportCoords:function(e,t,i){var n=new THREE.Vector2;return n.x=2*(e.x/t)-1,n.y=2*-(e.y/i)+1,n},transformViewportCoordsToRelativeScreenCoords:function(e,t,i){var n=new THREE.Vector2;return n.x=(e.x+1)/2*t,n.y=(e.y-1)/-2*i,n},computeBoundingBoxRecursive:function(e){return console.log("Deprecated: GIScene.Utils.computeBoundingBoxRecursive(). Use THREE.Box3().setFromObject(obj)"),(new THREE.Box3).setFromObject(e)},computeVertexMeanRecursive:function(e){var t=[];e.traverse(function(e){"geometry"in e&&t.push.apply(t,e.geometry.vertices)});for(var i=new THREE.Vector3,n=0;t.length>n;n++)i=i.add(t[0]);var r=i.divideScalar(t.length);return r},polarTransformationAddAngle:function(e,t,i,n){var i=THREE.Math.degToRad(i),n=THREE.Math.degToRad(n),r=t.clone().sub(e),a=Math.atan2(r.x,r.z),o=Math.atan2(Math.sqrt(r.x*r.x+r.z*r.z),r.y);a+=i,o+=n;var s=r.length();return r.x=s*Math.sin(o)*Math.sin(a),r.y=s*Math.cos(o),r.z=s*Math.sin(o)*Math.cos(a),t.copy(e).add(r),t},translatePositionToBBoxCenter:function(e){if(e.geometry&&e.geometry.boundingBox){var t=e.geometry.boundingBox.center().sub(e.position);e.position.add(t),e.geometry.vertices.forEach(function(e){e.sub(t)}),e.geometry.verticesNeedUpdate=!0}},calcRenderDepthMinusBSphereRadius:function(e,t){var i=new THREE.Vector3,n=new THREE.Matrix4;return i.setFromMatrixPosition(e.matrixWorld),n.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),i.applyProjection(n),i.z-e.geometry.boundingSphere.radius},getOrthoParamsFromPerspectiveCam:function(e,t,i){var n=t.fov,i=i?i:(t.near+t.far)/2,r=t.aspect,a=this.getOrthoSizeFromFovDistanceAspect(n,i,r);return a.near=t.near,a.far=t.far,a},getOrthoSizeFromFovDistanceAspect:function(e,t,i){var n={},r=Math.tan(THREE.Math.degToRad(e)/2)*t,a=2*r,o=a*i,s=o/2;return n.left=-s,n.right=s,n.top=r,n.bottom=-r,n},getPerspectiveDistanceFromFovHalfHeight:function(e,t){var i=t/Math.tan(THREE.Math.degToRad(e)/2);return i},arrayContains:function(e,t){for(var i=0,n=e.length;n>i;i++)if(e[i]===t)return!0},removeDuplicatesFromArray:function(e){var t={};return e.filter(function(e){var i=JSON.stringify(e);return 1===t[i]?0:t[i]=1})},vector3ToVector2:function(e){var t=new THREE.Vector2(e.x,e.z);return t},vector2ToVector3:function(e,t){var i=new THREE.Vector3(e.x,t,e.y);return i},disposeObject:function(e,t,i,n,r){var a=[],o=[];if(r){var s=GIScene.Utils.getDescendants(e);s.push(e),s.forEach(function(e){GIScene.Utils.disposeObject(e,t,i,n,!1)}.bind(this))}t&&e.geometry&&(e.geometry.dispose(),delete e.geometry),i&&(e.material&&(e.material instanceof THREE.MeshFaceMaterial?e.material.materials.forEach(function(e){GIScene.Utils.arrayContains(a,e)||a.push(e)}):GIScene.Utils.arrayContains(a,e.material)||a.push(e.material)),delete e.material,n&&a.forEach(function(e){for(var t=["map","lightMap","bumpMap","normalMap","specularMap","envMap"],i=0,n=t.length;n>i;i++)e[t[i]]&&null!=e[t[i]]&&!GIScene.Utils.arrayContains(o,e[t[i]])&&(o.push(e[t[i]]),e[t[i]]=null)})),t&&(e.dispose&&e.dispose(),e=null),o.forEach(function(e){e.dispose()}),o=null,a.forEach(function(e){e.dispose()}),a=null},equalsTypeOrClass:function(valueOrObject,typeOrClassName){var check;if("object"==typeof valueOrObject){console.log("object");try{check=valueOrObject instanceof eval(typeOrClassName)}catch(e){check="object"==typeOrClassName.toLowerCase()?!0:!1}}else{console.log("primitive");var check=typeof valueOrObject===typeOrClassName.toLowerCase()}return check},getObjectsBy:function(e,t){var i=[],n=function(e){t(e)&&i.push(e)};return e.traverse(n),i},getDescendants:function(e,t){void 0===t&&(t=[]),Array.prototype.push.apply(t,e.children);for(var i=0,n=e.children.length;n>i;i++)GIScene.Utils.getDescendants(e.children[i],t);return t}},GIScene.DirectionMaterial=function(e,t){var e=e||new THREE.Vector3(0,0,-1),t=t||15,i={shading:THREE.SmoothShading,uniforms:{opacity:{type:"f",value:1},direction:{type:"v3",value:e},maxDeviationDeg:{type:"f",value:t}},vertexShader:["varying vec3 vNormal;",THREE.ShaderChunk.morphtarget_pars_vertex,"void main() {","vNormal = normalize(  normal );",THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.default_vertex,"}"].join("\n"),fragmentShader:["uniform float opacity;","uniform vec3 direction;","uniform float maxDeviationDeg;","varying vec3 vNormal;","float red;","float maxDeviation;","const float M_PI = 3.14159265358979323846;","uniform mat4 modelMatrix;","void main() {","vec3 worldNormal = mat3( modelMatrix[ 0 ].xyz, modelMatrix[ 1 ].xyz, modelMatrix[ 2 ].xyz ) * vNormal;","worldNormal = normalize( worldNormal );","maxDeviation = maxDeviationDeg * (M_PI / 180.0);","red = (maxDeviation - acos(dot(worldNormal, direction))) / maxDeviation;","gl_FragColor = vec4( 1.0,1.0-red,1.0-red, opacity );","}"].join("\n")};THREE.ShaderMaterial.call(this,i)},GIScene.DirectionMaterial.prototype=Object.create(THREE.ShaderMaterial.prototype),GIScene.AspectMaterial=function(e,t){var i,n,r=new THREE.Color(0);Object.defineProperty(this,"compassDirection",{get:function(){return i},set:function(e){i=e,this.uniforms.compassDirection.value=e}}),Object.defineProperty(this,"maxDeviationDeg",{get:function(){return n},set:function(e){n=e,this.uniforms.maxDeviationDeg.value=e}}),Object.defineProperty(this,"emissive",{get:function(){return r},set:function(e){r=e,this.uniforms.uemissive.value=e}});var a={shading:THREE.SmoothShading,uniforms:{opacity:{type:"f",value:1},compassDirection:{type:"v3",value:e},maxDeviationDeg:{type:"f",value:t},uemissive:{type:"c",value:this.emissive}},vertexShader:["varying vec3 vNormal;","uniform vec3 uemissive;",THREE.ShaderChunk.morphtarget_pars_vertex,"void main() {","vNormal = normalize(  normal );",THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.default_vertex,"}"].join("\n"),fragmentShader:["uniform float opacity;","uniform vec3 compassDirection;","uniform float maxDeviationDeg;","uniform vec3 uemissive;","varying vec3 vNormal;","float red;","float maxDeviation;","const float M_PI = 3.14159265358979323846;","vec3 hDir;","uniform mat4 modelMatrix;","void main() {","vec3 worldNormal = mat3( modelMatrix[ 0 ].xyz, modelMatrix[ 1 ].xyz, modelMatrix[ 2 ].xyz ) * vNormal;","worldNormal = normalize( worldNormal );","maxDeviation = maxDeviationDeg * (M_PI / 180.0);","hDir = worldNormal -  ( dot(worldNormal, vec3(0.0,1.0,0.0)) * vec3(0.0,1.0,0.0));","hDir = normalize(hDir);","float upDeviation = acos(dot(normalize(worldNormal), vec3(0.0,1.0,0.0)));","if (upDeviation < 0.017453292519943295 || upDeviation > M_PI - 0.017453292519943295)","{","gl_FragColor = vec4( vec3(0.5) + uemissive, opacity );","}","else {","red = (maxDeviation - acos(dot(hDir, compassDirection))) / maxDeviation;","gl_FragColor = vec4( vec3(1.0,1.0-red,1.0-red) + uemissive, opacity );","}","}"].join("\n")};THREE.ShaderMaterial.call(this,a),this.compassDirection=e||new THREE.Vector3(0,0,-1),this.maxDeviationDeg=t||15,this.emissive=new THREE.Color(0)},GIScene.AspectMaterial.prototype=Object.create(THREE.ShaderMaterial.prototype),GIScene.AspectMaterial.prototype.clone=function(){var e=new GIScene.AspectMaterial;return THREE.ShaderMaterial.prototype.clone.call(this,e),e.compassDirection=this.compassDirection,e.emissive=this.emissive,e},GIScene.DistanceOpacityMaterial=function(e,t){var e=e||15,t=t||30,i={transparent:!0,lights:!0,side:2,uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.fog,THREE.UniformsLib.lights,THREE.UniformsLib.shadowmap,{ambient:{type:"c",value:new THREE.Color(11184810)},emissive:{type:"c",value:new THREE.Color(0)},wrapRGB:{type:"v3",value:new THREE.Vector3(1,1,1)},mNear:{type:"f",value:e},mFar:{type:"f",value:t}}]),vertexShader:["#define LAMBERT","varying vec3 vLightFront;","#ifdef DOUBLE_SIDED","varying vec3 vLightBack;","#endif",THREE.ShaderChunk.map_pars_vertex,THREE.ShaderChunk.lightmap_pars_vertex,THREE.ShaderChunk.envmap_pars_vertex,THREE.ShaderChunk.lights_lambert_pars_vertex,THREE.ShaderChunk.color_pars_vertex,THREE.ShaderChunk.morphtarget_pars_vertex,THREE.ShaderChunk.skinning_pars_vertex,THREE.ShaderChunk.shadowmap_pars_vertex,"void main() {",THREE.ShaderChunk.map_vertex,THREE.ShaderChunk.lightmap_vertex,THREE.ShaderChunk.color_vertex,THREE.ShaderChunk.morphnormal_vertex,THREE.ShaderChunk.skinbase_vertex,THREE.ShaderChunk.skinnormal_vertex,THREE.ShaderChunk.defaultnormal_vertex,THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.skinning_vertex,THREE.ShaderChunk.default_vertex,THREE.ShaderChunk.worldpos_vertex,THREE.ShaderChunk.envmap_vertex,THREE.ShaderChunk.lights_lambert_vertex,THREE.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform float mNear;","uniform float mFar;","uniform float opacity;","varying vec3 vLightFront;","#ifdef DOUBLE_SIDED","varying vec3 vLightBack;","#endif",THREE.ShaderChunk.color_pars_fragment,THREE.ShaderChunk.map_pars_fragment,THREE.ShaderChunk.lightmap_pars_fragment,THREE.ShaderChunk.envmap_pars_fragment,THREE.ShaderChunk.fog_pars_fragment,THREE.ShaderChunk.shadowmap_pars_fragment,THREE.ShaderChunk.specularmap_pars_fragment,"void main() {","gl_FragColor = vec4( vec3 ( 1.0 ), opacity );",THREE.ShaderChunk.map_fragment,THREE.ShaderChunk.alphatest_fragment,THREE.ShaderChunk.specularmap_fragment,"#ifdef DOUBLE_SIDED","if ( gl_FrontFacing )","gl_FragColor.xyz *= vLightFront;","else","gl_FragColor.xyz *= vLightBack;","#else","gl_FragColor.xyz *= vLightFront;","#endif",THREE.ShaderChunk.lightmap_fragment,THREE.ShaderChunk.color_fragment,THREE.ShaderChunk.envmap_fragment,THREE.ShaderChunk.shadowmap_fragment,THREE.ShaderChunk.linear_to_gamma_fragment,THREE.ShaderChunk.fog_fragment,"float depth_ = gl_FragCoord.z / gl_FragCoord.w;","float distOpacity = smoothstep( mNear, mFar, depth_ );","gl_FragColor = vec4( gl_FragColor.rgb, distOpacity );","if (distOpacity < 0.01) discard;","}"].join("\n")};
THREE.ShaderMaterial.call(this,i)},GIScene.DistanceOpacityMaterial.prototype=Object.create(THREE.ShaderMaterial.prototype),GIScene.RasterOverlayMaterial=function(e){var t={texture:null,url:null,crossOrigin:"anonymous",lowerLeft:new GIScene.Coordinate2(-100,-100),upperRight:new GIScene.Coordinate2(100,100),offset2:null,isShared:!0,color:11322501,emissive:new THREE.Color(0)};this.config=GIScene.Utils.mergeObjects(t,e||{}),this.url=this.config.url,this.crossOrigin=this.config.crossOrigin,this.offset2=this.config.offset2?this.config.offset2:new GIScene.Coordinate2(0,0),this.lowerLeft=this.config.lowerLeft.sub(this.offset2)||new GIScene.Coordinate2(-100,-100),this.upperRight=this.config.upperRight.sub(this.offset2)||new GIScene.Coordinate2(100,100),this.texture=this.config.texture||new THREE.Texture,this.isShared=this.config.isShared;var i=this.config.emissive;Object.defineProperty(this,"emissive",{get:function(){return console.log("get! emissive"),i},set:function(e){i=e,this.uniforms.emissive.value=new THREE.Color(e)}});var n=this.config.color;Object.defineProperty(this,"color",{get:function(){return n},set:function(e){n=e,this.uniforms.diffuse.value=new THREE.Color(e)}}),this.url&&this.setTextureFromUrl(this.url,this.crossOrigin);var r={transparent:!0,lights:!0,side:0,shading:THREE.SmoothShading,uniforms:THREE.UniformsUtils.merge([THREE.ShaderLib.lambert.uniforms,{tOverlay:{type:"t",value:this.texture},lowerLeft:{type:"v2",value:this.lowerLeft},upperRight:{type:"v2",value:this.upperRight},emissive:{type:"c",value:new THREE.Color(this.emissive)},diffuse:{type:"c",value:new THREE.Color(this.color)}}]),vertexShader:["varying vec3 vWorldPosition;","#define LAMBERT","varying vec3 vLightFront;","#ifdef DOUBLE_SIDED","	varying vec3 vLightBack;","#endif","#include <common>","#include <uv_pars_vertex>","#include <uv2_pars_vertex>","#include <envmap_pars_vertex>","#include <bsdfs>","#include <lights_pars>","#include <color_pars_vertex>","#include <morphtarget_pars_vertex>","#include <skinning_pars_vertex>","#include <shadowmap_pars_vertex>","#include <logdepthbuf_pars_vertex>","#include <clipping_planes_pars_vertex>","void main() {","	#include <uv_vertex>","	#include <uv2_vertex>","	#include <color_vertex>","	#include <beginnormal_vertex>","	#include <morphnormal_vertex>","	#include <skinbase_vertex>","	#include <skinnormal_vertex>","	#include <defaultnormal_vertex>","	#include <begin_vertex>","	#include <morphtarget_vertex>","	#include <skinning_vertex>","	#include <project_vertex>","	#include <logdepthbuf_vertex>","	#include <clipping_planes_vertex>","	#include <worldpos_vertex>","	#include <envmap_vertex>","	#include <lights_lambert_vertex>","	#include <shadowmap_vertex>","vWorldPosition = worldPosition.xyz;","}"].join("\n"),vertexShader_r63:["varying vec3 vWorldPosition;","#define LAMBERT","varying vec3 vLightFront;","varying vec3 vLightingOnly;","#ifdef DOUBLE_SIDED","varying vec3 vLightBack;","#endif",THREE.ShaderChunk.map_pars_vertex,THREE.ShaderChunk.lightmap_pars_vertex,THREE.ShaderChunk.envmap_pars_vertex,THREE.ShaderChunk.lights_lambert_pars_vertex,THREE.ShaderChunk.color_pars_vertex,THREE.ShaderChunk.morphtarget_pars_vertex,THREE.ShaderChunk.skinning_pars_vertex,THREE.ShaderChunk.shadowmap_pars_vertex,"void main() {",THREE.ShaderChunk.map_vertex,THREE.ShaderChunk.lightmap_vertex,THREE.ShaderChunk.color_vertex,THREE.ShaderChunk.morphnormal_vertex,THREE.ShaderChunk.skinbase_vertex,THREE.ShaderChunk.skinnormal_vertex,THREE.ShaderChunk.defaultnormal_vertex,THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.skinning_vertex,THREE.ShaderChunk.default_vertex,THREE.ShaderChunk.worldpos_vertex,THREE.ShaderChunk.envmap_vertex,"vLightFront = vec3( 0.0 );","#ifdef DOUBLE_SIDED","vLightBack = vec3( 0.0 );","#endif","transformedNormal = normalize( transformedNormal );","#if MAX_DIR_LIGHTS > 0","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","float dotProduct = dot( transformedNormal, dirVector );","vec3 directionalLightWeighting = vec3( max( dotProduct, 0.0 ) );","#ifdef DOUBLE_SIDED","vec3 directionalLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );","#ifdef WRAP_AROUND","vec3 directionalLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );","#endif","#endif","#ifdef WRAP_AROUND","vec3 directionalLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );","directionalLightWeighting = mix( directionalLightWeighting, directionalLightWeightingHalf, wrapRGB );","#ifdef DOUBLE_SIDED","directionalLightWeightingBack = mix( directionalLightWeightingBack, directionalLightWeightingHalfBack, wrapRGB );","#endif","#endif","vLightFront += directionalLightColor[ i ] * directionalLightWeighting;","#ifdef DOUBLE_SIDED","vLightBack += directionalLightColor[ i ] * directionalLightWeightingBack;","#endif","}","#endif","#if MAX_POINT_LIGHTS > 0","for( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","float dotProduct = dot( transformedNormal, lVector );","vec3 pointLightWeighting = vec3( max( dotProduct, 0.0 ) );","#ifdef DOUBLE_SIDED","vec3 pointLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );","#ifdef WRAP_AROUND","vec3 pointLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );","#endif","#endif","#ifdef WRAP_AROUND","vec3 pointLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );","pointLightWeighting = mix( pointLightWeighting, pointLightWeightingHalf, wrapRGB );","#ifdef DOUBLE_SIDED","pointLightWeightingBack = mix( pointLightWeightingBack, pointLightWeightingHalfBack, wrapRGB );","#endif","#endif","vLightFront += pointLightColor[ i ] * pointLightWeighting * lDistance;","#ifdef DOUBLE_SIDED","vLightBack += pointLightColor[ i ] * pointLightWeightingBack * lDistance;","#endif","}","#endif","#if MAX_SPOT_LIGHTS > 0","for( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - worldPosition.xyz ) );","if ( spotEffect > spotLightAngleCos[ i ] ) {","spotEffect = max( pow( spotEffect, spotLightExponent[ i ] ), 0.0 );","float lDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","float dotProduct = dot( transformedNormal, lVector );","vec3 spotLightWeighting = vec3( max( dotProduct, 0.0 ) );","#ifdef DOUBLE_SIDED","vec3 spotLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );","#ifdef WRAP_AROUND","vec3 spotLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );","#endif","#endif","#ifdef WRAP_AROUND","vec3 spotLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );","spotLightWeighting = mix( spotLightWeighting, spotLightWeightingHalf, wrapRGB );","#ifdef DOUBLE_SIDED","spotLightWeightingBack = mix( spotLightWeightingBack, spotLightWeightingHalfBack, wrapRGB );","#endif","#endif","vLightFront += spotLightColor[ i ] * spotLightWeighting * lDistance * spotEffect;","#ifdef DOUBLE_SIDED","vLightBack += spotLightColor[ i ] * spotLightWeightingBack * lDistance * spotEffect;","#endif","}","}","#endif","#if MAX_HEMI_LIGHTS > 0","for( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( hemisphereLightDirection[ i ], 0.0 );","vec3 lVector = normalize( lDirection.xyz );","float dotProduct = dot( transformedNormal, lVector );","float hemiDiffuseWeight = 0.5 * dotProduct + 0.5;","float hemiDiffuseWeightBack = -0.5 * dotProduct + 0.5;","vLightFront += mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );","#ifdef DOUBLE_SIDED","vLightBack += mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeightBack );","#endif","}","#endif","vLightingOnly = vLightFront;","vLightFront = vLightFront * diffuse + ambient * ambientLightColor + emissive;","#ifdef DOUBLE_SIDED","vLightBack = vLightBack * diffuse + ambient * ambientLightColor + emissive;","#endif",THREE.ShaderChunk.shadowmap_vertex,"vWorldPosition = worldPosition.xyz;","}"].join("\n"),fragmentShader:["varying vec3 vWorldPosition;","uniform vec2 lowerLeft;","uniform vec2 upperRight;","uniform sampler2D tOverlay;","uniform vec3 diffuse;","uniform vec3 emissive;","uniform float opacity;","varying vec3 vLightFront;","#ifdef DOUBLE_SIDED","	varying vec3 vLightBack;","#endif","#include <common>","#include <packing>","#include <color_pars_fragment>","#include <uv_pars_fragment>","#include <uv2_pars_fragment>","#include <map_pars_fragment>","#include <alphamap_pars_fragment>","#include <aomap_pars_fragment>","#include <lightmap_pars_fragment>","#include <emissivemap_pars_fragment>","#include <envmap_pars_fragment>","#include <bsdfs>","#include <lights_pars>","#include <fog_pars_fragment>","#include <shadowmap_pars_fragment>","#include <shadowmask_pars_fragment>","#include <specularmap_pars_fragment>","#include <logdepthbuf_pars_fragment>","#include <clipping_planes_pars_fragment>","void main() {","	#include <clipping_planes_fragment>","	vec4 diffuseColor = vec4( diffuse, opacity );","	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );","	vec3 totalEmissiveRadiance = emissive;","	#include <logdepthbuf_fragment>","	#include <map_fragment>","	#include <color_fragment>","	#include <alphamap_fragment>","	#include <alphatest_fragment>","	#include <specularmap_fragment>","	#include <emissivemap_fragment>","	// accumulation","	reflectedLight.indirectDiffuse = getAmbientLightIrradiance( ambientLightColor );","   vec3 mca_indirectDiffuse = reflectedLight.indirectDiffuse;","	#include <lightmap_fragment>","   mca_indirectDiffuse *= BRDF_Diffuse_Lambert( vec3(1.0) );","	reflectedLight.indirectDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb );","	#ifdef DOUBLE_SIDED","		reflectedLight.directDiffuse = ( gl_FrontFacing ) ? vLightFront : vLightBack;","	#else","		reflectedLight.directDiffuse = vLightFront;","	#endif","   vec3 mca_directDiffuse = reflectedLight.directDiffuse;","	mca_directDiffuse *= BRDF_Diffuse_Lambert( vec3(1.0) ) * getShadowMask();","	reflectedLight.directDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb ) * getShadowMask();","	// modulation","	#include <aomap_fragment>","	vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;","   vec3 mca_outgoingLight = mca_directDiffuse + mca_indirectDiffuse + totalEmissiveRadiance;","	#include <envmap_fragment>","	gl_FragColor = vec4( outgoingLight, diffuseColor.a );","	#include <premultiplied_alpha_fragment>","	#include <tonemapping_fragment>","	#include <encodings_fragment>","	#include <fog_fragment>","if(vWorldPosition.x >= lowerLeft.x && vWorldPosition.x <= upperRight.x && -vWorldPosition.z >= lowerLeft.y && -vWorldPosition.z <= upperRight.y)","{","vec2 worldPosGeo = vec2(vWorldPosition.x, -vWorldPosition.z);","vec4 tColor = texture2D(tOverlay,  (worldPosGeo-lowerLeft) / (upperRight - lowerLeft));","gl_FragColor =  mix(gl_FragColor,vec4(tColor.rgb * (mca_outgoingLight), opacity), tColor.a);","}","}"].join("\n"),fragmentShader_r63:["varying vec3 vWorldPosition;","uniform vec2 lowerLeft;","uniform vec2 upperRight;","uniform sampler2D tOverlay;","uniform vec3 ambient;","uniform vec3 diffuse;","uniform vec3 emissive;","uniform vec3 ambientLightColor;","uniform float opacity;","varying vec3 vLightFront;","varying vec3 vLightingOnly;","#ifdef DOUBLE_SIDED","varying vec3 vLightBack;","#endif",THREE.ShaderChunk.color_pars_fragment,THREE.ShaderChunk.map_pars_fragment,THREE.ShaderChunk.lightmap_pars_fragment,THREE.ShaderChunk.envmap_pars_fragment,THREE.ShaderChunk.fog_pars_fragment,THREE.ShaderChunk.shadowmap_pars_fragment,THREE.ShaderChunk.specularmap_pars_fragment,"void main() {","gl_FragColor = vec4( vec3 ( 1.0 ), opacity );",THREE.ShaderChunk.map_fragment,THREE.ShaderChunk.alphatest_fragment,THREE.ShaderChunk.specularmap_fragment,"#ifdef DOUBLE_SIDED","if ( gl_FrontFacing )","gl_FragColor.xyz *= vLightFront;","else","gl_FragColor.xyz *= vLightBack;","#else","gl_FragColor.xyz *= vLightFront;","#endif",THREE.ShaderChunk.lightmap_fragment,"#ifdef USE_COLOR","gl_FragColor = gl_FragColor * vec4( vColor, opacity );","#endif",THREE.ShaderChunk.envmap_fragment,THREE.ShaderChunk.shadowmap_fragment,THREE.ShaderChunk.linear_to_gamma_fragment,THREE.ShaderChunk.fog_fragment,"if(vWorldPosition.x >= lowerLeft.x && vWorldPosition.x <= upperRight.x && -vWorldPosition.z >= lowerLeft.y && -vWorldPosition.z <= upperRight.y)","{","vec2 worldPosGeo = vec2(vWorldPosition.x, -vWorldPosition.z);","vec4 tColor = texture2D(tOverlay,  (worldPosGeo-lowerLeft) / (upperRight - lowerLeft));","gl_FragColor =  mix(gl_FragColor,vec4(tColor.rgb * (vLightingOnly + ambientLightColor + emissive), opacity), tColor.a);","}","}"].join("\n")};THREE.ShaderMaterial.call(this,r)},GIScene.RasterOverlayMaterial.prototype=Object.create(THREE.ShaderMaterial.prototype),GIScene.RasterOverlayMaterial.prototype.setUpperRight=function(e){this.upperRight=e.sub(this.offset2),this.uniforms.upperRight.value=this.upperRight},GIScene.RasterOverlayMaterial.prototype.setLowerLeft=function(e){this.lowerLeft=e.sub(this.offset2),this.uniforms.lowerLeft.value=this.lowerLeft},GIScene.RasterOverlayMaterial.prototype.setTexture=function(e){this.texture=this.uniforms.tOverlay.value=e,this.dispatchEvent({type:"settexture",content:{texture:e}})},GIScene.RasterOverlayMaterial.prototype.setTextureFromUrl=function(e,t,i){this.crossOrigin=t?t:this.crossOrigin,this.url=e;var n=new THREE.TextureLoader;n.setCrossOrigin(this.crossOrigin);var r=function(e){i&&i(),this.setTexture(e)}.bind(this);n.load(this.url,r)},GIScene.RasterOverlayMaterial.prototype.setOffset2=function(e){var t=this.offset2;this.offset2=e,this.setLowerLeft(this.lowerLeft.add(t)),this.setUpperRight(this.upperRight.add(t))},GIScene.RasterOverlayMaterial.prototype.clone=function(){var e=new GIScene.RasterOverlayMaterial;return e.config=GIScene.Utils.mergeObjects(e.config,this.config),e.url=this.url,e.crossOrigin=this.crossOrigin,e.offset2=this.offset2,e.lowerLeft=this.lowerLeft,e.upperRight=this.upperRight,e.texture=this.texture,e.uniforms.lowerLeft.value=this.uniforms.lowerLeft.value,e.uniforms.upperRight.value=this.uniforms.upperRight.value,e.uniforms.tOverlay.value=this.uniforms.tOverlay.value,e},GIScene.WMSOverlayMaterial=function(e,t){GIScene.RasterOverlayMaterial.apply(this,[e]);var i={wmsServiceUrl:"",crossOrigin:"anonymous"},n={service:"WMS",request:"GetMap",version:"1.1.1",format:"image/png",srs:"EPSG:32616",layers:null,styles:"",bbox:null,width:"256",height:"256"};this.config=GIScene.Utils.mergeObjects(i,e||{}),this.params=GIScene.Utils.mergeObjects(n,t||{}),this.wmsServiceUrl=""==this.config.wmsServiceUrl?"":this.config.wmsServiceUrl.trim().replace(/(\/|\?)*$/,"?"),this.params.bbox&&this.setLLURFromBboxParam(),""==!this.config.wmsServiceUrl&&this.setTextureFromUrl(this.getGetMapUrl(),this.config.crossOrigin)},GIScene.WMSOverlayMaterial.prototype=Object.create(GIScene.RasterOverlayMaterial.prototype),GIScene.WMSOverlayMaterial.prototype.setBboxParamFromLLUR=function(){this.params.bbox=""+this.lowerLeft.clone().add(this.offset2).toArray()+","+(""+this.upperRight.clone().add(this.offset2).toArray())},GIScene.WMSOverlayMaterial.prototype.setLLURFromBboxParam=function(){var e=this.params.bbox.split(",");this.setLowerLeft(new GIScene.Coordinate2(e[0],e[1])),this.setUpperRight(new GIScene.Coordinate2(e[2],e[3]))},GIScene.WMSOverlayMaterial.prototype.getGetMapUrl=function(){this.params.bbox||this.setBboxParamFromLLUR();var e=[this.wmsServiceUrl,"SERVICE="+this.params.service,"REQUEST="+this.params.request,"VERSION="+this.params.version,"FORMAT="+this.params.format,"SRS="+this.params.srs,"LAYERS="+this.params.layers,"STYLES="+this.params.styles,"BBOX="+this.params.bbox,"WIDTH="+this.params.width,"HEIGHT="+this.params.height].join("&");return e},GIScene.WMSOverlayMaterial.prototype.clone=function(){var e=new GIScene.WMSOverlayMaterial;return e.config=GIScene.Utils.mergeObjects(e.config,this.config),e.params=GIScene.Utils.mergeObjects(e.params,this.params),e.wmsServiceUrl=this.wmsServiceUrl,e.url=this.url,e.crossOrigin=this.crossOrigin,e.offset2=this.offset2,e.lowerLeft=this.lowerLeft,e.upperRight=this.upperRight,e.texture=this.texture,e.uniforms.lowerLeft.value=this.uniforms.lowerLeft.value,e.uniforms.upperRight.value=this.uniforms.upperRight.value,e.uniforms.tOverlay.value=this.uniforms.tOverlay.value,e},GIScene.PointAlignmentMaterial=function(e,t,i){var n=e||new THREE.Vector3(0,0,0),r=t||15,a=i||5,o=new THREE.Color(0);Object.defineProperty(this,"point",{get:function(){return n},set:function(e){n=e,this.uniforms.uPoint.value=e}}),Object.defineProperty(this,"maxDeviationDeg",{get:function(){return r},set:function(e){r=e,this.uniforms.maxDeviationDeg.value=e}}),Object.defineProperty(this,"maxUpDeviationDeg",{get:function(){return a},set:function(e){a=e,this.uniforms.maxUpDeviationDeg.value=e}}),Object.defineProperty(this,"emissive",{get:function(){return o},set:function(e){o=e,this.uniforms.emissive.value=e}});var s={uniforms:{opacity:{type:"f",value:1},uPoint:{type:"v3",value:this.point},maxDeviationDeg:{type:"f",value:this.maxDeviationDeg},maxUpDeviationDeg:{type:"f",value:this.maxUpDeviationDeg},emissive:{type:"c",value:this.emissive}},vertexShader:["varying vec3 vNormal;","varying vec3 vWorldPosition;","uniform vec3 emissive;",THREE.ShaderChunk.morphtarget_pars_vertex,"void main() {","vNormal = normalize(  normal );",THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.default_vertex,"vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","vWorldPosition = worldPosition.xyz;","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform vec3 uPoint;","uniform float maxDeviationDeg;","uniform float maxUpDeviationDeg;","uniform vec3 emissive;","varying vec3 vNormal;","varying vec3 vWorldPosition;","float red;","float maxDeviation;","float maxUpDeviation;","const float M_PI = 3.14159265358979323846;","vec3 hDir;","uniform mat4 modelMatrix;","void main() {","vec3 worldNormal = mat3( modelMatrix[ 0 ].xyz, modelMatrix[ 1 ].xyz, modelMatrix[ 2 ].xyz ) * vNormal;","worldNormal = normalize( worldNormal );","maxDeviation = maxDeviationDeg * (M_PI / 180.0);","maxUpDeviation = maxUpDeviationDeg * (M_PI / 180.0);","float upDeviation = acos(dot(normalize(worldNormal), vec3(0.0,1.0,0.0)));","if (upDeviation < maxUpDeviation || upDeviation > M_PI - maxUpDeviation)","{","gl_FragColor = vec4( vec3(0.5)+emissive, opacity );","}","else","{","vec3 direction = uPoint-vWorldPosition;","vec3 hDirection = direction - ( dot(direction, vec3(0.0,1.0,0.0)) * vec3(0.0,1.0,0.0));","vec3 hNormalDirection = worldNormal -  ( dot(worldNormal, vec3(0.0,1.0,0.0)) * vec3(0.0,1.0,0.0));","float angle = acos(dot(normalize(hNormalDirection), normalize(hDirection)));","red = (maxDeviation - angle) / maxDeviation;","gl_FragColor = vec4( vec3(1.0,1.0-red,1.0-red) + emissive, opacity );","}","}"].join("\n")};THREE.ShaderMaterial.call(this,s),this.point=e||new THREE.Vector3(0,0,0),this.maxDeviationDeg=t||15,this.maxUpDeviationDeg=i||5,this.emissive=new THREE.Color(0)},GIScene.PointAlignmentMaterial.prototype=Object.create(THREE.ShaderMaterial.prototype),GIScene.PointAlignmentMaterial.prototype.clone=function(){var e=new GIScene.PointAlignmentMaterial;return THREE.ShaderMaterial.prototype.clone.call(this,e),e.point=this.point.clone(),e.maxDeviationDeg=this.maxDeviationDeg,e.maxUpDeviationDeg=this.maxUpDeviationDeg,e.emissive=this.emissive,e},GIScene.OverrideMaterialHandler=function(e){this.object=e.content.object,this.overrideMaterial=e.content.overrideMaterial,this.layer=e.content.layer},GIScene.OverrideMaterialHandler.WMS=function(e){if(GIScene.OverrideMaterialHandler.apply(this,[e]),this.overrideMaterial instanceof GIScene.WMSOverlayMaterial&&this.object.geometry){var t=function(){n.uniforms.lowerLeft.value=n.lowerLeft,n.uniforms.upperRight.value=n.upperRight,n.unsharedWmsTextureLoaded=!0}.bind(this),i=(new GIScene.Extent2).fromBox3((new THREE.Box3).setFromObject(this.object)),n=this.overrideMaterial.clone();n.waitForTexture=!0,n.lowerLeft=i.min,n.upperRight=i.max,n.isShared=!1,n.setBboxParamFromLLUR(),this.object.material=n,n.setTextureFromUrl(n.getGetMapUrl(),n.config.crossOrigin,t)}},GIScene.OverrideMaterialHandler.WMS.prototype=Object.create(GIScene.OverrideMaterialHandler.prototype),GIScene.Control=function(){this.scene=null,this.isActive=!1},GIScene.Control.prototype={constructor:GIScene.Control,setScene:function(e){this.scene=e},activate:function(){this.isActive=!0},deactivate:function(){this.isActive=!1},addEventListener:THREE.EventDispatcher.prototype.addEventListener,hasEventListener:THREE.EventDispatcher.prototype.hasEventListener,removeEventListener:THREE.EventDispatcher.prototype.removeEventListener,dispatchEvent:THREE.EventDispatcher.prototype.dispatchEvent},GIScene.Control.Select=function(e,t,i){GIScene.Control.call(this);var n={highlightOnly:!1,hover:!1,clickout:!0,multi:!1,toggle:!0,selectColor:16776960};this.config=GIScene.Utils.mergeObjects(n,i||{}),this.selectables=e instanceof Array?e:e instanceof THREE.Object3D?[e]:[],this.camera=t,this.domElement=null,this.hitObject=null;var r=new THREE.Raycaster,a=new THREE.Vector3(0,0,1),o=!1;this.selectedObjects=[],this.highlightedOnlyObjects=[],this.getHitObject=function(e){r.setFromCamera(e,this.camera.activeCam);for(var t,i=r.intersectObjects(this.selectables),n=0;i.length>n;n++)if(i[n].object.geometry&&i[n].object.visible&&(i[n].object.material.opacity?i[n].object.material.opacity>0:!0)){t=i[n].object;break}return t},this.highlight=function(e,t){e.userData.isHighlighted?this.config.toggle&&this.unhighlight(e,t):(e.userData.isHighlighted=!0,GIScene.Utils.WorkingMaterial.setSelectColor(e,new THREE.Color(this.config.selectColor)),this.config.highlightOnly&&this.highlightedOnlyObjects.push(e),this.dispatchEvent({type:"highlighted",content:e}),t&&this.dispatchEvent({type:"highlightedbyuser",content:e}))},this.unhighlight=function(e,t){e.userData.isSelected||(GIScene.Utils.WorkingMaterial.setSelectColor(e,"default"),e.userData.isHighlighted=!1);for(var i=0;this.highlightedOnlyObjects.length>i;i++)if(e===this.highlightedOnlyObjects[i]){this.highlightedOnlyObjects.splice(i,1);break}this.dispatchEvent({type:"unhighlighted",content:e}),t&&this.dispatchEvent({type:"unhighlightedbyuser",content:e})},this.select=function(e,t){e.userData.isSelected?this.config.toggle&&this.unselect(e,t):(e.userData.isSelected=!0,this.selectedObjects.push(e),this.dispatchEvent({type:"selected",content:e}),t&&this.dispatchEvent({type:"selectedbyuser",content:e}),this.highlight(e))},this.unselect=function(e,t){e.userData.isSelected=!1,this.unhighlight(e);for(var i=0;this.selectedObjects.length>i;i++)if(e===this.selectedObjects[i]){this.selectedObjects.splice(i,1);break}this.dispatchEvent({type:"unselected",content:e}),t&&this.dispatchEvent({type:"unselectedbyuser",content:e})},this.removeSelectable=function(e){e.userData.isHighlighted&&this.unselect(e);for(var t=[],i=0,n=this.selectables.length;n>i;i++)this.selectables[i]!==e&&t.push(this.selectables[i]);this.selectables=t};var s=function(e){this.removeSelectable(e.content)}.bind(this),c=function(e){e.preventDefault();var t=GIScene.Utils.getViewportCoordsFromDOMEvent(this.domElement,e);a.set(t.x,t.y,1);var i=this.getHitObject(a);this.config.hover&&(this.config.toggle=!1,this.config.clickout=!0,this.config.multi=!1),i?this.config.multi&&e.ctrlKey?this.config.highlightOnly?(!i.userData.isHighlighted||this.config.toggle)&&this.highlight(i,!0):(!i.userData.isSelected||this.config.toggle)&&this.select(i,!0):this.config.highlightOnly?(this.highlightedOnlyObjects.length>0&&this.unhighlightAll(!0),(!i.userData.isHighlighted||this.config.toggle)&&this.highlight(i,!0)):(!this.config.hover&&this.selectedObjects.length>0?this.unselectAll(!0):this.selectedObjects[0]&&this.selectedObjects[0]!==i&&this.unselect(this.selectedObjects[0],!0),(!i.userData.isSelected||this.config.toggle)&&this.select(i,!0)):this.config.clickout&&(this.config.highlightOnly?this.unhighlightAll(!0):this.unselectAll(!0))}.bind(this),l=function(e){if(this.config.hover)this.domElement.removeEventListener("mousemove",c,!1);else{var t=GIScene.Utils.getViewportCoordsFromDOMEvent(this.domElement,e);a.set(t.x,t.y,1)}}.bind(this),h=function(e){if(this.config.hover)this.domElement.addEventListener("mousemove",c,!1);else{var t=a.clone(),i=GIScene.Utils.getViewportCoordsFromDOMEvent(this.domElement,e);a.set(i.x,i.y,1),setTimeout(function(){console.log(o),o&&d++,a.equals(t)&&!o&&c(e),d>1&&(o=!1,d=0)}.bind(this),250)}}.bind(this),d=0,u=function(){o=!0}.bind(this);this.activate=function(){this.isActive||(this.domElement=this.scene.canvas,this.domElement.addEventListener("mousedown",l,!1),this.domElement.addEventListener("mouseup",h,!1),this.domElement.addEventListener("dblclick",u,!1),this.config.hover&&this.domElement.addEventListener("mousemove",c,!1),this.scene.addEventListener("beforeDisposeObject",s),GIScene.Control.prototype.activate.call(this))},this.deactivate=function(){this.isActive&&(this.domElement.removeEventListener("mousedown",l,!1),this.domElement.removeEventListener("mouseup",h,!1),this.config.hover&&this.domElement.removeEventListener("mousemove",c,!1),this.scene.removeEventListener("beforeDisposeObject",s),GIScene.Control.prototype.deactivate.call(this))}},GIScene.Control.Select.prototype=Object.create(GIScene.Control.prototype),GIScene.Control.Select.prototype.unhighlightAll=function(e){var t=this.highlightedOnlyObjects.slice(0);t.forEach(function(i,n){this.unhighlight(t[n],e)}.bind(this)),t=null,this.dispatchEvent({type:"unhighlightall"}),e&&this.dispatchEvent({type:"unhighlightallbyuser"})},GIScene.Control.Select.prototype.unselectAll=function(e){var t=this.selectedObjects.slice(0);t.forEach(function(i,n){this.unselect(t[n],e)}.bind(this)),t=null,this.dispatchEvent({type:"unselectall"}),e&&this.dispatchEvent({type:"unselectallbyuser"})},GIScene.Control.Pan=function(e,t){GIScene.Control.call(this),THREE.EventDispatcher.call(this),STATE={NONE:-1,PAN:0};var i=this;this.object=e,this.domElement=void 0!==t?t:document,this.panSpeed=.825,this.target=new THREE.Vector3,new THREE.Vector3;var n=STATE.NONE,r=new THREE.Vector3,a=new THREE.Vector2,o=new THREE.Vector2;this.panCamera=function(){var e=o.clone().sub(a);if(e.lengthSq()){e.multiplyScalar(r.length()*i.panSpeed);var t=r.clone().cross(i.object.up).setLength(e.x);t.add(i.object.up.clone().setLength(e.y)),i.object.position.add(t),i.target.add(t),a=o}},this.update=function(){r.copy(i.object.position).sub(i.target),i.panCamera(),i.object.position.Vectors(i.target,r),i.object.lookAt(i.target)},mousedown=function(e){n=STATE.PAN,a=o=new THREE.Vector2(e.clientX,e.clientY).multiplyScalar(.002)},mousemove=function(e){n==STATE.PAN&&(o=new THREE.Vector2(e.clientX,e.clientY).multiplyScalar(.002))},mouseup=function(){n=STATE.NONE},this.activate=function(){this.isActive||(this.domElement.addEventListener("mousedown",mousedown,!1),this.domElement.addEventListener("mousemove",mousemove,!1),this.domElement.addEventListener("mouseup",mouseup,!1),GIScene.Control.prototype.activate.call(this))},this.deactivate=function(){this.isActive&&(this.domElement.removeEventListener("mousedown",mousedown,!1),this.domElement.removeEventListener("mousemove",mousemove,!1),this.domElement.removeEventListener("mouseup",mouseup,!1),GIScene.Control.prototype.deactivate.call(this))}},GIScene.Control.OrbitZoomPan=function(e,t){function i(){return 2*Math.PI/60/60*c.autoRotateSpeed}function n(){return Math.pow(.95,c.userZoomSpeed)}function r(e){c.dispatchEvent({type:"beforechange"}),c.userRotate&&(e.preventDefault(),0===e.button?(M=w.ROTATE,d.set(e.clientX,e.clientY)):1===e.button?(M=w.ZOOM,m.set(e.clientX,e.clientY)):2===e.button&&(M=w.PAN,E=y=new THREE.Vector2(e.clientX,e.clientY).multiplyScalar(.002)),document.addEventListener("mousemove",a,!1),document.addEventListener("mouseup",o,!1))}function a(e){e.preventDefault(),M===w.ROTATE?(u.set(e.clientX,e.clientY),f.subVectors(u,d),c.rotateLeft(2*Math.PI*f.x/h*c.userRotateSpeed),c.rotateUp(2*Math.PI*f.y/h*c.userRotateSpeed),d.copy(u)):M===w.ZOOM?(p.set(e.clientX,e.clientY),v.subVectors(p,m),v.y>0?c.zoomIn():c.zoomOut(),m.copy(p)):M===w.PAN&&(y=new THREE.Vector2(e.clientX,e.clientY).multiplyScalar(.002))}function o(){c.userRotate&&(document.removeEventListener("mousemove",a,!1),document.removeEventListener("mouseup",o,!1),M=w.NONE,c.dispatchEvent({type:"afterchange"}))}function s(e){c.userZoom&&(e.wheelDelta&&e.wheelDelta>0||e.detail&&e.detail>0?c.zoomOut():c.zoomIn())}GIScene.Control.call(this),this.object=e,this.domElement=void 0!==t?t:document,this.center=null,this.userZoom=!0,this.userZoomSpeed=1,this.userRotate=!0,this.userRotateSpeed=1,this.autoRotate=!1,this.autoRotateSpeed=2,this.userPan=!0,this.userPanSpeed=.825;var c=this,l=1e-6,h=1800,d=new THREE.Vector2,u=new THREE.Vector2,f=new THREE.Vector2,m=new THREE.Vector2,p=new THREE.Vector2,v=new THREE.Vector2,g=new THREE.Vector3,E=new THREE.Vector2,y=new THREE.Vector2,S=0,b=0,T=1,R=new THREE.Vector3,w={NONE:-1,ROTATE:0,ZOOM:1,PAN:2},M=w.NONE,I={type:"change"};this.rotateLeft=function(e){void 0===e&&(e=i()),b-=e},this.rotateRight=function(e){void 0===e&&(e=i()),b+=e},this.rotateUp=function(e){void 0===e&&(e=i()),S-=e},this.rotateDown=function(e){void 0===e&&(e=i()),S+=e},this.zoomIn=function(e){void 0===e&&(e=n()),T/=e},this.zoomOut=function(e){void 0===e&&(e=n()),T*=e},this.panCamera=function(){var e=y.clone().sub(E);if(e.lengthSq()){e.multiplyScalar(g.length()*c.userPanSpeed);var t=g.clone().cross(c.object.up).setLength(e.x);t.sub(g.clone().cross(g.clone().cross(c.object.up)).setLength(e.y)),c.object.position.add(t),c.center.clone(),c.center.add(t),E=y}},this.update=function(){if(M!=w.PAN){var e=this.object.position,t=e.clone().sub(this.center),n=Math.atan2(t.x,t.z),r=Math.atan2(Math.sqrt(t.x*t.x+t.z*t.z),t.y);this.autoRotate&&this.rotateLeft(i()),n+=b,r+=S,r=Math.max(l,Math.min(Math.PI-l,r));var a=t.length();t.x=a*Math.sin(r)*Math.sin(n),t.y=a*Math.cos(r),t.z=a*Math.sin(r)*Math.cos(n),t.multiplyScalar(T),this.object.inOrthographicMode&&this.object.toOrthographic(),e.copy(this.center).add(t),this.object.lookAt(this.center),b=0,S=0,T=1}else g.copy(c.object.position).sub(c.center),c.panCamera(),c.object.position.addVectors(c.center,g);R.distanceTo(this.object.position)>0&&(this.dispatchEvent(I),R.copy(this.object.position))}.bind(this);var L=function(e){this.center=e.content.center}.bind(this),A=function(e){this.scene.center=e.target.center.clone(),this.object.target.position.setZ(-this.object.position.distanceTo(e.target.center))};this.activate=function(){if(!this.isActive){this.center=this.scene.center.clone(),this.object.up.set(0,1,0);var e=new THREE.Vector3(0,0,-1);e.applyQuaternion(this.object.quaternion),e.normalize(),.01>this.center.distanceTo(this.object.position)&&this.object.position.sub(e.multiplyScalar(.01)),this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousedown",r,!1),this.domElement.addEventListener("mousewheel",s,!1),this.domElement.addEventListener("DOMMouseScroll",s,!1),this.addEventListener("change",A),this.scene.addEventListener("center",L),this.scene.addEventListener("beforeRender",this.update),GIScene.Control.prototype.activate.call(this)}},this.deactivate=function(){this.isActive&&(this.domElement.removeEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.removeEventListener("mousedown",r,!1),this.domElement.removeEventListener("mousewheel",s,!1),this.domElement.removeEventListener("DOMMouseScroll",s,!1),this.addEventListener("change",A),this.scene.removeEventListener("center",L),this.scene.removeEventListener("beforeRender",this.update),GIScene.Control.prototype.deactivate.call(this))
}},GIScene.Control.OrbitZoomPan.prototype=Object.create(GIScene.Control.prototype),GIScene.Control.PanOrbitZoomCenter=function(e,t){function i(){return 2*Math.PI/60/60*c.autoRotateSpeed}function n(){return Math.pow(.95,c.userZoomSpeed)}function r(e){c.dispatchEvent({type:"beforechange"}),c.userRotate&&(e.preventDefault(),e.button===I.ROTATE?(L=I.ROTATE,d.set(e.clientX,e.clientY)):e.button===I.ZOOM?(L=I.ZOOM,m.set(e.clientX,e.clientY)):e.button===I.PAN&&(L=I.PAN,E=y=new THREE.Vector2(e.clientX,e.clientY).multiplyScalar(.002)),document.addEventListener("mousemove",a,!1),document.addEventListener("mouseup",o,!1))}function a(e){e.preventDefault(),L===I.ROTATE?(u.set(e.clientX,e.clientY),f.subVectors(u,d),c.rotateLeft(2*Math.PI*f.x/h*c.userRotateSpeed),c.rotateUp(2*Math.PI*f.y/h*c.userRotateSpeed),d.copy(u)):L===I.ZOOM?(p.set(e.clientX,e.clientY),v.subVectors(p,m),v.y>0?c.zoomIn():c.zoomOut(),m.copy(p)):L===I.PAN&&(y=new THREE.Vector2(e.clientX,e.clientY).multiplyScalar(.002))}function o(){c.userRotate&&(document.removeEventListener("mousemove",a,!1),document.removeEventListener("mouseup",o,!1),L=I.NONE,c.dispatchEvent({type:"afterchange"}))}function s(e){c.userZoom&&(e.wheelDelta&&e.wheelDelta>0||e.detail&&e.detail>0?c.zoomOut():c.zoomIn())}GIScene.Control.call(this),this.object=e,this.domElement=void 0!==t?t:document.body,this.center=null,this.userZoom=!0,this.userZoomSpeed=1,this.userRotate=!0,this.userRotateSpeed=1,this.autoRotate=!1,this.autoRotateSpeed=2,this.userPan=!0,this.userPanSpeed=.825;var c=this,l=1e-6,h=1800,d=new THREE.Vector2,u=new THREE.Vector2,f=new THREE.Vector2,m=new THREE.Vector2,p=new THREE.Vector2,v=new THREE.Vector2,g=new THREE.Vector3,E=new THREE.Vector2,y=new THREE.Vector2,S=new THREE.Vector3,b=new THREE.Raycaster,T=0,R=0,w=1,M=new THREE.Vector3,I={NONE:-1,ROTATE:0,ZOOM:1,PAN:2},L=I.NONE,A={type:"change"};this.rotateLeft=function(e){void 0===e&&(e=i()),R-=e},this.rotateRight=function(e){void 0===e&&(e=i()),R+=e},this.rotateUp=function(e){void 0===e&&(e=i()),T-=e},this.rotateDown=function(e){void 0===e&&(e=i()),T+=e},this.zoomIn=function(e){void 0===e&&(e=n()),w/=e},this.zoomOut=function(e){void 0===e&&(e=n()),w*=e},this.panCamera=function(){var e=y.clone().sub(E);if(e.lengthSq()){e.multiplyScalar(g.length()*c.userPanSpeed);var t=g.clone().cross(c.object.up).setLength(e.x);t.sub(g.clone().cross(g.clone().cross(c.object.up)).setLength(e.y)),c.object.position.add(t),c.center.clone(),c.center.add(t),E=y}},this.update=function(){if(L!=I.PAN){var e=this.object.position,t=e.clone().sub(this.center),n=Math.atan2(t.x,t.z),r=Math.atan2(Math.sqrt(t.x*t.x+t.z*t.z),t.y);this.autoRotate&&this.rotateLeft(i()),n+=R,r+=T,r=Math.max(l,Math.min(Math.PI-l,r));var a=t.length();t.x=a*Math.sin(r)*Math.sin(n),t.y=a*Math.cos(r),t.z=a*Math.sin(r)*Math.cos(n),t.multiplyScalar(w),this.object.inOrthographicMode&&this.object.toOrthographic(),e.copy(this.center).add(t),this.object.lookAt(this.center),R=0,T=0,w=1}else g.copy(c.object.position).sub(c.center),c.panCamera(),c.object.position.addVectors(c.center,g);M.distanceTo(this.object.position)>0&&(this.dispatchEvent(A),M.copy(this.object.position))}.bind(this);var x=function(e){e.preventDefault();var t=GIScene.Utils.getViewportCoordsFromDOMEvent(this.scene.containerDiv,e);S.set(t.x,t.y,1);var i=this.object instanceof THREE.CombinedCamera?this.object.activeCam:this.object;b.setFromCamera(S,i);for(var n,r=GIScene.Utils.getDescendants(this.scene.root).filter(function(e){return e.geometry}),a=b.intersectObjects(r),o=0;a.length>o;o++)if(a[o].object.geometry&&a[o].object.visible){n=a[o];break}if(n){var s=function(){this.scene.removeEventListener("center",s),this.scene.addEventListener("beforeRender",this.update)}.bind(this);this.scene.addEventListener("center",s),this.scene.removeEventListener("beforeRender",this.update),this.scene.setCenter(n.point,this.object.position.clone().sub(this.center),500)}}.bind(this),C=function(e){this.center=e.content.center}.bind(this),D=function(e){this.scene.center=e.target.center.clone(),this.object.target.position.setZ(-this.object.position.distanceTo(e.target.center))};this.activate=function(){if(!this.isActive){this.center=this.scene.center.clone(),this.object.up.set(0,1,0);var e=new THREE.Vector3(0,0,-1);e.applyQuaternion(this.object.quaternion),e.normalize(),.01>this.center.distanceTo(this.object.position)&&this.object.position.sub(e.multiplyScalar(.01)),this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousedown",r,!1),this.domElement.addEventListener("mousewheel",s,!1),this.domElement.addEventListener("DOMMouseScroll",s,!1),this.domElement.addEventListener("dblclick",x,!1),this.addEventListener("change",D),this.scene.addEventListener("center",C),this.scene.addEventListener("beforeRender",this.update),GIScene.Control.prototype.activate.call(this)}},this.deactivate=function(){this.isActive&&(this.domElement.removeEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.removeEventListener("mousedown",r,!1),this.domElement.removeEventListener("mousewheel",s,!1),this.domElement.removeEventListener("DOMMouseScroll",s,!1),this.domElement.removeEventListener("dblclick",x,!1),this.removeEventListener("change",D),this.scene.removeEventListener("center",C),this.scene.removeEventListener("beforeRender",this.update),GIScene.Control.prototype.deactivate.call(this))}},GIScene.Control.PanOrbitZoomCenter.prototype=Object.create(GIScene.Control.prototype),GIScene.Control.Trackball=function(e,t){function i(e){d.enabled!==!1&&(window.removeEventListener("keydown",i),p=m,m===u.NONE&&(e.keyCode!==d.keys[u.ROTATE]||d.noRotate?e.keyCode!==d.keys[u.ZOOM]||d.noZoom?e.keyCode!==d.keys[u.PAN]||d.noPan||(m=u.PAN):m=u.ZOOM:m=u.ROTATE))}function n(){d.enabled!==!1&&(m=p,window.addEventListener("keydown",i,!1))}function r(e){d.enabled!==!1&&(e.preventDefault(),e.stopPropagation(),m===u.NONE&&(m=e.button),m!==u.ROTATE||d.noRotate?m!==u.ZOOM||d.noZoom?m!==u.PAN||d.noPan||(R=d.getMouseOnScreen(e.clientX,e.clientY),w.copy(R)):(y=d.getMouseOnScreen(e.clientX,e.clientY),S.copy(y)):(g=d.getMouseProjectionOnBall(e.clientX,e.clientY),E.copy(g)),document.addEventListener("mousemove",a,!1),document.addEventListener("mouseup",o,!1),d.dispatchEvent(I))}function a(e){d.enabled!==!1&&(e.preventDefault(),e.stopPropagation(),m!==u.ROTATE||d.noRotate?m!==u.ZOOM||d.noZoom?m!==u.PAN||d.noPan||(w=d.getMouseOnScreen(e.clientX,e.clientY)):S=d.getMouseOnScreen(e.clientX,e.clientY):E=d.getMouseProjectionOnBall(e.clientX,e.clientY))}function o(e){d.enabled!==!1&&(e.preventDefault(),e.stopPropagation(),m=u.NONE,document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",o),d.dispatchEvent(L))}function s(e){if(d.enabled!==!1){e.preventDefault(),e.stopPropagation();var t=0;e.wheelDelta?t=e.wheelDelta/40:e.detail&&(t=-e.detail/3),y.y+=.01*t,d.dispatchEvent(I),d.dispatchEvent(L)}}function c(e){if(d.enabled!==!1){switch(e.touches.length){case 1:m=u.TOUCH_ROTATE,g=E=d.getMouseProjectionOnBall(e.touches[0].pageX,e.touches[0].pageY);break;case 2:m=u.TOUCH_ZOOM;var t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY;T=b=Math.sqrt(t*t+i*i);break;case 3:m=u.TOUCH_PAN,R=w=d.getMouseOnScreen(e.touches[0].pageX,e.touches[0].pageY);break;default:m=u.NONE}d.dispatchEvent(I)}}function l(e){if(d.enabled!==!1)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:E=d.getMouseProjectionOnBall(e.touches[0].pageX,e.touches[0].pageY);break;case 2:var t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY;T=Math.sqrt(t*t+i*i);break;case 3:w=d.getMouseOnScreen(e.touches[0].pageX,e.touches[0].pageY);break;default:m=u.NONE}}function h(e){if(d.enabled!==!1){switch(e.touches.length){case 1:g=E=d.getMouseProjectionOnBall(e.touches[0].pageX,e.touches[0].pageY);break;case 2:b=T=0;break;case 3:R=w=d.getMouseOnScreen(e.touches[0].pageX,e.touches[0].pageY)}m=u.NONE,d.dispatchEvent(L)}}GIScene.Control.call(this);var d=this,u={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM:4,TOUCH_PAN:5};this.object=e,this.domElement=void 0!==t?t:document.body,this.enabled=!0,this.screen={left:0,top:0,width:0,height:0},this.rotateSpeed=1,this.zoomSpeed=1.2,this.panSpeed=.3,this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.noRoll=!0,this.staticMoving=!0,this.dynamicDampingFactor=.2,this.minDistance=0,this.maxDistance=1/0,this.keys=[65,83,68],this.target=new THREE.Vector3;var f=new THREE.Vector3,m=u.NONE,p=u.NONE,v=new THREE.Vector3,g=new THREE.Vector3,E=new THREE.Vector3,y=new THREE.Vector2,S=new THREE.Vector2,b=0,T=0,R=new THREE.Vector2,w=new THREE.Vector2;this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.up0=this.object.up.clone();var M={type:"change"},I={type:"start"},L={type:"end"};this.handleResize=function(){this.domElement===document?(this.screen.left=0,this.screen.top=0,this.screen.width=window.innerWidth,this.screen.height=window.innerHeight):this.screen=this.domElement.getBoundingClientRect()},this.handleEvent=function(e){"function"==typeof this[e.type]&&this[e.type](e)},this.getMouseOnScreen=function(e,t){return new THREE.Vector2((e-d.screen.left)/d.screen.width,(t-d.screen.top)/d.screen.height)},this.getMouseProjectionOnBall=function(e,t){var i=new THREE.Vector3((e-.5*d.screen.width-d.screen.left)/(.5*d.screen.width),(.5*d.screen.height+d.screen.top-t)/(.5*d.screen.height),0),n=i.length();d.noRoll?i.z=Math.SQRT1_2>n?Math.sqrt(1-n*n):.5/n:n>1?i.normalize():i.z=Math.sqrt(1-n*n),v.copy(d.object.position).sub(d.target);var r=d.object.up.clone().setLength(i.y);return r.add(d.object.up.clone().cross(v).setLength(i.x)),r.add(v.setLength(i.z)),r},this.rotateCamera=function(){var e=Math.acos(g.dot(E)/g.length()/E.length());if(e){var t=(new THREE.Vector3).crossVectors(g,E).normalize(),i=new THREE.Quaternion;e*=d.rotateSpeed,i.setFromAxisAngle(t,-e),v.applyQuaternion(i),d.object.up.applyQuaternion(i),E.applyQuaternion(i),d.staticMoving?g.copy(E):(i.setFromAxisAngle(t,e*(d.dynamicDampingFactor-1)),g.applyQuaternion(i))}},this.zoomCamera=function(){if(m===u.TOUCH_ZOOM){var e=b/T;b=T,v.multiplyScalar(e)}else{var e=1+(S.y-y.y)*d.zoomSpeed;1!==e&&e>0&&(v.multiplyScalar(e),d.staticMoving?y.copy(S):y.y+=(S.y-y.y)*this.dynamicDampingFactor)}},this.panCamera=function(){var e=w.clone().sub(R);if(e.lengthSq()){e.multiplyScalar(v.length()*d.panSpeed);var t=v.clone().cross(d.object.up).setLength(e.x);t.add(d.object.up.clone().setLength(e.y)),d.object.position.add(t),d.target.add(t),d.staticMoving?R=w:R.add(e.subVectors(w,R).multiplyScalar(d.dynamicDampingFactor))}},this.checkDistances=function(){d.noZoom&&d.noPan||(v.lengthSq()>d.maxDistance*d.maxDistance&&d.object.position.addVectors(d.target,v.setLength(d.maxDistance)),d.minDistance*d.minDistance>v.lengthSq()&&d.object.position.addVectors(d.target,v.setLength(d.minDistance)))},this.update=function(){v.subVectors(d.object.position,d.target),d.noRotate||d.rotateCamera(),d.noZoom||d.zoomCamera(),d.noPan||d.panCamera(),d.object.position.addVectors(d.target,v),d.checkDistances(),d.object.lookAt(d.target),f.distanceToSquared(d.object.position)>0&&(d.dispatchEvent(M),f.copy(d.object.position))},this.reset=function(){m=u.NONE,p=u.NONE,d.target.copy(d.target0),d.object.position.copy(d.position0),d.object.up.copy(d.up0),v.subVectors(d.object.position,d.target),d.object.lookAt(d.target),d.dispatchEvent(M),f.copy(d.object.position)};var A=function(e){this.target=e.content.center}.bind(this),x=function(e){this.scene.center=e.target.target.clone(),this.object.target.position.setZ(-this.object.position.distanceTo(e.target.target))};this.activate=function(){this.isActive||(this.target=this.scene.center.clone(),this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousedown",r,!1),this.domElement.addEventListener("mousewheel",s,!1),this.domElement.addEventListener("DOMMouseScroll",s,!1),this.domElement.addEventListener("touchstart",c,!1),this.domElement.addEventListener("touchend",h,!1),this.domElement.addEventListener("touchmove",l,!1),window.addEventListener("keydown",i,!1),window.addEventListener("keyup",n,!1),this.handleResize(),window.addEventListener("resize",this.handleResize,!1),this.addEventListener("change",x),this.scene.addEventListener("center",A),this.scene.addEventListener("beforeRender",this.update),GIScene.Control.prototype.activate.call(this))},this.deactivate=function(){this.isActive&&(this.domElement.removeEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.removeEventListener("mousedown",r,!1),this.domElement.removeEventListener("mousewheel",s,!1),this.domElement.removeEventListener("DOMMouseScroll",s,!1),this.domElement.removeEventListener("touchstart",c,!1),this.domElement.removeEventListener("touchend",h,!1),this.domElement.removeEventListener("touchmove",l,!1),window.removeEventListener("keydown",i,!1),window.removeEventListener("keyup",n,!1),this.removeEventListener("change",x),this.scene.removeEventListener("center",A),window.removeEventListener("resize",this.handleResize,!1),this.scene.removeEventListener("beforeRender",this.update),GIScene.Control.prototype.deactivate.call(this))}},GIScene.Control.Trackball.prototype=Object.create(GIScene.Control.prototype),GIScene.Control.Fly=function(e,t){GIScene.Control.call(this),this.object=e,this.domElement=void 0!==t?t:document,t&&this.domElement.setAttribute("tabindex",-1),this.center=null,this.movementSpeed=1,this.rollSpeed=.005,this.dragToLook=!1,this.autoForward=!1,this.tmpQuaternion=new THREE.Quaternion,this.mouseStatus=0,this.moveState={up:0,down:0,left:0,right:0,forward:0,back:0,pitchUp:0,pitchDown:0,yawLeft:0,yawRight:0,rollLeft:0,rollRight:0},this.moveVector=new THREE.Vector3(0,0,0),this.rotationVector=new THREE.Vector3(0,0,0);var i=function(e){if(!e.altKey){switch(e.keyCode){case 16:this.movementSpeedMultiplier=.1;break;case 87:this.moveState.forward=1;break;case 83:this.moveState.back=1;break;case 65:this.moveState.left=1;break;case 68:this.moveState.right=1;break;case 82:this.moveState.up=1;break;case 70:this.moveState.down=1;break;case 38:this.moveState.pitchUp=1;break;case 40:this.moveState.pitchDown=1;break;case 37:this.moveState.yawLeft=1;break;case 39:this.moveState.yawRight=1;break;case 81:this.moveState.rollLeft=1;break;case 69:this.moveState.rollRight=1}this.updateMovementVector(),this.updateRotationVector()}}.bind(this),n=function(e){switch(e.keyCode){case 16:this.movementSpeedMultiplier=1;break;case 87:this.moveState.forward=0;break;case 83:this.moveState.back=0;break;case 65:this.moveState.left=0;break;case 68:this.moveState.right=0;break;case 82:this.moveState.up=0;break;case 70:this.moveState.down=0;break;case 38:this.moveState.pitchUp=0;break;case 40:this.moveState.pitchDown=0;break;case 37:this.moveState.yawLeft=0;break;case 39:this.moveState.yawRight=0;break;case 81:this.moveState.rollLeft=0;break;case 69:this.moveState.rollRight=0}this.updateMovementVector(),this.updateRotationVector()}.bind(this),r=function(e){if(this.domElement!==document&&this.domElement.focus(),e.preventDefault(),e.stopPropagation(),this.dragToLook)this.mouseStatus++;else{switch(e.button){case 0:this.moveState.forward=1;break;case 2:this.moveState.back=1}this.updateMovementVector()}}.bind(this),a=function(e){if(!this.dragToLook||this.mouseStatus>0){var t=this.getContainerDimensions(),i=t.size[0]/2,n=t.size[1]/2;this.moveState.yawLeft=-(e.pageX-t.offset[0]-i)/i,this.moveState.pitchDown=(e.pageY-t.offset[1]-n)/n,this.updateRotationVector()}}.bind(this),o=function(e){if(e.preventDefault(),e.stopPropagation(),this.dragToLook)this.mouseStatus--,this.moveState.yawLeft=this.moveState.pitchDown=0;else{switch(e.button){case 0:this.moveState.forward=0;break;case 2:this.moveState.back=0}this.updateMovementVector()}this.updateRotationVector()}.bind(this);this.update=function(){console.log("FLY.update()"),delta=this.scene.delta,console.log("delta",delta);var e=delta*this.movementSpeed,t=delta*this.rollSpeed;this.object.translateX(this.moveVector.x*e),this.object.translateY(this.moveVector.y*e),this.object.translateZ(this.moveVector.z*e),this.dispatchEvent({type:"change"}),this.tmpQuaternion.set(this.rotationVector.x*t,this.rotationVector.y*t,this.rotationVector.z*t,1).normalize(),this.object.quaternion.multiply(this.tmpQuaternion),this.object.rotation.setFromQuaternion(this.object.quaternion,this.object.rotation.order)}.bind(this),this.updateMovementVector=function(){console.log("FLY.updateMovementVector()");var e=this.moveState.forward||this.autoForward&&!this.moveState.back?1:0;this.moveVector.x=-this.moveState.left+this.moveState.right,this.moveVector.y=-this.moveState.down+this.moveState.up,this.moveVector.z=-e+this.moveState.back},this.updateRotationVector=function(){console.log("FLY.updateRotationVector()"),this.rotationVector.x=-this.moveState.pitchDown+this.moveState.pitchUp,this.rotationVector.y=-this.moveState.yawRight+this.moveState.yawLeft,this.rotationVector.z=-this.moveState.rollRight+this.moveState.rollLeft},this.getContainerDimensions=function(){return this.domElement!=document?{size:[this.domElement.offsetWidth,this.domElement.offsetHeight],offset:[this.domElement.offsetLeft,this.domElement.offsetTop]}:{size:[window.innerWidth,window.innerHeight],offset:[0,0]}};var s=function(e){this.center=e.content.center}.bind(this),c=function(e){this.scene.center=e.target.center.clone()}.bind(this);this.activate=function(){this.isActive||(this.center=this.scene.center.clone(),this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousemove",a,!1),this.domElement.addEventListener("mousedown",r,!1),this.domElement.addEventListener("mouseup",o,!1),this.domElement.addEventListener("keydown",i,!1),this.domElement.addEventListener("keyup",n,!1),this.addEventListener("change",c),this.scene.addEventListener("center",s),this.updateMovementVector(),this.updateRotationVector(),this.scene.addEventListener("beforeRender",this.update),GIScene.Control.prototype.activate.call(this))},this.deactivate=function(){this.isActive&&(this.domElement.removeEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.removeEventListener("mousemove",a,!1),this.domElement.removeEventListener("mousedown",r,!1),this.domElement.removeEventListener("mouseup",o,!1),this.domElement.removeEventListener("keydown",i,!1),this.domElement.removeEventListener("keyup",n,!1),this.removeEventListener("change",c),this.scene.removeEventListener("center",s),this.scene.removeEventListener("beforeRender",this.update),GIScene.Control.prototype.deactivate.call(this))}},GIScene.Control.Fly.prototype=Object.create(GIScene.Control.prototype),GIScene.Control.Walk=function(e,t){GIScene.Control.call(this),this.object=e,this.target=new THREE.Vector3(0,0,0),this.center=null,this.bodyPivot=null,this.domElement=void 0!==t?t:document,this.movementSpeed=5,this.lookSpeed=.025,this.maxMovementSpeed=100,this.minMovementSpeed=.01,this.jumpOffset=1,this.lookVertical=!0,this.autoForward=!1,this.activeLook=!1,this.heightSpeed=!1,this.heightCoef=1,this.heightMin=0,this.heightMax=1,this.constrainVertical=!1,this.verticalMin=0,this.verticalMax=Math.PI,this.autoSpeedFactor=0;var i=new THREE.Vector3,n=new THREE.Raycaster;this.mouseStart=new THREE.Vector2,this.mouseEnd=new THREE.Vector2,this.mouseDelta=new THREE.Vector2,this.lat=0,this.oldLat=0,this.lon=0,this.phi=0,this.theta=0,this.moveForward=!1,this.moveBackward=!1,this.moveLeft=!1,this.moveRight=!1,this.freeze=!1,this.mouseDragOn=!1,this.viewHalfX=0,this.viewHalfY=0,this.domElement!==document&&this.domElement.setAttribute("tabindex",-1),this.onMouseDown=function(e){if(document.addEventListener("mousemove",this.onMouseMove,!1),this.domElement!==document&&this.domElement.focus(),e.preventDefault(),e.stopPropagation(),this.activeLook)switch(e.button){case 0:this.moveForward=!0;break;case 2:this.moveBackward=!0}this.mouseEnd.set(e.clientX,e.clientY),this.mouseStart.set(e.clientX,e.clientY),this.oldLat+=this.lat,this.lat=0,this.mouseDelta.set(0,0),this.mouseDragOn=!0}.bind(this),this.onMouseUp=function(e){if(document.removeEventListener("mousemove",this.onMouseMove,!1),e.preventDefault(),e.stopPropagation(),this.activeLook)switch(e.button){case 0:this.moveForward=!1;break;case 2:this.moveBackward=!1}this.mouseDragOn=!1,this.oldLat+=this.lat,this.lat=0}.bind(this),this.onMouseMove=function(e){this.mouseEnd.set(e.clientX,e.clientY),this.mouseDelta.subVectors(this.mouseEnd,this.mouseStart)}.bind(this),this.onKeyDown=function(e){switch(e.keyCode){case 73:case 38:this.moveForward=!0;break;case 87:this.lookUp=!0;break;case 74:case 37:this.rotateLeft=!0;break;case 65:this.moveLeft=!0;break;case 75:case 40:this.moveBackward=!0;break;case 83:this.lookDown=!0;break;case 76:case 39:this.rotateRight=!0;break;case 68:this.moveRight=!0;break;case 82:this.moveUp=!0;break;case 70:this.moveDown=!0;break;case 81:this.freeze=!this.freeze;break;case 107:case 171:case 61:case 187:this.movementSpeed=Math.min(this.movementSpeed*=1.5,this.maxMovementSpeed);break;case 109:case 163:case 173:case 191:case 189:this.movementSpeed=Math.max(this.movementSpeed/=1.5,this.minMovementSpeed)}}.bind(this),this.onKeyUp=function(e){switch(e.keyCode){case 73:case 38:this.moveForward=!1;break;case 87:this.lookUp=!1;break;case 74:case 37:this.rotateLeft=!1;break;case 65:this.moveLeft=!1;break;case 75:case 40:this.moveBackward=!1;break;case 83:this.lookDown=!1;break;case 76:case 39:this.rotateRight=!1;break;case 68:this.moveRight=!1;break;case 82:this.moveUp=!1;break;case 70:this.moveDown=!1}}.bind(this),this.update=function(){if(delta=this.scene.delta,!this.freeze){if(this.heightSpeed){var e=THREE.Math.clamp(this.object.position.y,this.heightMin,this.heightMax),t=e-this.heightMin;this.autoSpeedFactor=delta*t*this.heightCoef}else this.autoSpeedFactor=0;var i=delta*this.movementSpeed;(this.moveForward||this.autoForward&&!this.moveBackward)&&this.bodyPivot.translateZ(-(i+this.autoSpeedFactor)),this.moveBackward&&this.bodyPivot.translateZ(i),this.moveLeft&&this.bodyPivot.translateX(-i),this.moveRight&&this.bodyPivot.translateX(i),this.moveUp&&this.bodyPivot.translateY(i),this.moveDown&&this.bodyPivot.translateY(-i);var n=delta*this.lookSpeed;this.activeLook||(n=0);var r=1;if(this.constrainVertical&&(r=Math.PI/(this.verticalMax-this.verticalMin)),this.mouseDragOn&&Math.abs(this.mouseDelta.x)>5){var a=this.mouseDelta.x/Math.abs(this.mouseDelta.x);this.lon+=a*Math.min((Math.abs(this.mouseDelta.x)-5)/20,800*delta*this.lookSpeed)}this.rotateLeft&&(this.lon-=800*delta*this.lookSpeed),this.rotateRight&&(this.lon+=800*delta*this.lookSpeed),this.lookVertical&&this.mouseDragOn&&(this.lat=this.mouseDelta.y/5),this.lookVertical&&this.lookUp&&(this.oldLat-=800*delta*this.lookSpeed),this.lookVertical&&this.lookDown&&(this.oldLat+=800*delta*this.lookSpeed),this.lat=Math.max(-85,Math.min(85,this.lat)),this.phi=THREE.Math.degToRad(90),this.theta=THREE.Math.degToRad(this.lon),this.constrainVertical&&(this.phi=THREE.Math.mapLinear(this.phi,0,Math.PI,this.verticalMin,this.verticalMax));var o=this.target,s=this.bodyPivot.position;o.x=s.x+100*Math.sin(this.phi)*Math.cos(this.theta),o.y=s.y+100*Math.cos(this.phi),o.z=s.z+100*Math.sin(this.phi)*Math.sin(this.theta),this.bodyPivot.lookAt(o),this.object.position.copy(s);var c=new THREE.Quaternion;c.setFromAxisAngle(new THREE.Vector3(1,0,0),THREE.Math.degToRad(-10-this.oldLat-this.lat)),this.object.quaternion.multiplyQuaternions(this.bodyPivot.quaternion,c),this.dispatchEvent({type:"change"})}}.bind(this);var r=function(e){e.preventDefault();var t=GIScene.Utils.getViewportCoordsFromDOMEvent(this.domElement,e);i.set(t.x,t.y,1);for(var r,a=n.setFromCamera(i,this.object),o=GIScene.Utils.getDescendants(this.scene.root).filter(function(e){return e.geometry}),s=a.intersectObjects(o),c=0;s.length>c;c++)if(s[c].object.geometry&&s[c].object.visible){r=s[c];break}if(r){var l=function(){this.scene.removeEventListener("center",l),this.scene.addEventListener("beforeRender",this.update)}.bind(this);this.scene.addEventListener("center",l),this.scene.removeEventListener("beforeRender",this.update);var h=r.point.clone().add(new THREE.Vector3(0,1,0)),d=this.object.position.clone().sub(h).normalize(),u=h;this.scene.setCenter(u,d.clone().multiplyScalar(this.jumpOffset),500),this.dispatchEvent({type:"change"})}}.bind(this),a=function(e){this.center=e.content.center,this.bodyPivot.matrix.copy(this.object.matrixWorld),this.bodyPivot.updateMatrixWorld(),this.bodyPivot.position.copy(this.object.position),this.bodyPivot.quaternion.setFromRotationMatrix(this.object.matrixWorld);var t=new THREE.Vector3(0,0,-1),i=t.clone(),n=new THREE.Vector3(0,1,0);t.applyQuaternion(this.bodyPivot.quaternion);var r=t.clone().projectOnPlane(n),a=r.clone().cross(n).angleTo(i)>Math.PI/2?!0:!1,o=r.angleTo(i),s=a?o:2*Math.PI-o,c=THREE.Math.radToDeg(s);this.lon=c+90,this.lat=THREE.Math.radToDeg(t.angleTo(this.scene.camera.up))-90-10-this.oldLat}.bind(this),o=function(){this.center=this.object.localToWorld(this.object.target.position.clone()),this.scene.center=this.center,this.scene.dispatchEvent("cameraChange")}.bind(this);this.activate=function(){if(!this.isActive){this.scene.camera.target.position.setZ(-this.jumpOffset),this.center=this.scene.camera.localToWorld(this.scene.camera.target.position.clone()),this.scene.setCenter(this.center,this.scene.camera.position.clone().sub(this.center),0),this.bodyPivot=new THREE.Object3D,this.bodyPivot.applyMatrix(this.object.matrixWorld),this.bodyPivot.matrixWorldNeedsUpdate=!0;var e=new THREE.Vector3(0,0,-1),t=e.clone(),i=new THREE.Vector3(0,1,0);e.applyQuaternion(this.bodyPivot.quaternion);var n=e.clone().projectOnPlane(i),s=n.clone().cross(i).angleTo(t)>Math.PI/2?!0:!1,c=n.angleTo(t),l=s?c:2*Math.PI-c,h=THREE.Math.radToDeg(l);this.lon=h+90,this.lat=THREE.Math.radToDeg(e.angleTo(this.scene.camera.up))-90-10-this.oldLat,this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousedown",this.onMouseDown,!1),document.addEventListener("mouseup",this.onMouseUp,!1),this.domElement.addEventListener("keydown",this.onKeyDown,!1),this.domElement.addEventListener("keyup",this.onKeyUp,!1),this.domElement.addEventListener("dblclick",r,!1),this.addEventListener("change",o),this.scene.addEventListener("center",a),this.scene.addEventListener("beforeRender",this.update),GIScene.Control.prototype.activate.call(this)}},this.deactivate=function(){this.isActive&&(this.domElement.removeEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.removeEventListener("mousedown",this.onMouseDown,!1),document.removeEventListener("mouseup",this.onMouseUp,!1),this.domElement.removeEventListener("keydown",this.onKeyDown,!1),this.domElement.removeEventListener("keyup",this.onKeyUp,!1),this.domElement.removeEventListener("dblclick",r,!1),this.removeEventListener("change",o),this.scene.removeEventListener("center",a),this.scene.removeEventListener("beforeRender",this.update),GIScene.Control.prototype.deactivate.call(this))}},GIScene.Control.Walk.prototype=Object.create(GIScene.Control.prototype),GIScene.Control.CameraLight=function(e,t,i){GIScene.Control.call(this);var n={maxHorizontalAngle:65,maxVerticalAngle:65};this.config=GIScene.Utils.mergeObjects(n,i||{}),this.camera=e,this.light=t||new THREE.DirectionalLight(16777215,.5),this.pivotLight=new THREE.Object3D,this.domElement=null;var r=new THREE.Vector2(0,0);this.maxHorizontalAngle=this.config.maxHorizontalAngle,this.maxVerticalAngle=this.config.maxVerticalAngle;var a={NONE:-1,PAN:1},o=a.NONE,s=!1,c="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6QTg5OEJENDc1ODUyMTFFMEExNjhDMjM3RjM1NjdBMkYiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6QTg5OEJENDg1ODUyMTFFMEExNjhDMjM3RjM1NjdBMkYiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDpBODk4QkQ0NTU4NTIxMUUwQTE2OEMyMzdGMzU2N0EyRiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDpBODk4QkQ0NjU4NTIxMUUwQTE2OEMyMzdGMzU2N0EyRiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PpQl4IgAABkpSURBVHja7F0JbFzH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",l=new THREE.Texture(null),h=new Image;
h.onload=function(){l.image=h,l.needsUpdate=!0},h.src=c;var d=new THREE.SpriteMaterial({map:l,opacity:.7});this.sprite=new THREE.Sprite(d),this.sprite.scale.set(50,50,1);var u,f,m;this.panSprite=function(e){var t=this.sprite.position;t.set(t.x+e.x,t.y-e.y,t.z),this.updateLightPosition()},this.updateLightPosition=function(){var e=this.sprite.position.clone();e.x/=this.scene.canvas.width/2,e.y/=this.scene.canvas.height/2,r=e.clone().set(e.x*this.maxHorizontalAngle,e.y*-this.maxVerticalAngle),this.pivotLight.rotation.set(THREE.Math.degToRad(r.y),THREE.Math.degToRad(r.x),0)},this.getIlluminationAngles=function(){var e={theta:r.x,phi:r.y};return e};var p=function(e){if(s){this.dispatchEvent({type:"panstart"}),o=a.PAN;var t=GIScene.Utils.getRelativeScreenCoordsFromDOMEvent(this.domElement,e);u=t,this.domElement.addEventListener("mouseup",g,!1)}}.bind(this),v=function(e){var t=GIScene.Utils.getViewportCoordsFromDOMEvent(this.domElement,e);t.x*=this.scene.canvas.width/2,t.y*=this.scene.canvas.height/2;var i=t.distanceTo(this.sprite.position);Math.max(this.sprite.scale.x,this.sprite.scale.y)/2>=i?(0==s&&(this.sprite.material.opacity=1),s=!0):(1==s&&(this.sprite.material.opacity=.7),s=!1),o==a.PAN&&(f=GIScene.Utils.getRelativeScreenCoordsFromDOMEvent(this.domElement,e),m=f.clone().sub(u),this.panSprite(m),u=f,this.dispatchEvent({type:"pan"}))}.bind(this),g=function(){o==a.PAN&&this.dispatchEvent({type:"panend"}),o=a.NONE,this.domElement.removeEventListener("mouseup",g,!1)}.bind(this);(function(){}).bind(this),this.activate=function(){if(!this.isActive){var e=(new THREE.Vector3).setFromMatrixPosition(this.camera.target.matrixWorld);this.pivotLight.rotation.set(0,0,0),this.camera.target.add(this.pivotLight),this.light.position.set(0,0,this.camera.position.distanceTo(e)),this.pivotLight.add(this.light),this.light.target.position.set(0,0,0),this.camera.target.add(this.light.target),this.domElement=this.scene.canvas,this.sprite.position.set(0,0,0),this.scene.spriteRoot.add(this.sprite),this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousemove",v,!1),this.domElement.addEventListener("mousedown",p,!1),GIScene.Control.prototype.activate.call(this)}},this.deactivate=function(){this.isActive&&(this.scene.spriteRoot.remove(this.sprite),THREE.SceneUtils.detach(this.light.target,this.camera.target,this.scene.root),THREE.SceneUtils.detach(this.light,this.light.parent,this.scene.root),this.camera.target.remove(this.pivotLight),this.domElement.removeEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.removeEventListener("mousemove",v,!1),this.domElement.removeEventListener("mousedown",p,!1),GIScene.Control.prototype.deactivate.call(this))}},GIScene.Control.CameraLight.prototype=Object.create(GIScene.Control.prototype),GIScene.Control.Pick=function(e,t){GIScene.Control.call(this),this.camera=e;var i={color:new THREE.Color(65280)};this.config=GIScene.Utils.mergeObjects(i,t||{}),this.domElement=null,this.pickables=[];var n=new THREE.Vector3(0,0,1),r=new THREE.Raycaster,a=THREE.ImageUtils.loadTexture(GIScene.LIBRARYPATH+GIScene.RESOURCESPATH.replace(/([^\/])$/,"$1/")+"resources/images/particle_cross.png"),o={layerGroup:"User-generated"},s=new GIScene.Layer("Picked Coordinate",o),c=new THREE.Geometry;c.vertices[0]=new THREE.Vector3(0,0,0);var l=new THREE.PointsMaterial({color:this.config.color,sizeAttenuation:!1,size:32,map:a,alphaTest:.5}),h=new THREE.Points(c,l);h.visible=!1,s.root.add(h);var d=function(e){var t=GIScene.Utils.getViewportCoordsFromDOMEvent(this.domElement,e);n.set(t.x,t.y,1)}.bind(this),u=function(e){var t=GIScene.Utils.getViewportCoordsFromDOMEvent(this.domElement,e);if(n.equals((new THREE.Vector3).set(t.x,t.y,1))){n.set(t.x,t.y,1),r.setFromCamera(n,this.camera.activeCam);for(var i,a=r.intersectObjects(this.pickables),o=0;a.length>o;o++)if(a[o].object.geometry&&a[o].object.visible){i=a[o];break}i&&this.drawPickResult(i),this.dispatchEvent({type:"click",content:i})}}.bind(this);this.drawPickResult=function(e){h.visible=!0;var t=e.point;c.vertices[0]=t,c.verticesNeedUpdate=!0},this.activate=function(){this.isActive||(this.domElement=this.scene.canvas,s.config.offset=this.scene.config.offset,this.scene.addLayer(s),this.domElement.addEventListener("mousedown",d,!1),this.domElement.addEventListener("mouseup",u,!1),GIScene.Control.prototype.activate.call(this))},this.deactivate=function(){this.isActive&&(this.domElement.removeEventListener("mousedown",d,!1),this.domElement.removeEventListener("mouseup",u,!1),this.scene.removeLayer(s),h.visible=!1,GIScene.Control.prototype.deactivate.call(this))}},GIScene.Control.Pick.prototype=Object.create(GIScene.Control.prototype),GIScene.Control.Measure=function(e,t){GIScene.Control.call(this),this.camera=e;var i={color:new THREE.Color(16711680)};this.config=GIScene.Utils.mergeObjects(i,t||{}),this.domElement=null,this.measureables=[];var n=new THREE.Vector3(0,0,1),r=new THREE.Raycaster,a=new THREE.TextureLoader,o=null,s=null,c=null,l=null,h=function(e){var t=GIScene.Utils.getViewportCoordsFromDOMEvent(this.domElement,e);n.set(t.x,t.y,1)}.bind(this),d=function(e){var t=GIScene.Utils.getViewportCoordsFromDOMEvent(this.domElement,e);if(n.equals((new THREE.Vector3).set(t.x,t.y,1))){n.set(t.x,t.y,1);var i=this.camera instanceof THREE.CombinedCamera?this.camera.activeCam:this.camera;r.setFromCamera(n,i);for(var a,o=r.intersectObjects(this.measureables),s=0;o.length>s;s++)if(o[s].object.geometry&&o[s].object.visible){a=o[s];break}a&&this.drawPickResult(a)}}.bind(this);this.drawPickResult=function(e){if(2>s.root.children.length){var t=e.point;pickedPointGeom=new THREE.Geometry,pickedPointGeom.vertices.push(t)}if(1==s.root.children.length){var i=new THREE.Points(pickedPointGeom.clone(),c);i.renderOrder=-1,s.root.add(i);var n=new THREE.Geometry,r=s.root.children[0].geometry.vertices[0],a=s.root.children[1].geometry.vertices[0];n.vertices.push(r),n.vertices.push(a);var o=new THREE.Line(n,l);o.renderOrder=-1,s.root.add(o);var h=new THREE.Vector3(0,0,-1),d=a.clone().setY(0),u=r.clone().setY(0),f=d.sub(u),m=f.x>=0?!0:!1,p=h.angleTo(f);m||(p=2*Math.PI-p);var v=THREE.Math.radToDeg(p),g={distance:r.distanceTo(a),angleToNorth:v};this.dispatchEvent({type:"measure",content:g})}if(0==s.root.children.length){var i=new THREE.Points(pickedPointGeom.clone(),c);i.renderOrder=-1,s.root.add(i)}},this.activate=function(){if(!this.isActive){this.domElement=this.scene.canvas,resulstLayerConfig={offset:this.scene.config.offset,layerGroup:"User-generated"},s=new GIScene.Layer("Measurements",resulstLayerConfig),this.scene.addLayer(s);var e=GIScene.LIBRARYPATH+GIScene.RESOURCESPATH.replace(/([^\/])$/,"$1/")+"resources/images/particle_cross.png";o=a.load(e),c=new THREE.PointsMaterial({color:this.config.color,sizeAttenuation:!1,size:32,map:o,alphaTest:.5,transparent:!1}),l=new THREE.LineBasicMaterial({color:this.config.color,linewidth:1}),this.domElement.addEventListener("mousedown",h,!1),this.domElement.addEventListener("mouseup",d,!1),GIScene.Control.prototype.activate.call(this)}},this.deactivate=function(){this.isActive&&(this.domElement.removeEventListener("mousedown",h,!1),this.domElement.removeEventListener("mouseup",d,!1),this.scene.disposeLayer(s),GIScene.Control.prototype.deactivate.call(this))}},GIScene.Control.Measure.prototype=Object.create(GIScene.Control.prototype),GIScene.Control.LoadIndicator=function(){GIScene.Control.call(this),this.domElement=null,this.indicatorElement=null;var e=0,t=function(){var e=document.createElement("div");return e.setAttribute("id","GIScene_LoadIndicator_wrapper"),e.setAttribute("style","bottom: 20px;font-family: Sans-serif;left: 50%;opacity: 1;position: absolute;text-shadow: 0 0 2px #000000;color:#FFFFFF;font-weight:bold;letter-spacing:2px;"),e.textContent="Loading...",e},i=function(){0==e&&this.domElement.appendChild(this.indicatorElement),e++}.bind(this),n=function(){e--,0==e&&this.domElement.removeChild(this.indicatorElement)}.bind(this);this.activate=function(){this.isActive||(this.domElement=this.scene.containerDiv,this.indicatorElement=t(),GIScene.ModelLoader.prototype.addEventListener("beforeLoad",i),GIScene.ModelLoader.prototype.addEventListener("load",n),GIScene.ModelLoader.prototype.addEventListener("abort",n),GIScene.Control.prototype.activate.call(this))},this.deactivate=function(){this.isActive&&(GIScene.ModelLoader.prototype.removeEventListener("beforeLoad",i),GIScene.ModelLoader.prototype.removeEventListener("load",n),GIScene.ModelLoader.prototype.removeEventListener("abort",n),GIScene.Control.prototype.deactivate.call(this))}},GIScene.Control.LoadIndicator.prototype=Object.create(GIScene.Control.prototype),GIScene.Control.Compass=function(e,t){GIScene.Control.call(this);var i={};this.config=GIScene.Utils.mergeObjects(i,t||{}),this.camera=e;var n=0,r="data:image/png;base64,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",a=new THREE.Texture(null),o=new Image;o.onload=function(){a.image=o,a.needsUpdate=!0},o.src=r;var s=new THREE.SpriteMaterial({map:a,opacity:1});this.sprite=new THREE.Sprite(s),this.sprite.scale.set(100,100,1),this.update=function(){var e=this.camera.localToWorld(this.camera.target.position.clone()),t=this.camera.position,i=e.sub(t),r=new THREE.Vector3(0,1,0),a=new THREE.Vector3(0,0,-1),o=i.projectOnPlane(r),s=o.clone().cross(r).angleTo(a)>Math.PI/2?!0:!1,c=o.angleTo(a),l=s?c:2*Math.PI-c;n=THREE.Math.radToDeg(l),this.sprite.material.rotation=l}.bind(this),this.getCompassDegrees=function(){return n};var c=function(){this.sprite.position.set(-this.scene.canvas.width/2+60,this.scene.canvas.height/2-60,0)}.bind(this);this.activate=function(){this.isActive||(this.scene.spriteRoot.add(this.sprite),this.sprite.position.set(-this.scene.canvas.width/2+60,this.scene.canvas.height/2-60,0),this.update(),this.scene.addEventListener("cameraChange",this.update),window.addEventListener("resize",c,!1),GIScene.Control.prototype.activate.call(this))},this.deactivate=function(){this.isActive&&(this.scene.spriteRoot.remove(this.sprite),this.scene.removeEventListener("cameraChange",this.update),window.removeEventListener("resize",c,!1),GIScene.Control.prototype.deactivate.call(this))}},GIScene.Control.Compass.prototype=Object.create(GIScene.Control.prototype),GIScene.Control.AxisHelper=function(e,t){GIScene.Control.call(this);var i={size:50};this.config=GIScene.Utils.mergeObjects(i,t||{}),this.camera=e,this.axisHelper=new THREE.AxisHelper(this.config.size);var n=function(){this.axisHelper.rotation.setFromRotationMatrix(this.camera.matrixWorldInverse.extractRotation(this.camera.matrixWorldInverse))}.bind(this),r=function(){this.axisHelper.position.set(-this.scene.canvas.width/2+60,-this.scene.canvas.height/2+60,0)}.bind(this);this.activate=function(){this.isActive||(this.scene.spriteRoot.add(this.axisHelper),this.axisHelper.position.set(-this.scene.canvas.width/2+60,-this.scene.canvas.height/2+60,0),n(),this.scene.addEventListener("cameraChange",n),window.addEventListener("resize",r,!1),GIScene.Control.prototype.activate.call(this))},this.deactivate=function(){this.isActive&&(this.scene.spriteRoot.remove(this.axisHelper),this.scene.removeEventListener("cameraChange",n),window.removeEventListener("resize",r,!1),GIScene.Control.prototype.deactivate.call(this))}},GIScene.Control.AxisHelper.prototype=Object.create(GIScene.Control.prototype),GIScene.Control.TextPanel=function(e){GIScene.Control.call(this);var t={width:256,height:100,text:["Hello World","Zeile 2"],textAlign:"start",pxFromLeft:0,pxFromTop:400,fontSize:10,lineSpace:6,fontFamily:"sans-serif",fontStyle:"normal",color:"ivory",halo:"black"};this.config=GIScene.Utils.mergeObjects(t,e||{}),this.height=this.config.height;var i=this.config.text instanceof Array?this.config.text:[this.config.text],n=i.length,r="left"==this.config.textAlign||"start"==this.config.textAlign?0:"center"==this.config.textAlign?this.config.width/2:this.config.width;this.canvas2d=document.createElement("canvas"),this.canvas2d.width=this.config.width,this.canvas2d.height=this.height,this.context2d=this.canvas2d.getContext("2d"),this.context2d.textBaseline="middle",this.context2d.font=this.config.fontStyle+" "+this.config.fontSize+"pt "+this.config.fontFamily,this.context2d.textAlign=this.config.textAlign,this.context2d.fillStyle=this.config.color,this.context2d.shadowColor=this.config.halo,this.context2d.shadowBlur=3,this.texture=new THREE.Texture(this.canvas2d);var a=new THREE.SpriteMaterial({map:this.texture,opacity:1});this.sprite=new THREE.Sprite(a),this.sprite.scale.set(this.config.width,this.height,1),this.update=function(){this.context2d.clearRect(0,0,this.config.width,this.height);for(var e=0;n>e;e++)this.context2d.fillText(i[e],r,this.height/2-(n-1)*(this.config.fontSize+this.config.lineSpace)/2+e*(this.config.fontSize+this.config.lineSpace));this.texture.needsUpdate=!0}.bind(this),this.setText=function(e){i=e instanceof Array?e:[e],n=i.length,this.update()}.bind(this),this.activate=function(){this.isActive||(this.scene.spriteRoot.add(this.sprite),this.sprite.position.set(-this.scene.canvas.width/2+this.config.width/2+this.config.pxFromLeft,this.config.pxFromTop,0),this.texture.needsUpdate=!0,this.update(),GIScene.Control.prototype.activate.call(this))},this.deactivate=function(){this.isActive&&(this.scene.spriteRoot.remove(this.sprite),GIScene.Control.prototype.deactivate.call(this))}},GIScene.Control.TextPanel.prototype=Object.create(GIScene.Control.prototype),GIScene.Control.ObjectPosition=function(e){GIScene.Control.call(this),this.object=e,this.height=54,this.textPanel=new GIScene.Control.TextPanel({height:this.height,width:200,textAlign:"left",pxFromLeft:10,fontSize:10}),this.updateCoords=function(){var e=[];this.object.position.clone().add(this.scene.config.offset.toVector3()).toArray().forEach(function(t){e.push(t.toFixed(3))}),this.textPanel.setText(["Height: "+e[1],"X Y: "+e[0]+" "+-e[2]])}.bind(this);var t=function(){this.textPanel.sprite.position.set(-this.scene.canvas.width/2+this.textPanel.config.width/2+this.textPanel.config.pxFromLeft,-this.scene.canvas.height/2+this.height/2,0)}.bind(this);this.activate=function(){this.isActive||(this.textPanel.setScene(this.scene),this.textPanel.activate(),this.textPanel.sprite.position.set(-this.scene.canvas.width/2+this.textPanel.config.width/2+this.textPanel.config.pxFromLeft,-this.scene.canvas.height/2+this.height/2,0),this.scene.addEventListener("cameraChange",this.updateCoords),window.addEventListener("resize",t,!1),GIScene.Control.prototype.activate.call(this))},this.deactivate=function(){this.isActive&&(this.textPanel.deactivate(),this.scene.removeEventListener("cameraChange",this.updateCoords),window.removeEventListener("resize",t,!1),GIScene.Control.prototype.deactivate.call(this))}},GIScene.Control.ObjectPosition.prototype=Object.create(GIScene.Control.prototype),GIScene.Control.SSAO=function(){GIScene.Control.call(this);var e,t,i,n,r,a,o,s,c,l=function(){c=this.scene.camera instanceof THREE.CombinedCamera?this.scene.camera.inPerspectiveMode?this.scene.camera.cameraP:this.scene.camera.cameraO:this.scene.camera,s=c.clone(),this.scene.camera.add(s),s.near=.1,s.far=1e3,s.updateProjectionMatrix()}.bind(this),h=function(){t.uniforms.tDepth.value=n,t.uniforms.size.value.x=this.scene.canvas.width,t.uniforms.size.value.y=this.scene.canvas.height,t.uniforms.cameraNear.value=s.near,t.uniforms.cameraFar.value=s.far}.bind(this),d=function(){this.scene.root.overrideMaterial=o,this.scene.renderer.clearTarget(n,!0,!0,!1),this.scene.renderer.render(this.scene.root,s,n),this.scene.root.overrideMaterial=null}.bind(this),u=function(){console.log("chPrj2",c),l()},f=function(){l(),n=new THREE.WebGLRenderTarget(this.scene.canvas.width,this.scene.canvas.height,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat}),h(),i.uniforms.resolution.value.set(1/this.scene.canvas.width,1/this.scene.canvas.height)}.bind(this);this.activate_=function(){this.isActive||(e=new THREE.RenderPass(this.scene.root,this.scene.camera),t=new THREE.ShaderPass(THREE.SSAOShader),n=new THREE.WebGLRenderTarget(this.scene.canvas.width,this.scene.canvas.height,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat}),r=THREE.ShaderLib.depthRGBA,a=THREE.UniformsUtils.clone(r.uniforms),o=new THREE.ShaderMaterial({fragmentShader:r.fragmentShader,vertexShader:r.vertexShader,uniforms:a}),o.blending=THREE.NoBlending,this.scene.addEventListener("beforeRender",d),t.uniforms.tDepth.value=n,t.uniforms.size.value.x=this.scene.canvas.width,t.uniforms.size.value.y=this.scene.canvas.height,t.uniforms.cameraNear.value=this.scene.camera.near,t.uniforms.cameraFar.value=this.scene.camera.far,t.uniforms.onlyAO.value=1,t.renderToScreen=!0,this.scene.effectComposer.addPass(e),this.scene.effectComposer.addPass(t)),GIScene.Control.prototype.activate.call(this)},this.activate=function(){this.isActive||(n=new THREE.WebGLRenderTarget(this.scene.canvas.width,this.scene.canvas.height,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat}),r=THREE.ShaderLib.depthRGBA,a=THREE.UniformsUtils.clone(r.uniforms),o=new THREE.ShaderMaterial({fragmentShader:r.fragmentShader,vertexShader:r.vertexShader,uniforms:a}),o.blending=THREE.NoBlending,l(),e=new THREE.RenderPass(this.scene.root,this.scene.camera),t=new THREE.ShaderPass(THREE.SSAOShader),i=new THREE.ShaderPass(THREE.FXAAShader),h(),t.renderToScreen=!0,i.uniforms.resolution.value.set(1/this.scene.canvas.width,1/this.scene.canvas.height),i.renderToScreen=!1,this.scene.addEventListener("beforeRender2",d),this.scene.effectComposer.passes=[e,i,t],window.addEventListener("resize",f,!1),this.scene.camera.addEventListener("changedProjection",u),GIScene.Control.prototype.activate.call(this))},this.deactivate=function(){this.isActive&&(this.scene.effectComposer.passes=[],this.scene.camera.remove(s),this.scene.removeEventListener("beforeRender2",d),window.removeEventListener("resize",f,!1),this.scene.camera.removeEventListener("changedProjection",u),GIScene.Control.prototype.deactivate.call(this))}},GIScene.Control.SSAO.prototype=Object.create(GIScene.Control.prototype),GIScene.Control.EdgeDetectionFreiChen=function(){GIScene.Control.call(this);var e=null,t=null,i=1,n=1,r=.5,a=function(){t.uniforms.aspect.value.set(this.scene.canvas.width,this.scene.canvas.height),fxaaEffect.uniforms.resolution.value.set(1/this.scene.canvas.width,1/this.scene.canvas.height)}.bind(this);this.setIntensity=function(e){i=e,t&&(t.uniforms.intensity.value=i)},this.getIntensity=function(){return i},this.setThreshold=function(e){r=e,t&&(t.uniforms.threshold.value=r)},this.getThreshold=function(){return r},this.invert=function(){n=1==n?0:1,t&&(t.uniforms.invert.value=n)},this.activate=function(){this.isActive||(depthShader=THREE.ShaderLib.depthRGBA,depthUniforms=THREE.UniformsUtils.clone(depthShader.uniforms),depthMaterial=new THREE.ShaderMaterial({fragmentShader:depthShader.fragmentShader,vertexShader:depthShader.vertexShader,uniforms:depthUniforms}),depthMaterial.blending=THREE.NoBlending,e=new THREE.RenderPass(this.scene.root,this.scene.camera),unpackDepthRGBAEffect=new THREE.ShaderPass(THREE.UnpackDepthRGBAShader),unpackDepthRGBAEffect.renderToScreen=!1,t=new THREE.ShaderPass(THREE.EdgeShader),t.uniforms.aspect.value.set(this.scene.canvas.width,this.scene.canvas.height),t.uniforms.intensity.value=i,t.uniforms.invert.value=n,t.uniforms.threshold.value=r,t.renderToScreen=!1,fxaaEffect=new THREE.ShaderPass(THREE.FXAAShader),fxaaEffect.uniforms.resolution.value.set(1/this.scene.canvas.width,1/this.scene.canvas.height),fxaaEffect.renderToScreen=!0,this.scene.effectComposer.addPass(e),this.scene.effectComposer.addPass(t),this.scene.effectComposer.addPass(fxaaEffect),window.addEventListener("resize",a,!1),GIScene.Control.prototype.activate.call(this))
},this.deactivate=function(){this.isActive&&(this.scene.effectComposer.passes=[],window.removeEventListener("resize",a,!1),GIScene.Control.prototype.deactivate.call(this))}},GIScene.Control.EdgeDetectionFreiChen.prototype=Object.create(GIScene.Control.prototype),GIScene.Process=function(e){var t={identifier:null,title:null,"abstract":null,metadata:null,processVersion:null,description:{inputs:[],outputs:[]}};this.config=GIScene.Utils.mergeObjects(t,e||{}),this.identifier=this.config.identifier,this.title=this.config.title,this.abstract=this.config.abstract,this.metadata=this.config.metadata,this.processVersion=this.config.processVersion,this.description=this.config.description,this.data={inputs:{},outputs:{}}},GIScene.Process.prototype={constructor:GIScene.Process,setInput:function(e,t){this.data.inputs[e]=t},setInputs:function(e){for(param in e)this.setInput(param,e[param])},getOutput:function(e){return this.data.outputs[e]},getOutputs:function(){return this.data.outputs},getParamDescriptionById:function(e){var t=this.description.inputs,i=this.description.outputs,n=t.concat(i),r=n.filter(function(t){return t.identifier==e});return r=0==r.length?void 0:r[0]},addEventListener:THREE.EventDispatcher.prototype.addEventListener,hasEventListener:THREE.EventDispatcher.prototype.hasEventListener,removeEventListener:THREE.EventDispatcher.prototype.removeEventListener,dispatchEvent:THREE.EventDispatcher.prototype.dispatchEvent},GIScene.Process.LineOfSight=function(){var e={identifier:"GIScene:lineOfSight",title:"Line of Sight","abstract":"Given two loactions and possible obstacle objects this process will compute the visibility between the two loactions and provides a graphical 3D line.",metadata:null,processVersion:"1.0",description:{inputs:[{identifier:"GIScene:lineOfSight:observerPoint",title:"Observer Point","abstract":"Point of Observer, where the line of sight starts.",dataType:"THREE.Vector3",minOccurs:1,maxOccurs:1},{identifier:"GIScene:lineOfSight:observerOffset",title:"Observer Offset","abstract":"Additional height offset to observer point.",dataType:"Number",minOccurs:0,maxOccurs:1,defaultValue:0},{identifier:"GIScene:lineOfSight:targetPoint",title:"Tartget Point","abstract":"Point of Target, where the line of sight ends.",dataType:"THREE.Vector3",minOccurs:1,maxOccurs:1},{identifier:"GIScene:lineOfSight:targetOffset",title:"Target Offset","abstract":"Additional height offset to target point.",dataType:"Number",minOccurs:0,maxOccurs:1,defaultValue:0},{identifier:"GIScene:lineOfSight:obstacles",title:"Obstacles","abstract":"Possible obstacles to be reflected in the calculation.",dataType:"Array(THREE.Mesh)",minOccurs:1,maxOccurs:1}],outputs:[{identifier:"GIScene:lineOfSight:lineOfSight",title:"Line Of Sight","abstract":"The calculated Line of Sight between observer and target.",dataType:"THREE.Object3D"},{identifier:"GIScene:lineOfSight:isVisible",title:"Target is visible","abstract":"The result of the visibility calculation.",dataType:"boolean"}]}};GIScene.Process.apply(this,[e]),this.config.description.inputs.forEach(function(e){void 0!=e.defaultValue&&this.setInput(e.identifier,e.defaultValue)}.bind(this)),this.raycaster=new THREE.Raycaster;var t=new THREE.LineBasicMaterial({color:new THREE.Color(65280)}),i=new THREE.LineBasicMaterial({color:new THREE.Color(16711680)});this.execute=function(){var e=this.data.inputs["GIScene:lineOfSight:observerPoint"],n=this.data.inputs["GIScene:lineOfSight:observerOffset"],r=this.data.inputs["GIScene:lineOfSight:targetPoint"],a=this.data.inputs["GIScene:lineOfSight:targetOffset"],o=this.data.inputs["GIScene:lineOfSight:obstacles"],s=e.clone().add(new THREE.Vector3(0,n,0)),c=r.clone().add(new THREE.Vector3(0,a,0)),l=c.clone().sub(s).normalize();this.raycaster.set(s,l),this.raycaster.far=s.distanceTo(c),console.log("far",this.raycaster.far);var h=this.raycaster.intersectObjects(o,!0);console.log("intersections",h);var d=!0,u=new THREE.Object3D;if(h.length>0){d=!1;var f=new THREE.Geometry;f.vertices=[s,h[0].point];var m=new THREE.Line(f,t),p=new THREE.Geometry;p.vertices=[h[0].point,c];var v=new THREE.Line(p,i);u.add(m),u.add(v)}else{var g=new THREE.Geometry;g.vertices=[s,c];var m=new THREE.Line(g,t);u.add(m)}return this.data.outputs["GIScene:lineOfSight:lineOfSight"]=u,this.data.outputs["GIScene:lineOfSight:isVisible"]=d,console.log(this._listeners),this.dispatchEvent({type:"execute",content:this.data}),this.data}},GIScene.Process.LineOfSight.prototype=Object.create(GIScene.Process.prototype),GIScene.Process.LineOfSight_simpleClient=function(){var e={identifier:"GIScene:lineOfSight",title:"Line of Sight","abstract":"Given two locations and possible obstacle objects this process will compute the visibility between the two locations and provides a graphical 3D line.",metadata:null,processVersion:"1.0",description:{inputs:[{identifier:"GIScene:lineOfSight:observerPoint",title:"Observer Point","abstract":"Point of Observer, where the line of sight starts.",dataType:"GIScene.Coordinate3",maxOccurs:1},{identifier:"GIScene:lineOfSight:observerOffset",title:"Observer Offset","abstract":"Additional height offset to observer point.",dataType:"Number",minOccurs:0,maxOccurs:1,defaultValue:0},{identifier:"GIScene:lineOfSight:targetPoint",title:"Tartget Point","abstract":"Point of Target, where the line of sight ends.",dataType:"GIScene.Coordinate3",minOccurs:1,maxOccurs:1},{identifier:"GIScene:lineOfSight:targetOffset",title:"Target Offset","abstract":"Additional height offset to target point.",dataType:"Number",minOccurs:0,maxOccurs:1,defaultValue:0},{identifier:"GIScene:lineOfSight:obstacleLayers",title:"Obstacle Layers","abstract":"Layers whose objects are possible obstacles to be reflected in the calculation.",dataType:"Array(GIScene.Layer)",minOccurs:1,maxOccurs:"unbounded"}],outputs:[{identifier:"GIScene:lineOfSight:lineOfSight",title:"Line Of Sight","abstract":"The calculated Line of Sight between observer and target.",dataType:"THREE.Object3D"},{identifier:"GIScene:lineOfSight:isVisible",title:"Target is visible","abstract":"The result of the visibility calculation.",dataType:"boolean"}]}};GIScene.Process.apply(this,[e]),this.config.description.inputs.forEach(function(e){void 0!=e.defaultValue&&this.setInput(e.identifier,e.defaultValue)}.bind(this)),this.raycaster=new THREE.Raycaster;var t=new THREE.LineBasicMaterial({color:new THREE.Color(65280)}),i=new THREE.LineBasicMaterial({color:new THREE.Color(16711680)});this.execute=function(e){var n=this.data.inputs["GIScene:lineOfSight:observerPoint"];console.log("observerc3"),console.log(n);var r,a,o=this.data.inputs["GIScene:lineOfSight:observerOffset"],s=this.data.inputs["GIScene:lineOfSight:targetPoint"],c=this.data.inputs["GIScene:lineOfSight:targetOffset"],l=this.data.inputs["GIScene:lineOfSight:obstacleLayers"],e=e||function(){},h=l[0].scene,d=n.clone().sub(h.config.offset).toVector3(),u=s.clone().sub(h.config.offset).toVector3(),f=d.clone().add(new THREE.Vector3(0,o,0)),m=u.clone().add(new THREE.Vector3(0,c,0)),p=m.clone().sub(f).normalize(),v=null,g=0,E=!1;this.raycaster.set(f,p),this.raycaster.far=f.distanceTo(m),console.log("far",this.raycaster.far);var y=function(e,t,i){return i.distance>t.distance?t:i},S=function(e,t){return t?v?(v=y(f,e,t),v===t?(b(),!0):void 0):(v=t,b(),!0):!1},b=function(){if(M[0].LineOfSightAnalysisController)for(var e=0,t=M.length;t>e;e++){var i=M[e],n=v?i.grid.getIndexFromPoint2d(GIScene.Utils.vector3ToVector2(v.point),i.LineOfSightAnalysisController.smallestTileSize):void 0;i.LineOfSightAnalysisController.analysisTiles.forEach(function(e,t){n&&e.equals(n)&&(i.LineOfSightAnalysisController.nearestIntersectionTileIndex=t)}.bind(this))}},T=function(e){for(var t=!1,i=0,n=e.length;n>i;i++){if(void 0===e[i]){t=-1;break}if(e[i]===!0){t=!0;break}}return t},R=function(n){if(n)var r=n.LineOfSightAnalysisController;if(r)var o=r.computeTileIndicesHandler,s=r.loading;if(n&&s){var c=0;for(tile in s.store)s.store[tile].object.abort(),c++,s.remove((new GIScene.Grid.Index).fromString(tile));console.log(n.name+": optimized uncached tiles by abort running requests: "+c)}if(o&&(n.computeTileIndicesHandler=o),g!=l.length)return console.log("Number of checked Layers",g),void 0;E=!0,console.log("Number of checked Layers",g,"Ready."),M.forEach(function(e){e.startUpdate(),e.LineOfSightAnalysisController=null,r=null,delete e.LineOfSightAnalysisController}),console.log("THE END");var h=new THREE.Object3D;if(v){a=!1;var d=new THREE.Geometry;d.vertices=[f,v.point];var u=new THREE.Line(d,t),p=new THREE.Geometry;p.vertices=[v.point,m];var y=new THREE.Line(p,i);h.add(u),h.add(y)}else{a=!0;var S=new THREE.Geometry;S.vertices=[f,m];var u=new THREE.Line(S,t);h.add(u)}this.data.outputs["GIScene:lineOfSight:lineOfSight"]=h,this.data.outputs["GIScene:lineOfSight:isVisible"]=a,this.dispatchEvent({type:"execute",content:this.data}),e(this.data)}.bind(this),w=function(e,t){var i=t.LineOfSightAnalysisController,n=i.loading,a=i.controlArray,o=i.uncachedTilesIndex,s=i.uncachedTiles[e],c=t.config.service.getGetSceneUrl(s,t.grid),l=function(c){var l=!0;if(console.log(t.name+": LineOfSight:load uncached tiles:onSuccess",e),i.layerChecked)return console.log(t.name+": Analysis already DONE!"),void 0;if(n.remove(s),console.log("nearestIntersectionTileIndex",i.nearestIntersectionTileIndex),e>i.nearestIntersectionTileIndex&&(console.log("already behind nearest intersection. SKIP processing loaded tile."),l=!1,a[o[e]]=!1),l){if("Z"==t.verticalAxis.toUpperCase()&&c.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2)),t.setOverrideMaterial(c,t.config.overrideMaterial),t.root.add(c),c.updateMatrixWorld(),c.traverse(function(e){e.geometry&&e.geometry.computeBoundingBox()}),r=this.raycaster.intersectObject(t.root,!0),r.length>0){var h=S(v,r[0]);h&&(i.nearestIntersectionTileIndex=o[e]),console.log("nearestIntersectionTileIndex",i.nearestIntersectionTileIndex),a[o[e]]=!0}else a[o[e]]=!1;t.root.remove(c)}t.cache.add(s,c);var d=T(a);console.log("doreturnResults?",-1!==d),console.log("intersectionsLength: ",r.length),console.log("Loading Requests:",n.length),-1!==d&&(g++,i.layerChecked=!0,console.log(t.name+" : firstIntersection found! Layer checked by UNCACHED!"),R(t))}.bind(this),h=function(i){console.log(i),console.log(t.name+": LineOfSight:load uncached tiles:onError",e),n.remove(s),alert("XHRError")}.bind(this),d=new GIScene.ModelLoader;d.load(c,t.format,l,void 0,h),n.add(s,d)}.bind(this),M=[],I=[];l.forEach(function(e){e instanceof GIScene.Layer.Grid?M.push(e):I.push(e)}),console.log("obstacle layers",l.length),console.log("static layers",I.length),console.log("grid layers",M.length);for(var L=0,A=I.length;A>L;L++)r=this.raycaster.intersectObject(I[L].root,!0),r.length>0&&S(v,r[0]),g++,console.log(I[L].name+" : Layer checked STATIC!"),R();for(var L=0,A=M.length;A>L;L++){var x=M[L],C=x.grid;x.LineOfSightAnalysisController={};var D=x.LineOfSightAnalysisController;D.layerChecked=!1,D.loading=new GIScene.Grid.TileStore,D.smallestTileSize=C.tileSizes[C.tileSizes.length-1];var H=(new GIScene.Coordinate2).fromVector2(GIScene.Utils.vector3ToVector2(d.clone().add(C._sceneOffset))),G=(new GIScene.Coordinate2).fromVector2(GIScene.Utils.vector3ToVector2(u.clone().add(C._sceneOffset))),O=v?(new GIScene.Coordinate2).fromVector2(GIScene.Utils.vector3ToVector2(v.point.clone().add(C._sceneOffset))):G,P=C.getTilesFromLineIntersection(H,G,D.smallestTileSize);D.analysisTiles=C.getTilesFromLineIntersection(H,O,D.smallestTileSize),console.log(x.name+": "+O.toArray()),console.log(x.name+": optimized number of tiles: "+D.analysisTiles.length+"/"+P.length+" "+100*D.analysisTiles.length/P.length+"%"),D.controlArray=Array(D.analysisTiles.length),D.computeTileIndicesHandler=x.computeTileIndicesHandler,x.stopUpdate(),x.computeTileIndicesHandler=function(){return[]},x.update(),D.cachedTiles=[],D.cachedTilesIndex=[],D.uncachedTiles=[],D.uncachedTilesIndex=[],D.nearestIntersectionTileIndex=void 0,D.analysisTiles.forEach(function(e,t){var i=x.cache.getTile(e);i?(D.cachedTiles.push(i),D.cachedTilesIndex.push(t)):(D.uncachedTiles.push(e),D.uncachedTilesIndex.push(t))}.bind(this)),console.log(x.name+": cached / uncached tiles",D.cachedTiles.length,D.uncachedTiles.length)}for(var L=0,A=M.length;A>L;L++){var x=M[L],D=x.LineOfSightAnalysisController;console.log("Start Analyzing "+x.name),console.log(x.name+": Analyzing "+D.cachedTiles.length+" CACHED tiles");for(var k=0,F=D.cachedTiles.length;F>k;k++){var j=D.cachedTiles[k];if(x.root.add(j),r=this.raycaster.intersectObject(x.root,!0),r.length>0){var B=S(v,r[0]);B&&(D.nearestIntersectionTileIndex=D.cachedTilesIndex[k]),console.log("nearestIntersectionTileIndex",D.nearestIntersectionTileIndex),D.controlArray[D.cachedTilesIndex[k]]=!0}else D.controlArray[D.cachedTilesIndex[k]]=!1;x.root.remove(j);var U=T(D.controlArray);if(console.log(x.name+" :firstIntersectionTile",U,D.controlArray.length),-1!==U){g++,console.log(x.name+" : firstIntersection found! Layer checked by CACHED!"),R(x),D.layerChecked=!0;break}}}if(!E)for(var L=0,A=M.length;A>L;L++){var x=M[L],D=x.LineOfSightAnalysisController;if(D.layerChecked)return;if(v){for(var N=null,V=D.uncachedTilesIndex.length-1,z=0;V>=z;V--)D.uncachedTilesIndex[V]>=D.nearestIntersectionTileIndex&&(N=V);if(null!=N){console.log("controlArray:before",D.controlArray);var _=D.uncachedTiles.length;D.uncachedTiles.splice(N,Number.MAX_VALUE);for(var W=N,Z=_;Z>W;W++)D.controlArray[D.uncachedTilesIndex[W]]=!1;D.uncachedTilesIndex.splice(N,Number.MAX_VALUE),console.log(x.name+": optimized number of uncached tiles: "+_+"-->"+D.uncachedTiles.length)}}console.log(x.name+": Analyzing "+D.uncachedTiles.length+" UNCACHED tiles");for(var Y=0,X=D.uncachedTiles.length;X>Y;Y++)w(Y,x)!==!1}}},GIScene.Process.LineOfSight_simpleClient.prototype=Object.create(GIScene.Process.prototype),GIScene.Process.Intervisibility=function(e){var t={identifier:"GIScene:intervisibility",title:"Intervisibility","abstract":"Given two loactions, observer and target offsets and possible obstacle objects this process will compute the intervisibility between each observer and target of the two loactions and provides graphical 3D lines.",metadata:null,processVersion:"1.0",description:{inputs:[{identifier:"GIScene:intervisibility:points",title:"Intervisibility Points","abstract":"Two points between the intervisibility will be calculated. Each point should provide attributes about observer and target offset.",dataType:"Array of GIScene.Coordinate3",minOccurs:1,maxOccurs:1},{identifier:"GIScene:intervisibility:observerOffsets",title:"Observer Offsets","abstract":"Additional height offsets to the observer points.",dataType:"Array of Number",minOccurs:0,maxOccurs:1,defaultValue:[]},{identifier:"GIScene:intervisibility:targetOffsets",title:"Target Offsets","abstract":"Additional height offsets to the target points.",dataType:"Array of Number",minOccurs:0,maxOccurs:1,defaultValue:[]},{identifier:"GIScene:intervisibility:obstacleLayers",title:"Obstacle Layers","abstract":"Layers with possible obstacles to be reflected in the calculation.",dataType:"Array(GIScene.Layer)",minOccurs:1,maxOccurs:1}],outputs:[{identifier:"GIScene:intervisibility:intervisibilityLines",title:"Intervisibility Lines","abstract":"The calculated Lines of Sight between observers and targets.",dataType:"THREE.Object3D"},{identifier:"GIScene:intervisibility:intervisibility",title:"Intervisibility","abstract":'The result of the intervisibility calculation.<ul><li>"00": Both observer can NOT see their targets.</li><li>"01": The target of the second point is visible to the observer of the first one.</li><li>"10": The target of the first point is visible to the observer of the second one.</li><li>"11": Both observer can see their targets. They are intervisible.</li></ul>',dataType:"String"},{identifier:"GIScene:intervisibility:intervisibilityLine",title:"Intervisibility Line","abstract":"One feature (LineString) representing the relation between the two tested points, indicated by it's intervisibility attribute",dataType:"GeoJSON"}]}};GIScene.Process.apply(this,[t]),this.config.description.inputs.forEach(function(e){void 0!=e.defaultValue&&this.setInput(e.identifier,e.defaultValue)}.bind(this));var i=new THREE.LineBasicMaterial({color:new THREE.Color(65280)}),n=new THREE.LineBasicMaterial({color:new THREE.Color(16711680)});this.execute=function(t){var r=this.data.inputs["GIScene:intervisibility:points"],a=this.data.inputs["GIScene:intervisibility:observerOffsets"],o=this.data.inputs["GIScene:intervisibility:targetOffsets"],s=this.data.inputs["GIScene:intervisibility:obstacleLayers"];t=t||function(){};var c=a.length>0||o.length>0,l=[r[0].toVector3(),r[1].toVector3()],h=function(e,t,r){var a=r?i:n,o=new THREE.Geometry;o.vertices=[e,t];var s=new THREE.Line(o,a),c={isVisible:r};return s.userData.gisceneAttributes=c,s.name="Line of Sight",s},d=function(){var i=new THREE.Object3D;i.userData.gisceneAttributes={},i.name="Intervisibility";var n=u.getOutput("GIScene:lineOfSight:isVisible"),s=l[0].clone().add(new THREE.Vector3(0,a[0]||0,0)),d=l[1].clone().add(new THREE.Vector3(0,o[1]||0,0)),m=h(s,d,n);if(i.add(m),c){var p=f.getOutput("GIScene:lineOfSight:isVisible"),v=l[1].clone().add(new THREE.Vector3(0,a[1]||0,0)),g=l[0].clone().add(new THREE.Vector3(0,o[0]||0,0)),E=h(v,g,p);i.add(E)}var y=c?Number(p)+""+Number(n):Number(n)+""+Number(n);i.userData.gisceneAttributes.intervisibility=y,this.data.outputs["GIScene:intervisibility:intervisibilityLines"]=i,this.data.outputs["GIScene:intervisibility:intervisibility"]=y;var S={type:"Feature",geometry:{type:"LineString",coordinates:[r[0].toArray(),r[1].toArray()]},properties:{intervisibility:y}};e.config.projection&&(S.crs={type:"name",properties:{name:e.config.projection}}),this.data.outputs["GIScene:intervisibility:intervisibilityLine"]=JSON.stringify(S),this.dispatchEvent({type:"execute",content:this.data}),t(this.data)}.bind(this),u=new GIScene.Process.LineOfSight_simpleClient;if(u.setInput("GIScene:lineOfSight:observerPoint",r[0]),a[0]&&u.setInput("GIScene:lineOfSight:observerOffset",a[0]),u.setInput("GIScene:lineOfSight:targetPoint",r[1]),o[1]&&u.setInput("GIScene:lineOfSight:targetOffset",o[1]),u.setInput("GIScene:lineOfSight:obstacleLayers",s),c){var f=new GIScene.Process.LineOfSight_simpleClient;f.setInput("GIScene:lineOfSight:observerPoint",r[1]),a[1]&&f.setInput("GIScene:lineOfSight:observerOffset",a[1]),f.setInput("GIScene:lineOfSight:targetPoint",r[0]),o[0]&&f.setInput("GIScene:lineOfSight:targetOffset",o[0]),f.setInput("GIScene:lineOfSight:obstacleLayers",s)}var m=function(){if(c){var e=function(){d()}.bind(this);f.execute(e)}else d()}.bind(this);u.execute(m)}},GIScene.Process.Intervisibility.prototype=Object.create(GIScene.Process.prototype),GIScene.Process.LineOfSightNetwork_allToAll=function(){var e={identifier:"GIScene:lineOfSight:network:allToall",title:"Line of Sight Network (all to all)","abstract":"Given an input set of point locations with each of them providing an attribute for an observer offset and a target offset, this process will compute the intervisibility between the two locations by computing two lines of sights between each pair of points. Always from the observer offset of one point to the target offset of the other.",metadata:null,processVersion:"1.0",description:{inputs:[{identifier:"GIScene:lineOfSight:network:intervisibilityPoints",title:"Intervisibility Points (layer)","abstract":"Layer with points, which will be checked for intervisibility.",dataType:"GIScene.Layer",minOccurs:1,maxOccurs:1},{identifier:"GIScene:lineOfSight:network:observerOffsetAttribute",title:"Observer Offset Attribute","abstract":"Attribute with additional height offsets to observer points.",dataType:"String",minOccurs:0,maxOccurs:1,defaultValue:""},{identifier:"GIScene:lineOfSight:network:targetOffsetAttribute",title:"Tartget Offset Attribute","abstract":"Attribute with additional height offsets to target points.",dataType:"String",minOccurs:0,maxOccurs:1,defaultValue:""},{identifier:"GIScene:lineOfSight:obstacleLayers",title:"Obstacle Layers","abstract":"Layers whose objects are possible obstacles to be reflected in the calculation.",dataType:"Array(GIScene.Layer)",minOccurs:1,maxOccurs:"unbounded"}],outputs:[{identifier:"GIScene:lineOfSight:network:intervisibilityNetwork",title:"Intervisibility Network","abstract":"A set of calculated Line of Sights between observer and target points.",dataType:"THREE.Object3D"},{identifier:"GIScene:lineOfSight:network:numberOfVisibleTargets",title:"Number of visible targets","abstract":"The number of visible targets or unobstructed individual line of sights.",dataType:"Number"},{identifier:"GIScene:lineOfSight:network:numberOfObstructedTargets",title:"Number of obstructed targets","abstract":"The number of not visible targets or obstructed individual line of sights.",dataType:"Number"},{identifier:"GIScene:lineOfSight:network:numberOfIntervisiblePairs",title:"Number of intervisible pairs","abstract":"The number of intervisible pairs of input points.",dataType:"Number"},{identifier:"GIScene:lineOfSight:network:intervisibilityLines",title:"Intervisibility Lines","abstract":"FeatureCollection (LineStrings) representing the relations between the tested pairs of points, indicated by their intervisibility attributes.",dataType:"GeoJSON"}]}};GIScene.Process.apply(this,[e]),this.config.description.inputs.forEach(function(e){void 0!=e.defaultValue&&this.setInput(e.identifier,e.defaultValue)}.bind(this)),this.execute=function(e){e=e||function(){};var t=this.data.inputs["GIScene:lineOfSight:network:intervisibilityPoints"],i=this.data.inputs["GIScene:lineOfSight:network:observerOffsetAttribute"],n=this.data.inputs["GIScene:lineOfSight:network:targetOffsetAttribute"],r=this.data.inputs["GIScene:lineOfSight:obstacleLayers"],a=0,o=[],s=[],c=[];t.root.traverse(function(e){if(e.geometry){var r=e.geometry.vertices[0],a=e.localToWorld(r.clone());if(!t.scene)return console.error("LineOfSightNetwork_allToAll: Layer: "+t.name+" must be added to scene before analysing."),void 0;var l=(new GIScene.Coordinate3).fromVector3(a).add(t.scene.config.offset);o.push(l),s.push(e.userData.gisceneAttributes[i]||0),c.push(e.userData.gisceneAttributes[n]||0)}}.bind(this));var l=(o.length-1)*(o.length/2),h=Array(l),d=new THREE.Object3D;d.name="Intervisibility Network",d.userData.gisceneAttributes={};for(var u=0,f=0,m=0,p=[],v=function(){d.userData.gisceneAttributes.numVisTargets=u,d.userData.gisceneAttributes.numUnvisTargets=f,d.userData.gisceneAttributes.numIntervisiblePairs=m,this.data.outputs["GIScene:lineOfSight:network:intervisibilityNetwork"]=d,this.data.outputs["GIScene:lineOfSight:network:numberOfVisibleTargets"]=u,this.data.outputs["GIScene:lineOfSight:network:numberOfObstructedTargets"]=f,this.data.outputs["GIScene:lineOfSight:network:numberOfIntervisiblePairs"]=m;var i={type:"FeatureCollection",features:p};t.scene.config.projection&&(i.crs={type:"name",properties:{name:t.scene.config.projection}}),this.data.outputs["GIScene:lineOfSight:network:intervisibilityLines"]=JSON.stringify(i),this.dispatchEvent({type:"execute",content:this.data}),e(this.data)}.bind(this),g=function(e){a++,console.log("onExecuteIntervis",a,"of",l),console.log(e);var t=e.outputs["GIScene:intervisibility:intervisibilityLines"];d.add(t);var i=e.outputs["GIScene:intervisibility:intervisibility"];u+=parseInt(i)%9,f+=2-parseInt(i)%9,m+=2==parseInt(i)%9?1:0;var n=JSON.parse(e.outputs["GIScene:intervisibility:intervisibilityLine"]);delete n.crs,p.push(n),this.dispatchEvent({type:"progress",content:{total:l,finished:a}}),a==l?v():h[a].execute(g)}.bind(this),E=0,y=0,S=o.length;S-1>y;y++)for(var b=y+1;S>b;b++){var T=new GIScene.Process.Intervisibility(t.scene),R={"GIScene:intervisibility:points":[o[y],o[b]],"GIScene:intervisibility:observerOffsets":[s[y],s[b]],"GIScene:intervisibility:targetOffsets":[c[y],c[b]],"GIScene:intervisibility:obstacleLayers":r};T.setInputs(R),h[E++]=T}h[0].execute(g)}},GIScene.Process.LineOfSightNetwork_allToAll.prototype=Object.create(GIScene.Process.prototype),GIScene.Format={JSON:0,JSONBinary:1,OBJ:2,Collada:3,CTM:4,Scene:5,GeoJSON:6},GIScene.LocalFileLoader=function(e,t,i,n,r){this.fileReader=new FileReader;var a=function(e){var a=e.target.files,o=a[0],s=o.name;switch(this.fileReader.onload=function(){i&&i(this.fileReader.result,s)}.bind(this),this.fileReader.onprogress=function(e){n&&n(e,s)},this.fileReader.onerror=function(){r&&r(this.fileReader.error,s)}.bind(this),t.toUpperCase()){case"TEXT":this.fileReader.readAsText(o);break;case"DATAURL":this.fileReader.readAsDataURL(o);break;case"BINARYSTRING":this.fileReader.readAsBinaryString(o);break;case"ARRAYBUFFER":this.fileReader.readAsArrayBuffer(o)}}.bind(this);e.addEventListener("change",a,!1)},GIScene.GeoJSONLoader=function(){this.onLoadStart=function(){},this.onLoadProgress=function(){},this.onLoadComplete=function(){},this.loader=new THREE.XHRLoader(this.manager),this.symbol=THREE.ImageUtils.loadTexture(GIScene.LIBRARYPATH+GIScene.RESOURCESPATH.replace(/([^\/])$/,"$1/")+"resources/images/particle_cross.png")},GIScene.GeoJSONLoader.prototype={constructor:GIScene.GeoJSONLoader,load:function(e,t,i,n,r){var a=this.loader;a.setCrossOrigin(this.crossOrigin),a.load(e,function(e){try{this.parse(JSON.parse(e),t,r)}catch(i){console.log("GeoJsonLoader"),console.log(i),console.log("ResponseText",e),n&&n(i,e)}}.bind(this))},setCrossOrigin:function(e){this.crossOrigin=e},parse:function(e,t,i){var n=new THREE.Scene,r=e.type;t=t||function(){};var a=function(e,t){return t=t||0,new THREE.Vector3(e[0],t,-e[1])},o=function(e){return new THREE.Vector3(e[0],e[2],-e[1])},s=function(e,t){var i,n,r,s=e.type;switch(s){case"Point":i=new THREE.Geometry,!t&&e.coordinates.length>2?o(e.coordinates):a(e.coordinates,t),i.vertices.push(a(e.coordinates,t)),n=new THREE.PointsMaterial({color:new THREE.Color(16711680),sizeAttenuation:!1,size:32,map:this.symbol,alphaTest:.5}),r=new THREE.Points(i,n);break;default:console.error(s,"Not supported by GeoJSONLoader")}return r}.bind(this),c=function(e,t){var i=parseFloat(e.properties[t])||null,n=s(e.geometry,i);return n.userData.gisceneAttributes=e.properties,n};switch(r){case"Feature":n.add(c(e,i));break;case"FeatureCollection":for(var l=e.features,h=0,d=l.length;d>h;h++)n.add(c(l[h],i));break;default:console.log(r,"GeoJson type not supported by GeoJSONLoader")}return t(n),n},getType:function(e){return e.type},getExampleValues:function(e){var t=this.getType(e);switch(t){case"Feature":var i=e.properties,n=[];for(property in i)n.push(i[property]);return n;case"FeatureCollection":var i=e.features[0].properties,n=[];for(property in i)n.push(i[property]);return n;default:return this.isGeometry(e)?[]:(alert("GeoJSON seems to be invalid"),[])}},getAttributeNames:function(e){var t=this.getType(e);switch(t){case"Feature":return Object.keys(e.properties);case"FeatureCollection":return Object.keys(e.features[0].properties);default:return this.isGeometry(e)?[]:(alert("GeoJSON seems to be invalid"),[])}},isGeometry:function(e){return"Point"==e.type||"MultiPoint"||"LineString"||"MultiLineString"||"Polygon"||"MultiPolygon"||"GeometryCollection"},hasZCoordinates:function(e){var t=this.getType(e),i=function(e){return"object"==typeof e[0]?findFirstCoordinate(e[0]):e.length>2},n=function(e){return"GeometryCollection"==e.type?i(e.geometries[0].coordinates):i(e.coordinates)},r=function(e){return n(e.geometry)};switch(t){case"Feature":return r(e);case"FeatureCollection":return r(e.features[0]);default:return n(e)}}},GIScene.ModelLoader=function(){this.url=null,this.format=null;var e=null;this.loader=null;var t=function(t,i){if(this.format==GIScene.Format.Scene)var n=t.scene;else{var r=t instanceof THREE.Geometry?0==t.faces.length?"Points":"Mesh":t.index&&0!=t.index.count?"Mesh":"Points";i&&0!=i.length?i.length>=2?i=new THREE.MeshFaceMaterial(i):i[0].map||"default"!=i[0].name.toLowerCase()?"Points"==r?(i[0].size=.2,i[0].vertexColors=THREE.VertexColors,i=new THREE.PointsMaterial(i[0])):i=i[0]:i="Mesh"==r?new THREE.MeshLambertMaterial({color:13808780,emissive:0}):new THREE.PointsMaterial({color:new THREE.Color(0),size:.2}):i="Mesh"==r?t.faces[0].vertexColors.length>0?new THREE.MeshLambertMaterial({shading:THREE.FlatShading,vertexColors:THREE.VertexColors}):16777215!=t.faces[0].color.getHex()?new THREE.MeshLambertMaterial({shading:THREE.FlatShading,vertexColors:THREE.FaceColors}):new THREE.MeshLambertMaterial({color:13808780,ambient:9139029,emissive:0,shading:THREE.FlatShading}):void 0,t.dynamic=!0;var a=new THREE[r](t,i),n=new THREE.Scene;n.add(a)}this.dispatchEvent({type:"load",content:n}),e&&e(n)}.bind(this),i=function(t){var i;i="color"in t.attributes?new THREE.MeshLambertMaterial({vertexColors:THREE.VertexColors}):new THREE.MeshLambertMaterial({color:13808780,ambient:9139029,emissive:0});var n=new THREE.Mesh(t,i),r=new THREE.Scene;r.add(n),this.dispatchEvent({type:"load",content:r}),e&&e(r)}.bind(this);this.load=function(n,r,a,o,s){var c=5;switch(e=a,this.dispatchEvent({type:"beforeLoad",content:null}),this.url=n,this.format=r,r){case GIScene.Format.JSON:this.loader=new THREE.JSONLoader,this.loader.load(n,t);break;case GIScene.Format.JSONBinary:this.loader=new THREE.BinaryLoader,this.loader.load(n,t);break;case GIScene.Format.CTM:this.loader=new THREE.CTMLoader,this.loader.load(n,i,{useWorker:!0,useBuffers:!1});break;case GIScene.Format.Scene:this.loader=new THREE.SceneLoader;var l=function(e){c--,c>0?(console.log("Retrying...: "+n),setTimeout(function(){this.loader.load(n,t,o,l)}.bind(this),1e3)):(console.error("Tried 5 times without success: "+n),s(e))}.bind(this);this.loader.load(n,t,o,l);break;default:console.log("Unknown Format. - GIScene/ModelLoader.js")}},this.abort=function(){this.loader.loader&&this.loader.loader.request?(this.loader.loader.request.abort(),this.dispatchEvent({type:"abort",content:null})):console.log("abort for this loader not yet implemented.")}},GIScene.ModelLoader.prototype={constructor:GIScene.ModelLoader,addEventListener:THREE.EventDispatcher.prototype.addEventListener,hasEventListener:THREE.EventDispatcher.prototype.hasEventListener,removeEventListener:THREE.EventDispatcher.prototype.removeEventListener,dispatchEvent:THREE.EventDispatcher.prototype.dispatchEvent},GIScene.Service=function(){},GIScene.Service.W3DS_0_4_0=function(e,t){var i={url:null,withCredentials:!1,tileSizes:null},n={service:"W3DS",version:"0.4.0",format:"model/threejs",crs:null,layer:null,offset:null};this.config=GIScene.Utils.mergeObjects(i,e),this.params=GIScene.Utils.mergeObjects(n,t),this.url=this.config.url.trim().replace(/(\/|\?)*$/,"?"),this.getGetSceneUrl=function(e,t){var i="GetScene";e.tileSize;var n=t.getBoundingBoxFromIndex(e),r=(new GIScene.Coordinate2).fromVector2(new THREE.Vector2(n.left,n.bottom)).add(t.sceneOffset).toArray().join(","),a=(new GIScene.Coordinate2).fromVector2(new THREE.Vector2(n.right,n.top)).add(t.sceneOffset).toArray().join(","),o=["SERVICE="+this.params.service,"REQUEST="+i,"VERSION="+this.params.version,"CRS="+this.params.crs,"BOUNDINGBOX="+r+","+a,"FORMAT="+this.params.format,"LAYERS="+this.params.layer,this.params.offset?"OFFSET="+this.params.offset:""].join("&");return this.url+o},this.getGetTileUrl=function(e){var t=this.config.tileSizes.indexOf(e.tileSize),i=e.x,n=e.y,r="GetTile",a=["SERVICE="+this.params.service,"REQUEST="+r,"VERSION="+this.params.version,"FORMAT="+this.params.format,"CRS="+this.params.crs,"LAYER="+this.params.layer,"TILELEVEL="+t,"TILECOL="+i,"TILEROW="+n].join("&");return this.url+a},this.getTile=function(e,t,i){var n=this.getGetTileUrl(e);t=t||function(){},i=i||function(){};var r=new XMLHttpRequest;r.addEventListener("load",t,!1),r.addEventListener("error",i,!1),r.addEventListener("error",function(e){console.log("Error on GIScene.Service.W3DS_0_4_0"),console.log(e)},!1),r.open(method,n,!0),r.withCredentials=this.config.withCredentials;try{r.send(null)}catch(a){console.log(a)}}},GIScene.Service.W3DS_0_4_0.prototype=Object.create(GIScene.Service.prototype),GIScene.Service.W3DS_0_4_1=function(e,t){var i={url:null,withCredentials:!1,tileSizes:null},n={service:"W3DS",version:"0.4.1",format:"model/threejs",crs:null,layer:null,offset:null,lods:null};
this.config=GIScene.Utils.mergeObjects(i,e),this.params=GIScene.Utils.mergeObjects(n,t),this.url=this.config.url.trim().replace(/(\/|\?)*$/,"?"),this.getGetSceneUrl=function(e,t){var i="GetScene";e.tileSize;var n=t.getBoundingBoxFromIndex(e),r=(new GIScene.Coordinate2).fromVector2(new THREE.Vector2(n.left,n.bottom)).add(t.sceneOffset).toArray().join(","),a=(new GIScene.Coordinate2).fromVector2(new THREE.Vector2(n.right,n.top)).add(t.sceneOffset).toArray().join(","),o=["SERVICE="+this.params.service,"REQUEST="+i,"VERSION="+this.params.version,"CRS="+this.params.crs,"BOUNDINGBOX="+r+","+a,"FORMAT="+this.params.format,"LAYERS="+this.params.layer,this.params.lods?"LOD="+this.params.lods:"",this.params.offset?"OFFSET="+this.params.offset:""].join("&");return this.url+o},this.getGetTileUrl=function(e){var t=this.config.tileSizes.indexOf(e.tileSize),i=e.x,n=e.y,r="GetTile",a=["SERVICE="+this.params.service,"REQUEST="+r,"VERSION="+this.params.version,"FORMAT="+this.params.format,"CRS="+this.params.crs,"LAYER="+this.params.layer,"TILELEVEL="+t,"TILECOL="+i,"TILEROW="+n].join("&");return this.url+a},this.getTile=function(e,t,i){var n=this.getGetTileUrl(e);t=t||function(){},i=i||function(){};var r=new XMLHttpRequest;r.addEventListener("load",t,!1),r.addEventListener("error",i,!1),r.addEventListener("error",function(e){console.log("Error on GIScene.Service.W3DS_0_4_0"),console.log(e)},!1),r.open(method,n,!0),r.withCredentials=this.config.withCredentials;try{r.send(null)}catch(a){console.log(a)}}},GIScene.Service.W3DS_0_4_0.prototype=Object.create(GIScene.Service.prototype),GIScene.Style=function(e){var t={name:null,title:"unnamed",material:null,rootObjects:null,rootObjectKeyAttribute:null,rootObjectKeyValues:[],recursive:!0};this.config=GIScene.Utils.mergeObjects(t,e||{});for(property in this.config)this[property]=this.config[property];this.id=GIScene.idCounter++,this.name=this.config.name||this.id},GIScene.Layer=function(e,t){var i={id:null,visibility:!0,opacity:1,overrideMaterial:null,projection:null,offset:new GIScene.Coordinate3(0,0,0),listeners:[],styles:[],attributeReader:null,properties:{fields:[]},attributeTable:[]};this.config=GIScene.Utils.mergeObjects(i,t||{}),this.id=this.config.id||GIScene.idCounter++,this.name=null,this.offset=null;var n=null;this.root=null,this.scene=null,this.loader=null,this.visibility=null,this.selectControl=null,this.attributeReader=null,this.selectionQueryStack=null;var r=new GIScene.Style({title:"default style",material:this.config.overrideMaterial});this.styles=[r],Array.prototype.push.apply(this.styles,this.config.styles),this.init=function(){this.name=e,this.root=new THREE.Group,this.root.name="layer"+(this.name?"_"+this.name:""),this.offset=this.config.offset,this.loader=new GIScene.ModelLoader,this.attributeReader=this.config.attributeReader,this.visibility=this.config.visibility},this.add=function(e,t){t=t||this,t.add(e)},this.remove=function(e){e.parent.remove(e)},this.setScene=function(e){this.scene=e,this.dispatchEvent({type:"setScene",content:e})},this.setOpacity=function(e){this.root.traverse(function(t){GIScene.Utils.WorkingMaterial.setOpacity(t,e)})},this.addStyle=function(e){this.styles.push(e),this.dispatchEvent({type:"addStyle",content:{layer:this,style:e}})},this.removeStyle=function(e){for(var t=0,i=this.styles.length;i>t;t++)this.styles[t]===e&&(this.styles.splice(t,1),this.dispatchEvent({type:"removeStyle",content:{layer:this,style:e}}))},this.disposeStyle=function(e){this.removeStyle(e);var t=[],i=[];e.material&&(e.material instanceof THREE.MeshFaceMaterial?e.material.materials.forEach(function(e){GIScene.Utils.arrayContains(t,e)||t.push(e)}):GIScene.Utils.arrayContains(t,e.material)||t.push(e.material)),t.forEach(function(e){for(var t=["map","lightMap","bumpMap","normalMap","specularMap","envMap","texture"],n=0,r=t.length;r>n;n++)e[t[n]]&&null!=e[t[n]]&&!GIScene.Utils.arrayContains(i,e[t[n]])&&i.push(e[t[n]])}),i.forEach(function(e){e.dispose()}),i=null,t.forEach(function(e){e.dispose()}),t=null,delete e.material,e=null},this.init();var a=function(e){var t=e.content;if(this.offset=this.config.offset,n=t?this.offset.toVector3().sub(t.config.offset.toVector3()):new THREE.Vector3,this.root.position.copy(n),this.root.updateMatrix(),this.root.updateMatrixWorld(),console.log("translateLayer: "+n.toArray()),t){this.selectControl=new GIScene.Control.Select([],t.camera,{multi:!0,selectColor:16744448}),this.selectControl.selectables=GIScene.Utils.getDescendants(this.root),t.addControl(this.selectControl);var i=function(e){e.content===this&&(t.removeControl(this.selectControl),this.selectControl.selectables=[],this.selectControl=null,t.removeEventListener("beforeremovelayer",i))}.bind(this);t.addEventListener("beforeremovelayer",i)}}.bind(this);this.addEventListener("setScene",a)},GIScene.Layer.prototype={constructor:GIScene.Layer,getObjectsBy:function(e){return GIScene.Utils.getObjectsBy(this.root,e)},selectByAttributes:function(e,t,i){var t=t?t:this.root;this.selectionQueryStack=e instanceof Array?e:[e];for(var n=0,r=this.selectionQueryStack.length;r>n;n++){var a=this.selectionQueryStack[n],o=a.attributeName,s=a.operator,c=a.value,l=a.selectMode||"new",h=[],d=function(e,t,i){return e.userData.gisceneAttributes[t]==i},u=function(e,t,i){var n=RegExp(i+"","gi");return n.test(e.userData.gisceneAttributes[t]+"")};switch(s){case"EQUALS_TO":h=GIScene.Utils.getObjectsBy(t,function(e){return d(e,o,c)});break;case"IN":for(var n=0,r=c.length;r>n;n++){var f=GIScene.Utils.getObjectsBy(t,function(e){return d(e,o,c[n])});Array.prototype.push.apply(h,f)}break;case"CONTAINS":h=GIScene.Utils.getObjectsBy(t,function(e){return u(e,o,c)})}switch(l){case"new":t.traverse(function(e){e.userData.isSelected&&this.selectControl.unselect(e,i)}.bind(this));for(var n=0,r=h.length;r>n;n++)this.selectControl.select(h[n],i);break;case"add":var m=this.selectControl.config.toggle;this.selectControl.config.toggle=!1;for(var n=0,r=h.length;r>n;n++)this.selectControl.select(h[n],i);this.selectControl.config.toggle=m}}},setOverrideMaterial:function(e,t,i){var i=i||!0;(t instanceof THREE.Material||!t)&&(this.config.overrideMaterial=t,e.traverse(function(e){if(e.material){if(this.dispatchEvent({type:"beforeSetOverrideMaterial",content:{object:e,overrideMaterial:t,layer:this}}),t){if(e.userData.overriddenMaterial?e.material.isShared===!1&&GIScene.Utils.disposeObject(e,!1,!0,!0):e.userData.overriddenMaterial=e.material,i)var n=GIScene.Utils.WorkingMaterial.getValues(e);delete e.userData.originalMaterial,e.userData.workingMaterialFlags=0,e.material=this.config.overrideMaterial,i&&GIScene.Utils.WorkingMaterial.setValues(e,n)}else e.userData.overriddenMaterial&&e.userData.overriddenMaterial instanceof THREE.Material&&(e.material=e.userData.overriddenMaterial,delete e.userData.overriddenMaterial);this.dispatchEvent({type:"afterSetOverrideMaterial",content:{object:e,overrideMaterial:t,layer:this}})}!this.config.overrideMaterial||this.config.overrideMaterial.shading!=THREE.SmoothShading||!e.geometry||e.geometry.normals&&0!=e.geometry.normals.length||e.geometry.computeVertexNormals()}.bind(this)))},setVisibility:function(e){this.root.traverse(function(t){t.visible=e}),this.visibility=e,this.dispatchEvent({type:"changedvisibility",content:{layer:this,visibility:this.visibility}})},showAttributeTable:function(){},getAttributeNames:function(){var e=[];return this.root.traverse(function(t){return t.userData.gisceneAttributes&&Object.keys(t.userData.gisceneAttributes).length>0?e=Object.keys(t.userData.gisceneAttributes):void 0}),e},getExampleValues:function(){var e=[];return this.root.traverse(function(t){if(t.userData.gisceneAttributes&&Object.keys(t.userData.gisceneAttributes).length>0){e=[];for(attr in t.userData.gisceneAttributes)e.push(t.userData.gisceneAttributes[attr]);return e}}.bind(this)),e},setActiveStyle:function(e){(!e||"string"==typeof e&&"default"==e.toLowerCase())&&(e=this.styles[0]),e.recursive;var t=e.material,i=e.rootObjects?"byObjects":e.rootObjectKeyAttribute?"byAttributes":"selectAll";if("selectAll"==i&&this.setOverrideMaterial(this.root,t),"byObjects"==i)for(var n=e.rootObjects,r=0,a=n.length;a>r;r++)this.setOverrideMaterial(n[r],t);"byAttributes"==i&&console.log("Layer.setActiveStyle(): style objects by attributes not yet implemented"),this.dispatchEvent({type:"setActiveStyle",content:{layer:this,style:e}})},addEventListener:THREE.EventDispatcher.prototype.addEventListener,hasEventListener:THREE.EventDispatcher.prototype.hasEventListener,removeEventListener:THREE.EventDispatcher.prototype.removeEventListener,dispatchEvent:THREE.EventDispatcher.prototype.dispatchEvent},GIScene.Layer.Helper=function(e,t){GIScene.Layer.apply(this,[e,t]),this.isTangible=!1},GIScene.Layer.Helper.prototype=Object.create(GIScene.Layer.prototype),GIScene.Layer.Fixed=function(e,t){GIScene.Layer.apply(this,[e]),this.config=GIScene.Utils.mergeObjects(this.config,t),this.url=null,this.format=null,this.boundingBox=null,this.verticalAxis=null,this.listeners=null;var i=function(e){var t=e.content;"Z"==this.verticalAxis.toUpperCase()&&t.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2)),this.setOverrideMaterial(t,this.config.overrideMaterial),this.root.add(t),this.boundingBox=(new THREE.Box3).setFromObject(this.root),this.selectControl&&(this.selectControl.selectables=GIScene.Utils.getDescendants(this.root)),this.dispatchEvent({type:"load",content:this})}.bind(this);this.init=function(){if(this.name=e,this.config.url&&"format"in this.config){this.url=this.config.url,this.format=this.config.format,this.verticalAxis=this.config.verticalAxis||"Y",this.boundingBox=new THREE.Box3,this.listeners=this.config.listeners;for(var t=0,n=this.listeners.length;n>t;t++)for(type in this.listeners[t])this.addEventListener(type,this.listeners[t][type]);this.loader.addEventListener("load",i),this.loader.load(this.url,this.format)}else console.error("url or format missing in layer config!")},this.init()},GIScene.Layer.Fixed.prototype=Object.create(GIScene.Layer.prototype),GIScene.Grid=function(e){var t={origin:new GIScene.Coordinate2(0,0),tileSizes:[16],sceneOffset:new GIScene.Coordinate3};this.config=GIScene.Utils.mergeObjects(t,e||{}),this.origin=this.config.origin,this.tileSizes=this.config.tileSizes,this.sceneOffset=this.config.sceneOffset,this._sceneOffset=this.sceneOffset.toVector3(),this._origin=this.origin.toVector2().clone().sub(GIScene.Utils.vector3ToVector2(this._sceneOffset))},GIScene.Grid.Index=function(e,t,i){this.x=e,this.y=t,this.tileSize=i},GIScene.Grid.Index.prototype={equals:function(e){return this.x==e.x&&this.y==e.y&&this.tileSize==e.tileSize},toString:function(){return this.x+"_"+this.y+"_"+this.tileSize},fromString:function(e){var t=e.split("_");return this.x=t[0],this.y=t[1],this.tileSize=t[2],this},getChildNW:function(){var e=2*this.x,t=2*this.y+1;return new GIScene.Grid.Index(e,t,.5*this.tileSize)},getChildSW:function(){var e=2*this.x,t=2*this.y;return new GIScene.Grid.Index(e,t,.5*this.tileSize)},getChildNE:function(){var e=2*this.x+1,t=2*this.y+1;return new GIScene.Grid.Index(e,t,.5*this.tileSize)},getChildSE:function(){var e=2*this.x+1,t=2*this.y;return new GIScene.Grid.Index(e,t,.5*this.tileSize)}},GIScene.Grid.GridLine=function(e,t){e.tileSize!=t.tileSize&&alert("GIScene.Grid.GridLine(): start and end tiles have different tileSizes. They must have equal ones!"),this.start=e,this.end=t},GIScene.Grid.IndexStore=function(){this.store=[],this.add=function(e){e=e instanceof Array?e:[e],e.forEach(function(e,t,i){i[t]=""+i[t]}),this.store=this.store.concat(e)},this.remove=function(e){e=e instanceof Array?e:[e],e.forEach(function(e,t,i){i[t]=""+i[t]});var t=this.store.length;return this.store=this.store.filter(function(t){return-1==e.indexOf(t)}),t==this.store.length?!1:!0}},GIScene.Grid.TileStore=function(e){var t={maxLength:1};this.config=GIScene.Utils.mergeObjects(t,e||{}),this.maxLength=this.config.maxLength,this.store={},this.indexStore=new GIScene.Grid.IndexStore,this.length=0;var i=0;this.add=function(e,t){this.maxLength&&this.length>this.maxLength&&this.removeOldestEntry(),e instanceof GIScene.Grid.Index?(this.store[""+e]={object:t,age:i++},this.indexStore.add(e),this.length++):console.log("GIScene.Grid.TileStore: First argument is not of type GIScene.Grid.Index")},this.remove=function(e){return this.store[""+e]?(delete this.store[""+e].object,delete this.store[""+e].age,delete this.store[""+e],this.indexStore.remove(e),this.length--,!0):!1},this.getTile=function(e){var t=""+e;return t in this.store?this.store[t].object:!1},this.removeOldestEntry=function(){var e,t={age:Number.MAX_VALUE};for(tile in this.store)t.age>this.store[tile].age&&(t=this.store[tile],e=tile);console.log("oldestKey: "+e);var i=this.store[e].object;i.material&&i.material.isShared===!1?GIScene.Utils.disposeObject(i,!0,!0,!0,!0):GIScene.Utils.disposeObject(i,!0,!1,!1,!0),delete this.store[e].object,delete this.store[e].age,delete this.store[e],this.length--}},GIScene.Grid.prototype={constructor:GIScene.Grid,getIndexFromPoint2d:function(e,t){return new GIScene.Grid.Index(Math.floor(e.x/t)-Math.floor(this._origin.x/t),-(Math.ceil(e.y/t)-Math.floor(this._origin.y/t)),t)},getGridCoordFromPoint2d:function(e,t){return new THREE.Vector2(e.x/t-this._origin.x/t-.5,-(e.y/t-this._origin.y/t)-.5)},getCentroidFromIndex:function(e){var t=e.x*e.tileSize+this._origin.x+e.tileSize/2,i=-e.y*e.tileSize+this._origin.y-e.tileSize/2;return new THREE.Vector2(t,i)},getBoundingBoxFromIndex:function(e){var t=this.getCentroidFromIndex(e),i=e.tileSize/2,n={left:t.x-i,right:t.x+i,top:t.y-i,bottom:t.y+i};return n},getCornerCoordsFromIndex:function(e){var t=this.getBoundingBoxFromIndex(e),i=[{x:t.left,y:t.bottom},{x:t.right,y:t.bottom},{x:t.right,y:t.top},{x:t.left,y:t.top}];return i},isDescendantOf:function(e,t){if(!e||!t)return!1;var i=this.tileSizes.indexOf(e.tileSize)-this.tileSizes.indexOf(t.tileSize),n=2*i,r=Math.floor(e.x/n),a=Math.floor(e.y/n);return r==t.x&&a==t.y},traverseIf_old:function(e,t,i){t(e)&&(this.tileSizes[0]>=e.tileSize?i(e):(this.traverseIf(e.getChildNW(),t,i),this.traverseIf(e.getChildNE(),t,i),this.traverseIf(e.getChildSW(),t,i),this.traverseIf(e.getChildSE(),t,i)))},traverseIf:function(e,t,i,n){t(e)&&(i(e)?n(e):(this.traverseIf(e.getChildNW(),t,i,n),this.traverseIf(e.getChildNE(),t,i,n),this.traverseIf(e.getChildSW(),t,i,n),this.traverseIf(e.getChildSE(),t,i,n)))},getTilesFromGridLine:function(e){for(var t,i=e.start.tileSize,n=[],r=e.start.x,a=e.start.y,o=e.end.x,s=e.end.y,c=Math.abs(o-r),l=Math.abs(s-a),h=o>r?1:-1,d=s>a?1:-1,u=0,f=0;c+l>f;f++){n.push(new GIScene.Grid.Index(r,a,i));var m=u+l,t=u-c;Math.abs(t)>Math.abs(m)?(r+=h,u=m):(a+=d,u=t)}for(var u=0,f=0;c+l>f;f++){n.push(new GIScene.Grid.Index(r,a,i));var m=u+l,t=u-c;Math.abs(t)>Math.abs(m)?(r+=-h,u=m):(a+=-d,u=t)}return 0==c+l&&n.push(new GIScene.Grid.Index(r,a,i)),n},getTilesFromLineIntersection:function(e,t,i){var n,r,a=[],o=e.toVector2().clone().sub(GIScene.Utils.vector3ToVector2(this._sceneOffset)),s=t.toVector2().clone().sub(GIScene.Utils.vector3ToVector2(this._sceneOffset)),c=this.getGridCoordFromPoint2d(o,i),l=this.getGridCoordFromPoint2d(s,i),h=c.x,d=c.y,u=l.x,f=l.y,m=u-h,p=f-d,v=p/m,g=0==p,E=0==m,y=u>h?1:-1,S=f>d?1:-1,b=v*y,T=1/v*S,R=Math.abs(Math.round(u)-Math.round(h)),w=Math.abs(Math.round(f)-Math.round(d)),M=Math.round(h),I=Math.round(d),L=h-M,A=d-I,x=h-A*(1/v),C=d-L*v,D=Math.round(u),H=Math.round(f);if(1>=Math.abs(v)&&!g){for(var G=0;R>G;G++){n=M+G*y,r=C+G*b;var O=Math.round(n),P=0!=G?Math.round(r):I;a.push(new GIScene.Grid.Index(O,P,i));var k=Math.round(C+(G+1)*b)-P;if(G==R-1&&(k=H-P),0!=k){var F=C+b*(G+.5),j=Math.round(F)==P,B=.5==Math.floor(1e4*(Math.abs(F)%1))/1e4;(j||B)&&a.push(new GIScene.Grid.Index(O+y,P,i)),(!j||B)&&a.push(new GIScene.Grid.Index(O,P+S,i)),Math.abs(k)>1&&a.push(new GIScene.Grid.Index(O+y,P+S,i))}}a.push(new GIScene.Grid.Index(Math.round(u),Math.round(f),i))}if(Math.abs(v)>1&&!E){for(var G=0;w>G;G++){r=I+G*S,n=x+G*T;var P=Math.round(r),O=0!=G?Math.round(n):M;a.push(new GIScene.Grid.Index(O,P,i));var k=Math.round(x+(G+1)*T)-O;if(G==w-1&&(k=D-O),0!=k){var U=x+T*(G+.5),j=Math.round(U)==O,B=.5==Math.floor(1e4*(Math.abs(U)%1))/1e4;(!j||B)&&a.push(new GIScene.Grid.Index(O+y,P,i)),(j||B)&&a.push(new GIScene.Grid.Index(O,P+S,i)),Math.abs(k)>1&&a.push(new GIScene.Grid.Index(O+y,P+S,i))}}a.push(new GIScene.Grid.Index(D,H,i))}if(E)for(var G=0;w>=G;G++)a.push(new GIScene.Grid.Index(M,I+G,i)),.5==Math.floor(1e4*(Math.abs(h)%1))/1e4&&a.push(new GIScene.Grid.Index(M-1,I+G,i));if(g)for(var G=0;R>=G;G++)a.push(new GIScene.Grid.Index(M+G,I,i)),.5==Math.floor(1e4*(Math.abs(d)%1))/1e4&&a.push(new GIScene.Grid.Index(M+G,I-1,i));return a},addEventListener:THREE.EventDispatcher.prototype.addEventListener,hasEventListener:THREE.EventDispatcher.prototype.hasEventListener,removeEventListener:THREE.EventDispatcher.prototype.removeEventListener,dispatchEvent:THREE.EventDispatcher.prototype.dispatchEvent},GIScene.Layer.Grid=function(e,t){GIScene.Layer.apply(this,[e,t]);var i={origin:new GIScene.Coordinate2(0,0),tileSizes:[1024],terrainHeight:71,maxNumTiles:25,maxDistance:1e4,computeTileIndicesHandler:"default",service:null,maxExtent:null,lodDistanceFactor:1,overrideMaterialHandler:null,virtualSelectionAccessor:null};this.config=GIScene.Utils.mergeObjects(i,this.config),this.url=null,this.format=null,this.boundingBox=null,this.verticalAxis=null,this.origin=this.config.origin,this.tileSizes=this.config.tileSizes.sort(function(e,t){return t-e}),this.grid=null,this.terrainHeight=this.config.terrainHeight;var n=null;this.maxNumTiles=this.config.maxNumTiles,this.maxDistance=this.config.maxDistance,this.maxExtent=this.config.maxExtent;var r=null;this.lodDistanceFactor=this.config.lodDistanceFactor,this.distanceReferencePoint=null,this.computeTileIndicesHandler=null,this.overrideMaterialHandler=null,this.virtualSelection=[],this.virtualSelectionAccessor=this.config.virtualSelectionAccessor;var a,o=!1;this.load=[],this.remove=[],this.loading=new GIScene.Grid.TileStore,this.loaded=new GIScene.Grid.TileStore,this.cache=new GIScene.Grid.TileStore({maxLength:200}),this.init=function(){this.name=e,this.url=this.config.url,this.format=this.config.format,this.verticalAxis=this.config.verticalAxis||"Y",this.boundingBox=new THREE.Box3,this.setTerrainHeight(this.terrainHeight),this.setMaxExtent(this.maxExtent),this.setComputeTileIndicesHandler(this.config.computeTileIndicesHandler)};var s=function(){o&&(o=!1,this.update(),o=!0)}.bind(this);this.startUpdate=function(){o=!0,a=window.setInterval(s,500),console.log("Layer.Grid():startUpdate()")},this.stopUpdate=function(){window.clearInterval(a),o=!1},this.setComputeTileIndicesHandler=function(e){this.computeTileIndicesHandler="default"==e?this.getNewTilesFromQuadtree:e};var c=new THREE.MeshBasicMaterial({color:5635925,opacity:.5,wireframe:!1});this.getErrorTile=function(e){var t=new THREE.Mesh(new THREE.CubeGeometry(e.tileSize,4,e.tileSize),c);t.name="errorTile_"+(""+e);var i=this.grid.getCentroidFromIndex(e);return t.position.set(i.x,this.terrainHeight-this.offset.z,i.y),t},this.loadTile=function(e){if(e){var t=this.cache.getTile(e);if(t){var i=null;t.traverse(function(e){i||e.material&&(i=e.material)});var n=!1;i&&i.waitForTexture&&(n=i.unsharedWmsTextureLoaded),!n&&i&&i.waitForTexture||(this.root.add(t),this.cache.remove(e),this.loaded.add(e,t),this.selectControl&&(this.selectControl.selectables=GIScene.Utils.getDescendants(this.root)),this.dispatchEvent({type:"tileadd",content:{tile:t}}),this.oldTiles.push(e))}else{var r=function(t){var i=!1;t instanceof THREE.Object3D||(t=this.getErrorTile(e),i=!0),"Z"!=this.verticalAxis.toUpperCase()||i||t.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2)),this.loading.remove(e),this.cache.add(e,t),i||this.setOverrideMaterial(t,this.config.overrideMaterial),this.dispatchEvent({type:"tileload",content:{tile:t}})}.bind(this),a=function(){var t=this.getErrorTile(e);this.loading.remove(e),this.cache.add(e,t)}.bind(this);if(this.loading.getTile(e)===!1){var o=this.config.service.getGetSceneUrl(e,this.grid),s=new GIScene.ModelLoader;s.load(o,this.format,r,null,a),this.loading.add(e,s)}}}},this.loadTiles=function(e,t,i){if(e)for(var n=0,r=e.length;r>n;n++)this.loadTile(e[n],t,i)},this.removeTile=function(e){if(e){var t=this.loading.getTile(e);if(t)return t.abort(),this.loading.remove(e),void 0;var i=this.loaded.getTile(e);i instanceof THREE.Object3D&&(this.root.remove(i),this.loaded.remove(e),this.cache.add(e,i),this.dispatchEvent({type:"tileremove",content:{tile:i}}))}},this.removeTiles=function(e,t){if(e)for(var i=0,n=e.length;n>i;i++)this.removeTile(e[i],t)},this.getNewTilesFromQuadtree=function(){var e=function(e){var t={n_t_l:new THREE.Vector3(-1,1,-1),n_t_r:new THREE.Vector3(1,1,-1),n_b_r:new THREE.Vector3(1,-1,-1),n_b_l:new THREE.Vector3(-1,-1,-1),f_t_r:new THREE.Vector3(1,1,1),f_t_l:new THREE.Vector3(-1,1,1),f_b_l:new THREE.Vector3(-1,-1,1),f_b_r:new THREE.Vector3(1,-1,1)},i={n_t:{geometry:new THREE.Line3(t.n_t_r,t.n_t_l)},n_r:{geometry:new THREE.Line3(t.n_b_r,t.n_t_r)},n_b:{geometry:new THREE.Line3(t.n_b_l,t.n_b_r)},n_l:{geometry:new THREE.Line3(t.n_t_l,t.n_b_l)},f_t:{geometry:new THREE.Line3(t.f_t_l,t.f_t_r)},f_r:{geometry:new THREE.Line3(t.f_t_r,t.f_b_r)},f_b:{geometry:new THREE.Line3(t.f_b_r,t.f_b_l)},f_l:{geometry:new THREE.Line3(t.f_b_l,t.f_t_l)},t_l:{geometry:new THREE.Line3(t.n_t_l,t.f_t_l)},b_l:{geometry:new THREE.Line3(t.n_b_l,t.f_b_l)},b_r:{geometry:new THREE.Line3(t.n_b_r,t.f_b_r)},t_r:{geometry:new THREE.Line3(t.n_t_r,t.f_t_r)}},n={near:[i.n_l,i.n_t,i.n_r,i.n_b],far:[i.f_r,i.f_b,i.f_l,i.f_t],left:[i.n_l,i.t_l,i.f_l,i.b_l],top:[i.n_t,i.t_r,i.f_t,i.t_l],right:[i.n_r,i.b_r,i.f_r,i.t_r],bottom:[i.n_b,i.b_l,i.f_b,i.b_r]};i.n_t.left=n.near,i.n_t.right=n.top,i.n_r.left=n.near,i.n_r.right=n.right,i.n_b.left=n.near,i.n_b.right=n.bottom,i.n_l.left=n.near,i.n_l.right=n.left,i.f_t.left=n.far,i.f_t.right=n.top,i.f_r.left=n.far,i.f_r.right=n.right,i.f_b.left=n.far,i.f_b.right=n.bottom,i.f_l.left=n.far,i.f_l.right=n.left,i.t_l.left=n.left,i.t_l.right=n.top,i.b_l.left=n.bottom,i.b_l.right=n.left,i.b_r.left=n.right,i.b_r.right=n.bottom,i.t_r.left=n.top,i.t_r.right=n.right;for(point in t)t[point].unproject(this.scene.camera);var r,a,o=(new THREE.Plane).setFromNormalAndCoplanarPoint(new THREE.Vector3(0,1,0),new THREE.Vector3(0,e,0)),s=[],c=function(){for(cell in n)for(var e=0;4>e;e++){var t=o.intersectLine(n[cell][e].geometry);if(t)return s.push(t),r=n[cell],a=n[cell][e],void 0}},l=function(e,t){for(var i=0;4>i;i++)if(e[i]!==t){var n=o.intersectLine(e[i].geometry);if(n&&(s.push(n),!s[0].equals(s[s.length-1]))){var r=e[i].left===e?e[i].right:e[i].left;l(r,e[i])}}};c(),r&&l(r,a);for(var h=0,d=s.length;d>h;h++)s[h]=GIScene.Utils.vector3ToVector2(s[h]);return s}.bind(this),t=function(e,t){if(4>e.length)return e;var i=function(){var t=(new GIScene.Line2).fromPoints(e[0],e[1]).directionVector,i=(new GIScene.Line2).fromPoints(e[1],e[2]).directionVector,n=new THREE.Vector3(t.x,t.y,0),r=new THREE.Vector3(i.x,i.y,0),a=THREE.Vector3.prototype.crossVectors(n,r);return 0>a.z?!0:!1};i(e)||e.reverse();var n=[];n.push((new GIScene.Line2).fromPoints(e[e.length-2],e[e.length-1]).moveRight(t).intersect((new GIScene.Line2).fromPoints(e[0],e[1]).moveRight(t)));for(var r=0;e.length-2>r;r++)n.push((new GIScene.Line2).fromPoints(e[r],e[r+1]).moveRight(t).intersect((new GIScene.Line2).fromPoints(e[r+1],e[r+2]).moveRight(t)));return n.push(new THREE.Vector2(n[0].x,n[0].y)),n},i=function(e,t){var i=function(e){var t=function(){for(var t=0,i=0;e.length>i;i++)I=(i+1)%e.length,t+=e[i][0]*e[I][1],t-=e[I][0]*e[i][1];return t/2},i=t()>0;return!i},n=function(e,t){for(var i,n,r,a=24,o=Math.PI*(1/a-.5),s=[],c=0;a>c;++c)i=o+2*c*Math.PI/a,n=e.x+t*Math.cos(i),r=e.y+t*Math.sin(i),s.push([n,r]);return s},a=function(e,t){var i,n,r,a,o=function(e){return(n[0]-i[0])*(e[1]-i[1])>(n[1]-i[1])*(e[0]-i[0])},s=function(){var e=[i[0]-n[0],i[1]-n[1]],t=[r[0]-a[0],r[1]-a[1]],o=i[0]*n[1]-i[1]*n[0],s=r[0]*a[1]-r[1]*a[0],c=1/(e[0]*t[1]-e[1]*t[0]);return[(o*t[0]-s*e[0])*c,(o*t[1]-s*e[1])*c]},c=e;i=t[t.length-1];for(var l=0,h=t.length;h>l;l++){n=t[l];var d=c;c=[],r=d[d.length-1];for(var u=0,f=d.length;f>u;u++){var a=d[u];o(a)?(o(r)||c.push(s()),c.push(a)):o(r)&&c.push(s()),r=a}i=n}return c}.bind(this),o=r?r.toPolygonV2():null;o&&(o.forEach(function(e,t,i){i[t]=e.toVector2().toArray()}),o.reverse());var s=n(this.distanceReferencePoint,t);e.pop(),e.forEach(function(e,t,i){i[t]=e.toArray()}),i(e)&&e.reverse();var c=a(s,e);return o&&(clippedWithExtent=a(o,c),c=clippedWithExtent),c.length>0&&(c.push(c[0]),c.forEach(function(e,t,i){i[t]=(new THREE.Vector2).fromArray(e)})),c}.bind(this),a=function(e,t){for(var i=[],n=[],r=0,a=e.length-1;a>r;r++){var o=new GIScene.Grid.GridLine(this.grid.getIndexFromPoint2d(e[r],t),this.grid.getIndexFromPoint2d(e[r+1],t));n.push(o)}for(var r=0,a=n.length;a>r;r++)i=i.concat(this.grid.getTilesFromGridLine(n[r]));return GIScene.Utils.removeDuplicatesFromArray(i)}.bind(this),o=(function(e){ySortedOutlineTiles={};for(var t=0,i=e.length;i>t;t++)""+e[t].y in ySortedOutlineTiles?ySortedOutlineTiles[""+e[t].y].push(e[t].x):ySortedOutlineTiles[""+e[t].y]=[e[t].x];var n=[];for(scanline in ySortedOutlineTiles){var r=ySortedOutlineTiles[scanline].sort(function(e,t){return e-t});if(r.length>1){for(var a=parseInt(scanline),o=0,s=0,t=1,i=r.length;i>t;t++)1!=r[t]-r[t-1]&&(o=r[t]-r[t-1]-1,s=t-1);for(var t=0,i=o;i>t;t++)n.push(new GIScene.Grid.Index(r[s]+t+1,a,this.grid.tileSize))}}return n}.bind(this),function(e,t){for(var i=!1,n=-1,r=e.length,a=r-1;r>++n;a=n)(t.y>=e[n].y&&e[a].y>t.y||t.y>=e[a].y&&e[n].y>t.y)&&(e[a].x-e[n].x)*(t.y-e[n].y)/(e[a].y-e[n].y)+e[n].x>t.x&&(i=!i);return i}),s=function(e,t){function i(e,t,i,n,r,a,o,s){if(e==i&&t==n||r==o&&a==s)return!1;var c=i-e,l=n-t,h=r-o,d=a-s,u=e-r,f=t-a,m=d*u-h*f,p=l*h-c*d;if(p>0){if(0>m||m>p)return!1}else if(0>p&&(m>0||p>m))return!1;var v=c*f-l*u;if(p>0){if(0>v||v>p)return!1}else if(0>p&&(v>0||p>v))return!1;if(0==p){var g=a-t,E=e*(n-a)+i*g+r*(t-n);return 0==E&&(e>=r&&o>=e||r>=e&&e>=o||i>=r&&o>=i||r>=i&&i>=o||r>=e&&i>=r||e>=r&&r>=i)&&(t>=a&&s>=t||a>=t&&t>=s||n>=a&&s>=n||a>=n&&n>=s||a>=t&&n>=a||t>=a&&a>=n)?!0:!1}return!0}for(var n=this.grid.getCornerCoordsFromIndex(e),r=0,a=t.length-1;a>r;r++){var o=i(n[0].x,n[0].y,n[1].x,n[1].y,t[r].x,t[r].y,t[r+1].x,t[r+1].y)||i(n[1].x,n[1].y,n[2].x,n[2].y,t[r].x,t[r].y,t[r+1].x,t[r+1].y)||i(n[2].x,n[2].y,n[3].x,n[3].y,t[r].x,t[r].y,t[r+1].x,t[r+1].y)||i(n[3].x,n[3].y,n[0].x,n[0].y,t[r].x,t[r].y,t[r+1].x,t[r+1].y);if(o)return!0}return!1}.bind(this),c=new THREE.Vector3;(function(e,t){var i=this.scene.camera.position.clone(),n=this.grid.getCentroidFromIndex(e);c.set(n.x,this.terrainHeight,n.y);var r=i.distanceTo(c),a=this.grid.getCentroidFromIndex(t);c.set(a.x,this.terrainHeight,a.y);var o=i.distanceTo(c);return r-o}).bind(this);var l=function(e){var t=0;if(e.length>2){for(var i=0,n=0,r=e.length;r-1>n;n++){var a=e[n],o=e[n+1];i+=(a.x+o.x)*(o.y-a.y)}t=-i/2}return Math.abs(t)},h=function(){var e=new THREE.Vector3(0,-1,1),t=new THREE.Vector3(0,-1,-1),i=new THREE.Vector3(0,1,1),r=new THREE.Vector3(0,1,-1);e.unproject(this.scene.camera),t.unproject(this.scene.camera),i.unproject(this.scene.camera),r.unproject(this.scene.camera);var a=new THREE.Line3(e,t),o=new THREE.Line3(i,r),s=(new THREE.Plane).setFromNormalAndCoplanarPoint(new THREE.Vector3(0,1,0),new THREE.Vector3(0,n,0)),c=s.intersectLine(a),l=s.intersectLine(o),h=c?c:l,d=h?new THREE.Vector2(h.x,h.z):null;return d}.bind(this),d=e(n);d=t(d,this.tileSizes[this.tileSizes.length-1]);var u=this.distanceReferencePoint;if(this.distanceReferencePoint=h()||u,!this.distanceReferencePoint)return[];d=i(d,this.maxDistance);var f,m=Math.min.apply(null,this.tileSizes),p=Math.max.apply(null,this.tileSizes),v=l(d),g=v/Math.pow(p,2),E=Math.pow(2,Math.round(Math.log(Math.sqrt(v)/m)/Math.LN2)),y=m*E;if(g>1e4){var S=confirm("estNumberOfAllTiles: "+Math.round(g)+". Stop calculating?");if(S)return[]}var b;b=E>1?a(d,y):a(d,m);for(var T=function(e){var t=this.grid.getCentroidFromIndex(e),i=this.grid.getCornerCoordsFromIndex(e),n=o(d,i[0])||o(d,i[1])||o(d,i[2])||o(d,i[3])||o(d,t)||s(e,d);return n}.bind(this),R=function(e){var t=!1;if(this.tileSizes[0]>=e.tileSize&&e.tileSize>this.tileSizes[this.tileSizes.length-1]){var i=this.grid.getCentroidFromIndex(e),r=new THREE.Vector3(i.x,n,i.y);this.scene.camera.position.distanceTo(r)>e.tileSize*this.lodDistanceFactor&&(t=!0)}else e.tileSize==this.tileSizes[this.tileSizes.length-1]&&(t=!0);return t}.bind(this),w=function(e){f.push(e)}.bind(this),f=[],M=0,I=b.length;I>M;M++)this.grid.traverseIf(b[M],T,R,w);return f},this.oldTiles=[],this.update=function(){var e;e=this.computeTileIndicesHandler(),this.remove=this.oldTiles.filter(function(t){return!e.some(function(e){return e.equals(t)})}),this.load=e.filter(function(e){return!this.oldTiles.some(function(t){return t.equals(e)})}.bind(this)),this.oldTiles=e.filter(function(e){return!this.load.some(function(t){return t.equals(e)})}.bind(this));var t={};this.load.forEach(function(e){this.remove.forEach(function(t,i,n){this.grid.isDescendantOf(e,t)&&(this.oldTiles.push(n[i]),n[i]=null)}.bind(this))}.bind(this));var i={};this.load.forEach(function(e){this.remove.forEach(function(t,i,n){this.grid.isDescendantOf(t,e)&&(this.oldTiles.push(n[i]),n[i]=null)}.bind(this))}.bind(this)),this.loadTiles(this.load,i,t),this.removeTiles(this.remove,i),this.abort=this.loading.indexStore.store.filter(function(e){return!this.load.some(function(t){return t.equals((new GIScene.Grid.Index).fromString(e))})}.bind(this)),this.removeTiles(this.abort,i)},this.setTerrainHeight=function(e){this.terrainHeight=e,n=this.scene?this.terrainHeight-this.scene.config.offset.z:this.terrainHeight},this.setMaxExtent=function(e){if(e)if(this.scene){var t=new GIScene.Coordinate2(this.scene.config.offset.x,this.scene.config.offset.y),i=e.min.clone().sub(t),n=e.max.clone().sub(t);r=new GIScene.Extent2(new GIScene.Coordinate2(i.x,i.y),new GIScene.Coordinate2(n.x,n.y))}else r=this.maxExtent},this.setVisibility=function(e){e?this.startUpdate():this.stopUpdate(),GIScene.Layer.Grid.prototype.setVisibility.call(this,e)},this.init();var l=function(e){console.log("Grid.onSetScene "+this.name);var t=e.content;this.grid=t?new GIScene.Grid({origin:this.origin,tileSizes:this.tileSizes,sceneOffset:t.config.offset}):null,this.setTerrainHeight(this.terrainHeight),this.setMaxExtent(this.maxExtent),t?this.startUpdate():this.stopUpdate()}.bind(this);if(this.addEventListener("setScene",l),this.config.overrideMaterialHandler&&this.setOverrideMaterialHandler(this.config.overrideMaterialHandler),this.attributeReader){var h=function(e){var t=e?e.content.tile:this.root;t.traverse(function(e){"gisceneAttributes"in e.userData||(e.userData.gisceneAttributes={});for(attr in this.attributeReader)e.userData.gisceneAttributes[attr]=this.attributeReader[attr](e)}.bind(this))}.bind(this);h(),this.addEventListener("tileload",h)}var d=function(e){this.selectionQueryStack&&this.selectByAttributes(this.selectionQueryStack,e.content.tile)}.bind(this),u=function(e){var t=e.content.tile;t.traverse(function(e){e.userData.isSelected&&this.selectControl.unselect(e)}.bind(this))}.bind(this);this.selectionQueryStack&&this.selectByAttributes(this.selectionQueryStack),this.addEventListener("tileadd",d),this.addEventListener("tileremove",u)},GIScene.Layer.Grid.prototype=Object.create(GIScene.Layer.prototype),GIScene.Layer.Grid.prototype.setOverrideMaterial=function(e,t){GIScene.Layer.prototype.setOverrideMaterial.apply(this,[e,t]);var i=this.cache.store;for(tile in i){var n=i[tile].object;GIScene.Layer.prototype.setOverrideMaterial.apply(this,[n,t])}},GIScene.Layer.Grid.prototype.setOverrideMaterialHandler=function(e){e?(this.overrideMaterialHandler&&this.removeEventListener("afterSetOverrideMaterial",this.overrideMaterialHandler),this.overrideMaterialHandler=e,this.addEventListener("afterSetOverrideMaterial",this.overrideMaterialHandler)):this.overrideMaterialHandler&&this.removeEventListener("afterSetOverrideMaterial",this.overrideMaterialHandler)
},GIScene.Layer.Grid.prototype.setActiveStyle=function(e){(!e||"string"==typeof e&&"default"==e.toLowerCase())&&(e=this.styles[0]),e.recursive;var t=e.material;e.rootObjects?"byObjects":e.rootObjectKeyAttribute?"byAttributes":"selectAll";var i=t instanceof GIScene.WMSOverlayMaterial;console.log("isWMSOverlayMaterial",i),i?this.setOverrideMaterialHandler(GIScene.OverrideMaterialHandler.WMS):this.setOverrideMaterialHandler(null),GIScene.Layer.prototype.setActiveStyle.apply(this,[e])},GIScene.Layer.W3DS_0_4_0=function(e,t){GIScene.Layer.Grid.apply(this,[e,t]);var i={layer:null,crs:null,tileSizes:[1024,512,256,128]};this.config=GIScene.Utils.mergeObjects(i,this.config);var n={url:this.url,withCredentials:this.config.withCredentials,tileSizes:this.config.tileSizes},r={crs:this.config.crs,layer:this.config.layer,offset:null};this.config.service=new GIScene.Service.W3DS_0_4_0(n,r);var a=function(e){console.log("w3ds onSetScene");var t=e.content;this.config.service.params.offset=t?this.grid.sceneOffset.toArray().join(","):null}.bind(this);this.addEventListener("setScene",a)},GIScene.Layer.W3DS_0_4_0.prototype=Object.create(GIScene.Layer.Grid.prototype),GIScene.Layer.W3DS_0_4_1=function(e,t){GIScene.Layer.Grid.apply(this,[e,t]);var i={layer:null,crs:null,tileSizes:[1024,512,256,128],lods:null};this.config=GIScene.Utils.mergeObjects(i,this.config);var n={url:this.url,withCredentials:this.config.withCredentials,tileSizes:this.config.tileSizes},r={crs:this.config.crs,layer:this.config.layer,offset:null,lods:this.config.lods};this.config.service=new GIScene.Service.W3DS_0_4_1(n,r);var a=function(e){console.log("w3ds onSetScene "+this.name);var t=e.content;this.config.service.params.offset=t?this.grid.sceneOffset.toArray().join(","):null}.bind(this);this.addEventListener("setScene",a)},GIScene.Layer.W3DS_0_4_1.prototype=Object.create(GIScene.Layer.Grid.prototype),GIScene.Scene=function(e,t){var i={width:null,height:null,animate:!0,fog:null,center:new THREE.Vector3(0,0,0),projection:"EPSG:32616",units:"m",offset:new GIScene.Coordinate3(0,0,0),skyColor:(new THREE.Color).setStyle("lightskyblue").getHex(),cameratype:"perspective",near:.1,far:1e3,fov:45,positionFromCenter:new THREE.Vector3(0,0,10)};this.config=GIScene.Utils.mergeObjects(i,t||{}),this.containerDiv=document.getElementById(e),this.canvas=null;var n=null;n=this.config.width?this.config.width:this.containerDiv.clientWidth;var r=null;r=this.config.height?this.config.height:this.containerDiv.clientHeight>0?this.containerDiv.clientHeight:500;var a;this.root=null,this.camera=null,this.spriteRoot=null,this.spriteCamera=null,this.lights=[],this.renderer=null,this.effectComposer=null,this.fog=null,this.layers=[],this.center=new THREE.Vector3(0,0,0),this.controls=[],this.clock=new THREE.Clock,this.delta=null,this.init=function(){this.initCanvas(),this.initScene(),this.config.animate?this.startAnimation():this.renderer.render(this.root,this.camera)},this.initCanvas=function(){this.canvas=document.createElement("canvas"),this.canvas.className="giscene_canvas",this.containerDiv.style.lineHeight=0,this.containerDiv.appendChild(this.canvas)},this.initScene=function(){this.root=new THREE.Scene,this.root.name="root",this.config.fog&&(this.root.fog=this.fog=this.config.fog.clone()),this.camera=new THREE.CombinedCamera(n,r,this.config.fov,this.config.near,this.config.far,this.config.near,this.config.far),this.camera.name="THREE.CombinedCamera",this.camera.target=new THREE.Object3D,this.camera.target.name="Camera target",this.camera.add(this.camera.target),"ortho"==this.config.cameratype&&this.camera.toOrthographic();var e=new THREE.Vector3(0,0,0),t=new THREE.Vector3(0,0,0),i=function(){e.equals(this.camera.position)&&t.equals(this.camera.rotation)||(this.dispatchEvent({type:"cameraChange"}),e=this.camera.position.clone(),t=this.camera.rotation.clone())}.bind(this);this.addEventListener("afterRender",i),this.spriteRoot=new THREE.Scene;var a=n/2,o=r/2;this.spriteCamera=new THREE.OrthographicCamera(-a,a,o,-o,-100,100),this.directionalLight=new THREE.DirectionalLight(16777215,.5),this.directionalLight.name="THREE.DirectionalLight",this.ambientLight=new THREE.AmbientLight(8421504),this.ambientLight.name="THREE.AmbientLight",this.headLight=new THREE.SpotLight(16777215,.3,0,Math.PI/2,20),this.camera.add(this.headLight),this.headLight.target.position.setZ(-1e3),this.camera.target.add(this.headLight.target),this.renderer=new THREE.WebGLRenderer({antialias:!0,precision:"highp",canvas:this.canvas,devicePixelRatio:1}),this.renderer.setSize(n,r),this.renderer.setClearColor(this.config.skyColor),this.renderer.autoClear=!1,this.effectComposer=new THREE.EffectComposer(this.renderer),this.effectComposer.setSize(n,r),this.root.add(this.camera),this.root.add(this.ambientLight),this.root.add(this.directionalLight),this.setCenter(this.config.center,this.config.positionFromCenter);var s=new THREE.Texture(null),c=new Image;c.onload=function(){s.image=c,s.needsUpdate=!0},c.src=" data:image/png;base64,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";var l=new THREE.SpriteMaterial({map:s,opacity:1}),h=new THREE.Sprite(l);h.scale.set(158,20,1),h.position.set(this.canvas.width/2-79,-this.canvas.height/2+10,0),this.spriteRoot.add(h),this.logoOnResize=function(){h.position.set(this.canvas.width/2-79,-this.canvas.height/2+10,0)}.bind(this)},this.startAnimation=function(){a=requestAnimationFrame(this.startAnimation.bind(this)),this.delta=this.clock.getDelta(),TWEEN.update(),this.renderer.clear(!0,!0,!0),this.dispatchEvent({type:"beforeRender"}),this.dispatchEvent({type:"beforeRender2"}),this.effectComposer.passes.length>0?this.effectComposer.render():this.renderer.render(this.root,this.camera),this.renderer.clear(!1,!0,!1),this.renderer.render(this.spriteRoot,this.spriteCamera),this.dispatchEvent({type:"afterRender"})},this.stopAnimation=function(){cancelAnimationFrame(a)},this.setCenter_old=function(e,t){var i=e.clone().sub(this.center);this.center=e.clone(),t?(this.camera.position.copy(e.clone().add(t)),this.camera.lookAt(this.center),this.camera.target.position.setZ(-t.length())):this.camera.position.add(i),this.dispatchEvent({type:"center",content:{center:e.clone(),translation:i,positionFromCenter:t}})};var o=!1,s=null;this.setCenter=function(e,t,i){if(o&&s&&(s.stop(),o=!1),!o){o=!0;var i=null==i?1e3:i,n=this.center,r=e.clone(),t=t||this.camera.position.clone().sub(n),a=this.camera.position.clone(),c=e.clone().add(t),l=new THREE.Vector3,h=3,d={tx:n.x,ty:n.y,tz:n.z,cx:a.x,cy:a.y,cz:a.z},u={tx:r.x,ty:r.y,tz:r.z,cx:c.x,cy:c.y,cz:c.z};this.center=e.clone(),0==i?(this.camera.position.set(parseFloat(u.cx.toFixed(h)),parseFloat(u.cy.toFixed(h)),parseFloat(u.cz.toFixed(h))),this.camera.lookAt(l.set(parseFloat(u.tx.toFixed(h)),parseFloat(u.ty.toFixed(h)),parseFloat(u.tz.toFixed(h)))),this.camera.target.position.setZ(-t.length()),this.dispatchEvent({type:"center",content:{center:e.clone(),translation:n.clone().sub(r),positionFromCenter:t}}),o=!1):s=new TWEEN.Tween(d).to(u,i).easing(TWEEN.Easing.Quartic.Out).onUpdate(function(){this.camera.position.set(parseFloat(d.cx.toFixed(h)),parseFloat(d.cy.toFixed(h)),parseFloat(d.cz.toFixed(h))),this.camera.lookAt(l.set(parseFloat(d.tx.toFixed(h)),parseFloat(d.ty.toFixed(h)),parseFloat(d.tz.toFixed(h))))}.bind(this)).onComplete(function(){this.camera.target.position.setZ(-t.length()),this.dispatchEvent({type:"center",content:{center:e.clone(),translation:n.clone().sub(r),positionFromCenter:t}}),o=!1}.bind(this)).start()}},this.viewFrom=function(e){var t=this.camera.position.clone().sub(this.center).length(),i=new THREE.Vector3(0,0,1);switch(e){case"left":i=new THREE.Vector3(-1,0,0);break;case"right":i=new THREE.Vector3(1,0,0);break;case"front":i=new THREE.Vector3(0,0,1);break;case"back":i=new THREE.Vector3(0,0,-1);break;case"top":i=new THREE.Vector3(0,1,.01);break;case"bottom":i=new THREE.Vector3(0,-1,.01);break;default:console.error('Value "'+e+'" not supported!')}this.setCenter(this.center,i.clone().multiplyScalar(t))},this.addControl=function(e){this.controls.push(e),e.setScene(this)},this.removeControl=function(e){e.deactivate();for(var t=0;this.controls.length>t;)e===this.controls[t]&&this.controls.splice(t,1),t++;e.setScene(null)},this.addLayer=function(e){this.layers.push(e),e.setScene(this),this.root.add(e.root),this.dispatchEvent({type:"addlayer",content:e})},this.removeLayer=function(e){this.dispatchEvent({type:"beforeremovelayer",content:e}),this.root.remove(e.root);for(var t=0;this.layers.length>t;)e===this.layers[t]&&this.layers.splice(t,1),t++;e.setScene(null),this.dispatchEvent({type:"removelayer",content:e})},this.disposeLayer=function(e){this.removeLayer(e);var t=GIScene.Utils.getDescendants(e.root);t.push(e.root);var i=[],n=[];t.forEach(function(e){this.dispatchEvent({type:"beforeDisposeObject",content:e}),e.geometry&&(e.geometry.dispose(),delete e.geometry),e.material&&(e.material instanceof THREE.MeshFaceMaterial?e.material.materials.forEach(function(e){GIScene.Utils.arrayContains(i,e)||i.push(e)}):GIScene.Utils.arrayContains(i,e.material)||i.push(e.material)),delete e.material,e.dispose&&e.dispose(),e=null}.bind(this)),e.styles.forEach(function(e){e.material&&(e.material instanceof THREE.MeshFaceMaterial?e.material.materials.forEach(function(e){GIScene.Utils.arrayContains(i,e)||i.push(e)}):GIScene.Utils.arrayContains(i,e.material)||i.push(e.material))}),i.forEach(function(e){for(var t=["map","lightMap","bumpMap","normalMap","specularMap","envMap","texture"],i=0,r=t.length;r>i;i++)e[t[i]]&&null!=e[t[i]]&&!GIScene.Utils.arrayContains(n,e[t[i]])&&n.push(e[t[i]])}),n.forEach(function(e){e.dispose()}),n=null,i.forEach(function(e){e.dispose()}),i=null,t=null;for(type in e._listeners)delete e._listeners[type];for(type in e.loader._listeners)delete e.loader._listeners[type];e=null},this.setWireframe=function(e){this.root.traverse(function(t){GIScene.Utils.WorkingMaterial.setWireframe(t,e)})},this.setTexturing=function(e){this.root.traverse(function(t){GIScene.Utils.WorkingMaterial.setTexturing(t,e)})},this.setFaceCulling=function(e){this.root.traverse(function(t){GIScene.Utils.WorkingMaterial.setFaceCulling(t,e)})},this.setVertexColors=function(e){this.root.traverse(function(t){GIScene.Utils.WorkingMaterial.setVertexColors(t,e)})},this.setShading=function(e){this.root.traverse(function(t){GIScene.Utils.WorkingMaterial.setShading(t,e)})},this.getLayerDescendants=function(e){var t=[],i=this.layers;"function"==typeof e&&(i=i.filter(e));for(var n=0,r=i.length;r>n;n++)GIScene.Utils.getDescendants(i[n].root,t);return t},this.getLayerById=function(e){for(var t=null,i=0,n=this.layers.length;n>i;i++)if(""+this.layers[i].id==""+e)return this.layers[i];return t};var c=!1;this.toggleDebugView=function(){if(c)c=!1,this.camera.target.remove(this.camera.target.children[1]);else{c=!0;var e=new THREE.SphereGeometry(.1,8,8),t=new THREE.Mesh(e);this.camera.target.add(t);var i=new THREE.SphereGeometry(.2,10,10),n=new THREE.Mesh(i);cameraLightControl.pivotLight.add(n)}},this.init(),this.onResize=function(){var e=this.containerDiv.clientWidth,t=this.containerDiv.clientHeight;this.renderer.setSize(e,t),this.effectComposer.setSize(e,t),this.camera.setSize(e,t),this.camera.updateProjectionMatrix(),this.spriteCamera.left=-e/2,this.spriteCamera.right=e/2,this.spriteCamera.top=t/2,this.spriteCamera.bottom=-t/2,this.spriteCamera.updateProjectionMatrix(),this.logoOnResize()}.bind(this),window.addEventListener("resize",this.onResize,!1),this.onUnload=function(){this.stopAnimation();for(var e=0,t=this.controls.length;t>e;e++)this.controls[e].isActive&&this.controls[e].deactivate();for(var e=0,t=this.layers.length;t>e;e++)this.disposeLayer(this.layers[e]);this.containerDiv.innerHTML="";for(props in this)delete this[props]}.bind(this),window.addEventListener("unload",this.onUnload,!1)},GIScene.Scene.prototype={constructor:GIScene.Scene,getObjectsBy:function(e){return GIScene.Utils.getObjectsBy(this.root,e)},addEventListener:THREE.EventDispatcher.prototype.addEventListener,hasEventListener:THREE.EventDispatcher.prototype.hasEventListener,removeEventListener:THREE.EventDispatcher.prototype.removeEventListener,dispatchEvent:THREE.EventDispatcher.prototype.dispatchEvent};